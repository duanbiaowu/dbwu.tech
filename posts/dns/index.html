<!doctype html>

<html lang="en">

<head>
  <title>DNS 原理 - 蛮荆</title>
  <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="description" content="" />
<meta name="author" content="" />
<link rel="shortcut icon" href="https://dbwu.tech/favicon.ico" type="image/x-icon" /><meta property="og:title" content="DNS 原理" />
<meta property="og:description" content="" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://dbwu.tech/posts/dns/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-02-18T00:00:00+00:00" />
<meta property="article:modified_time" content="2023-02-18T00:00:00+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="DNS 原理"/>
<meta name="twitter:description" content=""/>

<meta name="generator" content="Hugo 0.113.0">
    
    <script src="https://dbwu.tech/js/mathjax-config.js" defer></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-CZMGTTFLNY"></script>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3261056100776781" crossorigin="anonymous"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-CZMGTTFLNY');
  </script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js" integrity="sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js" integrity="sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa" crossorigin="anonymous"
        onload="renderMathInElement(document.body);"></script>


  <link rel="stylesheet" href="https://dbwu.tech/fontawesome/css/normalize.min.css" />
  <link rel="stylesheet" href="https://dbwu.tech/fontawesome/css/all.min.css" />
  
    
    <link href="//fonts.googleapis.com/css?family=Staatliches" rel="stylesheet">
  
  
  <link rel="stylesheet" type="text/css" href="https://dbwu.tech/css/styles-light.css" />
  </head>

<body>
  <div id="container">
    <header>
      
      <h1>
        <a href="https://dbwu.tech/">蛮荆</a>
      </h1>

      <ul id="social-media">
      </ul>
      
    </header>

    
<nav>
    <ul>
        
        <li>
            <a class="active" href="https://dbwu.tech/posts/">
                <i class="fa-li fa  fa-lg"></i><span>归档</span>
            </a>
        </li>
        
        <li>
            <a class="" href="https://dbwu.tech/tags/">
                <i class="fa-li fa  fa-lg"></i><span>标签</span>
            </a>
        </li>
        
        <li>
            <a class="" href="https://github.com/duanbiaowu">
                <i class="fa-li fa  fa-lg"></i><span>Github</span>
            </a>
        </li>
        
        <li>
            <a class="" href="https://dbwu.tech/index.xml">
                <i class="fa-li fa  fa-lg"></i><span>RSS</span>
            </a>
        </li>
        
    </ul>
</nav>


    <main>




<article>

    <h1>DNS 原理</h1>

    
      
<li>
    
    
    <a href="https://dbwu.tech/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C">计算机网络</a>
    
</li>

    

    
      

    

    <h2 id="概述">概述</h2>
<p><code>DNS</code> 是互联网核心协议之一。不管是上网浏览，还是编程开发，都需要了解一点它的知识。</p>
<p>本文详细介绍 <code>DNS</code> 的原理，以及如何运用工具软件观察它的运作。我的目标是，读完此文后，你就能完全理解 <code>DNS</code>。</p>
<h2 id="一dns-是什么">一、DNS 是什么？</h2>
<p><code>DNS</code>（Domain Name System 的缩写）的作用非常简单，就是根据域名查出IP地址。你可以把它想象成一本巨大的电话本。</p>
<p>举例来说，如果你要访问域名 math.stackexchange.com，首先要通过 <code>DNS</code> 查出它的IP地址是 151.101.129.69。</p>
<p>如果你不清楚为什么一定要查出IP地址，才能进行网络通信，建议先阅读我写的 <a href="https://www.ruanyifeng.com/blog/2012/05/internet_protocol_suite_part_i.html">《互联网协议入门》</a>。</p>
<h2 id="二查询过程">二、查询过程</h2>
<p>虽然只需要返回一个IP地址，但是 <code>DNS</code> 的查询过程非常复杂，分成多个步骤。</p>
<p>工具软件 <code>dig</code> 可以显示整个查询过程。</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ dig math.stackexchange.com
</span></span></code></pre></div><p>上面的命令会输出 6 段信息。</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#999;font-style:italic"># 第 1 段是查询参数和统计</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>; &lt;&lt;&gt;&gt; DiG 9.10.6 &lt;&lt;&gt;&gt; math.stackexchange.com
</span></span><span style="display:flex;"><span>;; global options: +cmd
</span></span><span style="display:flex;"><span>;; Got answer:
</span></span><span style="display:flex;"><span>;; -&gt;&gt;HEADER<span style="color:#ed9d13">&lt;&lt;- opco</span>de: QUERY, status: NOERROR, id: <span style="color:#3677a9">44088</span>
</span></span><span style="display:flex;"><span>;; flags: qr rd ra; QUERY: 1, ANSWER: 4, AUTHORITY: 4, ADDITIONAL: <span style="color:#3677a9">6</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"># 第 2 段是查询内容</span>
</span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"># 结果表示，查询域名 math.stackexchange.com 的 A 记录，A 是 address 的缩写</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>;; OPT PSEUDOSECTION:
</span></span><span style="display:flex;"><span>; EDNS: version: 0, flags:; udp: <span style="color:#3677a9">512</span>
</span></span><span style="display:flex;"><span>;; QUESTION SECTION:
</span></span><span style="display:flex;"><span>;math.stackexchange.com.		IN	A
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"># 第 3 段是 DNS 服务器的答复</span>
</span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"># 结果显示，math.stackexchange.com 有四个 A 记录，即四个 IP 地址。</span>
</span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"># 54 是 TTL 值（Time to live 的缩写），表示缓存时间，即 54 秒之内不用重新查询。</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>;; ANSWER SECTION:
</span></span><span style="display:flex;"><span>math.stackexchange.com.	54	IN	A	151.101.65.69
</span></span><span style="display:flex;"><span>math.stackexchange.com.	54	IN	A	151.101.193.69
</span></span><span style="display:flex;"><span>math.stackexchange.com.	54	IN	A	151.101.129.69
</span></span><span style="display:flex;"><span>math.stackexchange.com.	54	IN	A	151.101.1.69
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"># 第 4 段显示 stackexchange.com 的 NS 记录（Name Server 的缩写）</span>
</span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"># 即哪些服务器负责管理 stackexchange.com 的 DNS 记录。</span>
</span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"># 结果显示 stackexchange.com 共有四条 NS 记录，即四个域名服务器，向其中任一台查询就能知道 math.stackexchange.com 的 IP 地址是什么</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>;; AUTHORITY SECTION:
</span></span><span style="display:flex;"><span>stackexchange.com.	1866	IN	NS	ns-925.awsdns-51.net.
</span></span><span style="display:flex;"><span>stackexchange.com.	1866	IN	NS	ns-1832.awsdns-37.co.uk.
</span></span><span style="display:flex;"><span>stackexchange.com.	1866	IN	NS	ns-cloud-d1.googledomains.com.
</span></span><span style="display:flex;"><span>stackexchange.com.	1866	IN	NS	ns-cloud-d2.googledomains.com.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"># 第 5 段是上面四个域名服务器的 IP 地址，这是随着前一段一起返回的</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>;; ADDITIONAL SECTION:
</span></span><span style="display:flex;"><span>ns-925.awsdns-51.net.	1626	IN	A	205.251.195.157
</span></span><span style="display:flex;"><span>ns-1832.awsdns-37.co.uk. 1592	IN	A	205.251.199.40
</span></span><span style="display:flex;"><span>ns-925.awsdns-51.net.	1626	IN	AAAA	2600:9000:5303:9d00::1
</span></span><span style="display:flex;"><span>ns-1832.awsdns-37.co.uk. 1593	IN	AAAA	2600:9000:5307:2800::1
</span></span><span style="display:flex;"><span>ns-cloud-d1.googledomains.com. <span style="color:#3677a9">3204</span> IN	AAAA	2001:4860:4802:32::6d
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"># 第 6 段是 DNS 服务器的一些传输信息</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>;; Query time: <span style="color:#3677a9">26</span> msec
</span></span><span style="display:flex;"><span>;; SERVER: 192.168.1.1#53(192.168.1.1)
</span></span><span style="display:flex;"><span>;; WHEN: Fri Feb <span style="color:#3677a9">17</span> 22:31:26 CST <span style="color:#3677a9">2023</span>
</span></span><span style="display:flex;"><span>;; MSG SIZE  rcvd: <span style="color:#3677a9">368</span>
</span></span></code></pre></div><p>如果不想看到这么多内容，可以使用 +short 参数</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ dig +short math.stackexchange.com
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"># 输出如下</span>
</span></span><span style="display:flex;"><span>151.101.1.69
</span></span><span style="display:flex;"><span>151.101.129.69
</span></span><span style="display:flex;"><span>151.101.193.69
</span></span><span style="display:flex;"><span>151.101.65.69
</span></span></code></pre></div><p>上面命令只返回 math.stackexchange.com 对应的 4 个 IP 地址（即A记录）。</p>
<h2 id="三dns服务器">三、DNS服务器</h2>
<p>下面我们根据前面这个例子，一步步还原，本机到底怎么得到域名 math.stackexchange.com 的IP地址。</p>
<p>首先，本机一定要知道 <code>DNS</code> 服务器的IP地址，否则上不了网。通过DNS服务器，才能知道某个域名的IP地址到底是什么。</p>
<p><img src="https://dbwu.tech/images/dns_1.png" alt="查看 DNS 服务器配置"></p>
<p><code>DNS</code> 服务器的IP地址，有可能是动态的，每次上网时由网关分配，这叫做 DHCP 机制；也有可能是事先指定的固定地址。
Linux系统里面，<code>DNS</code> 服务器的 IP 地址保存在 <code>/etc/resolv.conf</code> 文件。</p>
<p>上例的 <code>DNS</code> 服务器是 192.168.1.253，这是一个内网地址。有一些公网的DNS服务器，也可以使用，其中最有名的就是 Google 的 8.8.8.8 和 Level 3 的 4.2.2.2。</p>
<p>本机只向自己的 <code>DNS</code> 服务器查询，dig 命令有一个@参数，显示向其他 <code>DNS</code> 服务器查询的结果。</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ dig @4.2.2.2 math.stackexchange.com
</span></span></code></pre></div><p>上面命令指定向 DNS 服务器 4.2.2.2 查询。</p>
<h2 id="四域名的层级">四、域名的层级</h2>
<p><code>DNS</code> 服务器怎么会知道每个域名的 IP 地址呢？答案是分级查询。</p>
<p>请仔细看前面的例子，每个域名的尾部都多了一个点。</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>;; QUESTION SECTION:
</span></span><span style="display:flex;"><span>;math.stackexchange.com.		IN	A
</span></span></code></pre></div><p>比如，域名 math.stackexchange.com 显示为 math.stackexchange.com.。这不是疏忽，而是所有域名的尾部，实际上都有一个根域名。</p>
<p>举例来说，<code>www.example.com</code> 真正的域名是 <code>www.example.com.root</code> ，简写为 <code>www.example.com.</code> 。因为，根域名.root 对于所有域名都是一样的， 所以平时是省略的。</p>
<p>根域名的下一级，叫做 <strong>顶级域名</strong>（top-level domain，缩写为 TLD），比如 .com、.net；再下一级叫做 <strong>次级域名</strong>（second-level domain，缩写为 SLD），
比如 <code>www.example.com</code> 里面的 .example，这一级域名是用户可以注册的；再下一级是 <strong>主机名</strong>（host），比如 <code>www.example.com</code> 里面的 www，又称为 <strong>三级域名</strong>，
这是用户在自己的域里面为服务器分配的名称，是用户可以任意分配的。</p>
<p>总结一下，域名的层级结构如下。</p>
<blockquote>
<p>主机名.次级域名.顶级域名.根域名</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>主机名.次级域名.顶级域名.根域名
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"># 即</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>host.sld.tld.root
</span></span></code></pre></div><h2 id="五根域名服务器">五、根域名服务器</h2>
<p><code>DNS</code> 服务器根据域名的层级，进行分级查询。</p>
<p>需要明确的是，每一级域名都有自己的 <code>NS</code> 记录，<code>NS</code> 记录指向该级域名的域名服务器。这些服务器知道下一级域名的各种记录。</p>
<p>所谓 <strong>分级查询</strong>，就是从根域名开始，依次查询每一级域名的 <code>NS</code> 记录，直到查到最终的 IP 地址，过程大致如下。</p>
<blockquote>
<ol>
<li>从 &ldquo;根域名服务器&rdquo; 查到 &ldquo;顶级域名服务器&quot;的 NS 记录和 A 记录（IP 地址）</li>
<li>从 &ldquo;顶级域名服务器&rdquo; 查到 &ldquo;次级域名服务器&quot;的 NS 记录和 A 记录（IP 地址）</li>
<li>从 &ldquo;次级域名服务器&rdquo; 查到 &ldquo;主机名&quot;的 IP 地址</li>
</ol>
</blockquote>
<p>仔细看上面的过程，你可能发现了，没有提到 <code>DNS</code> 服务器怎么知道 &ldquo;根域名服务器&rdquo; 的 IP 地址。
回答是 &ldquo;根域名服务器&rdquo; 的 <code>NS</code> 记录和 IP 地址一般是不会变化的， 所以内置在 <code>DNS</code> 服务器里面。</p>
<p>下面是内置的根域名服务器 IP 地址的一个 <a href="http://www.cyberciti.biz/faq/unix-linux-update-root-hints-data-file/">例子 </a></p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>; formerly NS.INTERNIC.NET
</span></span><span style="display:flex;"><span>;
</span></span><span style="display:flex;"><span>.                        <span style="color:#3677a9">3600000</span>  IN  NS    A.ROOT-SERVERS.NET.
</span></span><span style="display:flex;"><span>A.ROOT-SERVERS.NET.      <span style="color:#3677a9">3600000</span>      A     198.41.0.4
</span></span><span style="display:flex;"><span>A.ROOT-SERVERS.NET.      <span style="color:#3677a9">3600000</span>      AAAA  2001:503:BA3E::2:30
</span></span><span style="display:flex;"><span>;
</span></span><span style="display:flex;"><span>; formerly NS1.ISI.EDU
</span></span><span style="display:flex;"><span>;
</span></span><span style="display:flex;"><span>.                        <span style="color:#3677a9">3600000</span>      NS    B.ROOT-SERVERS.NET.
</span></span><span style="display:flex;"><span>B.ROOT-SERVERS.NET.      <span style="color:#3677a9">3600000</span>      A     192.228.79.201
</span></span><span style="display:flex;"><span>;
</span></span><span style="display:flex;"><span>; formerly C.PSI.NET
</span></span><span style="display:flex;"><span>;
</span></span><span style="display:flex;"><span>.                        <span style="color:#3677a9">3600000</span>      NS    C.ROOT-SERVERS.NET.
</span></span><span style="display:flex;"><span>C.ROOT-SERVERS.NET.      <span style="color:#3677a9">3600000</span>      A     192.33.4.12
</span></span></code></pre></div><p>上面列表中，列出了根域名（.root）的三条 <code>NS</code> 记录 A.ROOT-SERVERS.NET、B.ROOT-SERVERS.NET 和 C.ROOT-SERVERS.NET，
以及它们的 IP 地址（即 A 记录）198.41.0.4、192.228.79.201、192.33.4.12。</p>
<p>另外，可以看到所有记录的 TTL 值是 3600000 秒，相当于 1000 小时。也就是说，每 1000 小时才查询一次根域名服务器的列表。</p>
<p>目前，<strong>世界上一共有 13 组根域名服务器</strong>，从 A.ROOT-SERVERS.NET 一直到 M.ROOT-SERVERS.NET。</p>
<h2 id="六分级查询的实例">六、分级查询的实例</h2>
<p>dig 命令的 +trace 参数可以显示 DNS 的整个分级查询过程。</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ dig +trace math.stackexchange.com
</span></span></code></pre></div><p>上面命令的第一段列出根域名.的所有 <code>NS</code> 记录，即所有根域名服务器。</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>; &lt;&lt;&gt;&gt; DiG 9.16.37-Debian &lt;&lt;&gt;&gt; +trace math.stackexchange.com
</span></span><span style="display:flex;"><span>;; global options: +cmd
</span></span><span style="display:flex;"><span>.                       <span style="color:#3677a9">259200</span>  IN      NS      g.root-servers.net.
</span></span><span style="display:flex;"><span>.                       <span style="color:#3677a9">259200</span>  IN      NS      j.root-servers.net.
</span></span><span style="display:flex;"><span>.                       <span style="color:#3677a9">259200</span>  IN      NS      e.root-servers.net.
</span></span><span style="display:flex;"><span>.                       <span style="color:#3677a9">259200</span>  IN      NS      l.root-servers.net.
</span></span><span style="display:flex;"><span>.                       <span style="color:#3677a9">259200</span>  IN      NS      d.root-servers.net.
</span></span><span style="display:flex;"><span>.                       <span style="color:#3677a9">259200</span>  IN      NS      a.root-servers.net.
</span></span><span style="display:flex;"><span>.                       <span style="color:#3677a9">259200</span>  IN      NS      b.root-servers.net.
</span></span><span style="display:flex;"><span>.                       <span style="color:#3677a9">259200</span>  IN      NS      i.root-servers.net.
</span></span><span style="display:flex;"><span>.                       <span style="color:#3677a9">259200</span>  IN      NS      m.root-servers.net.
</span></span><span style="display:flex;"><span>.                       <span style="color:#3677a9">259200</span>  IN      NS      h.root-servers.net.
</span></span><span style="display:flex;"><span>.                       <span style="color:#3677a9">259200</span>  IN      NS      c.root-servers.net.
</span></span><span style="display:flex;"><span>.                       <span style="color:#3677a9">259200</span>  IN      NS      k.root-servers.net.
</span></span><span style="display:flex;"><span>.                       <span style="color:#3677a9">259200</span>  IN      NS      f.root-servers.net.
</span></span></code></pre></div><p>根据内置的根域名服务器 IP 地址，DNS 服务器向所有这些 IP 地址发出查询请求，询问 math.stackexchange.com 的顶级域名服务器 com.的 NS 记录。
最先回复的根域名服务器将被缓存，以后只向这台服务器发请求。</p>
<p>接着是第二段。</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>com.                    <span style="color:#3677a9">172800</span>  IN      NS      a.gtld-servers.net.
</span></span><span style="display:flex;"><span>com.                    <span style="color:#3677a9">172800</span>  IN      NS      b.gtld-servers.net.
</span></span><span style="display:flex;"><span>com.                    <span style="color:#3677a9">172800</span>  IN      NS      c.gtld-servers.net.
</span></span><span style="display:flex;"><span>com.                    <span style="color:#3677a9">172800</span>  IN      NS      d.gtld-servers.net.
</span></span><span style="display:flex;"><span>com.                    <span style="color:#3677a9">172800</span>  IN      NS      e.gtld-servers.net.
</span></span><span style="display:flex;"><span>com.                    <span style="color:#3677a9">172800</span>  IN      NS      f.gtld-servers.net.
</span></span><span style="display:flex;"><span>com.                    <span style="color:#3677a9">172800</span>  IN      NS      g.gtld-servers.net.
</span></span><span style="display:flex;"><span>com.                    <span style="color:#3677a9">172800</span>  IN      NS      h.gtld-servers.net.
</span></span><span style="display:flex;"><span>com.                    <span style="color:#3677a9">172800</span>  IN      NS      i.gtld-servers.net.
</span></span><span style="display:flex;"><span>com.                    <span style="color:#3677a9">172800</span>  IN      NS      j.gtld-servers.net.
</span></span><span style="display:flex;"><span>com.                    <span style="color:#3677a9">172800</span>  IN      NS      k.gtld-servers.net.
</span></span><span style="display:flex;"><span>com.                    <span style="color:#3677a9">172800</span>  IN      NS      l.gtld-servers.net.
</span></span><span style="display:flex;"><span>com.                    <span style="color:#3677a9">172800</span>  IN      NS      m.gtld-servers.net.
</span></span></code></pre></div><p>上面结果显示.com 域名的 13 条 <code>NS</code> 记录，同时返回的还有每一条记录对应的 IP 地址。</p>
<p>然后，<code>DNS</code> 服务器向这些顶级域名服务器发出查询请求，询问 math.stackexchange.com 的次级域名 stackexchange.com 的 <code>NS</code> 记录。</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>stackexchange.com.      <span style="color:#3677a9">172800</span>  IN      NS      ns-925.awsdns-51.net.
</span></span><span style="display:flex;"><span>stackexchange.com.      <span style="color:#3677a9">172800</span>  IN      NS      ns-1832.awsdns-37.co.uk.
</span></span><span style="display:flex;"><span>stackexchange.com.      <span style="color:#3677a9">172800</span>  IN      NS      ns-cloud-d1.googledomains.com.
</span></span><span style="display:flex;"><span>stackexchange.com.      <span style="color:#3677a9">172800</span>  IN      NS      ns-cloud-d2.googledomains.com.
</span></span></code></pre></div><p>上面结果显示 stackexchange.com 有四条 <code>NS</code> 记录，同时返回的还有每一条 NS 记录对应的 IP 地址。</p>
<p>然后，DNS 服务器向上面这四台 NS 服务器查询 math.stackexchange.com 的主机名。</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>math.stackexchange.com. <span style="color:#3677a9">300</span>     IN      A       151.101.129.69
</span></span><span style="display:flex;"><span>math.stackexchange.com. <span style="color:#3677a9">300</span>     IN      A       151.101.1.69
</span></span><span style="display:flex;"><span>math.stackexchange.com. <span style="color:#3677a9">300</span>     IN      A       151.101.65.69
</span></span><span style="display:flex;"><span>math.stackexchange.com. <span style="color:#3677a9">300</span>     IN      A       151.101.193.69
</span></span><span style="display:flex;"><span>;; Received <span style="color:#3677a9">115</span> bytes from 216.239.34.109#53(ns-cloud-d2.googledomains.com) in <span style="color:#3677a9">35</span> ms
</span></span></code></pre></div><p>上面结果显示，math.stackexchange.com 有 4 条 A 记录，即这四个 IP 地址都可以访问到网站。并且还显示，
最先返回结果的 NS 服务器是 ns-cloud-d2.googledomains.com，IP 地址为 216.239.34.109。</p>
<h2 id="七ns-记录的查询">七、NS 记录的查询</h2>
<p>dig 命令可以单独查看每一级域名的 <code>NS</code> 记录。</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ dig ns com
</span></span><span style="display:flex;"><span>$ dig ns stackexchange.com
</span></span></code></pre></div><p>+short 参数可以显示简化的结果</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ dig +short ns com
</span></span><span style="display:flex;"><span>$ dig +short ns stackexchange.com
</span></span></code></pre></div><h2 id="八dns-的记录类型">八、DNS 的记录类型</h2>
<p>域名与 IP 之间的对应关系，称为 &ldquo;记录&rdquo;（record）。根据使用场景，&ldquo;记录&quot;可以分成不同的类型（type），前面已经看到了有 <code>A</code> 记录和 <code>NS</code> 记录。</p>
<p>常见的 DNS 记录类型如下。</p>
<ul>
<li><strong>A</strong>：地址记录（Address），返回域名指向的 IP 地址。</li>
<li><strong>AAAA</strong>: 记录是域名到 IPV6 地址。</li>
<li><strong>NS</strong>：域名服务器记录（Name Server），返回保存下一级域名信息的服务器地址。该记录只能设置为域名，不能设置为 IP 地址。</li>
<li><strong>MX</strong>：邮件记录（Mail eXchange），返回接收电子邮件的服务器地址。</li>
<li><strong>CNAME</strong>：规范名称记录（Canonical Name），返回另一个域名，即当前查询的域名是另一个域名的跳转，详见下文。</li>
<li><strong>PTR</strong>：逆向查询记录（Pointer Record），只用于从 IP 地址查询域名，详见下文。</li>
</ul>
<p>一般来说，为了服务的安全可靠，至少应该有两条 <code>NS</code> 记录，而 <code>A</code> 记录和 MX 记录也可以有多条，这样就提供了服务的冗余性，防止出现单点失败。</p>
<p><code>CNAME</code> 记录主要用于域名的内部跳转，为服务器配置提供灵活性，用户感知不到。举例来说，facebook.github.io 这个域名就是一个 CNAME 记录。</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ dig facebook.github.io
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>;; ANSWER SECTION:
</span></span><span style="display:flex;"><span>facebook.github.io. <span style="color:#3677a9">3370</span>    IN  CNAME   github.map.fastly.net.
</span></span><span style="display:flex;"><span>github.map.fastly.net.  <span style="color:#3677a9">600</span> IN  A   103.245.222.133
</span></span></code></pre></div><p>上面结果显示，facebook.github.io 的 CNAME 记录指向 github.map.fastly.net。也就是说，用户查询 facebook.github.io 的时候，
实际上返回的是 github.map.fastly.net 的 IP 地址。这样的好处是，变更服务器 IP 地址的时候，只要修改 github.map.fastly.net 这个域名就可以了，
用户的 facebook.github.io 域名不用修改。</p>
<p>由于 <code>CNAME</code> 记录就是一个替换，所以域名一旦设置 <code>CNAME</code> 记录以后，就不能再设置其他记录了（比如 <code>A</code> 记录和 MX 记录），这是为了防止产生冲突。
举例来说，foo.com 指向 bar.com，而两个域名各有自己的 MX 记录，如果两者不一致，就会产生问题。由于顶级域名通常要设置 MX 记录，
所以一般不允许用户对顶级域名设置 CNAME 记录。</p>
<p><code>PTR</code> 记录用于从 IP 地址反查域名。dig 命令的 -x 参数用于查询 PTR 记录。</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ dig -x 192.30.252.153
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>;; ANSWER SECTION:
</span></span><span style="display:flex;"><span>153.252.30.192.in-addr.arpa. <span style="color:#3677a9">3600</span> IN    PTR pages.github.com.
</span></span></code></pre></div><p>上面结果显示，192.30.252.153 这台服务器的域名是 pages.github.com。</p>
<p><strong>逆向查询的一个应用，是可以防止垃圾邮件，即验证发送邮件的 IP 地址，是否真的有它所声称的域名</strong>。</p>
<p>dig 命令可以查看指定的记录类型。</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ dig a github.com
</span></span><span style="display:flex;"><span>$ dig ns github.com
</span></span><span style="display:flex;"><span>$ dig mx github.com
</span></span></code></pre></div><p>九、其他 DNS 工具</p>
<p>除了 dig，还有一些其他小工具也可以使用。</p>
<p>（1）host 命令</p>
<p>host 命令可以看作 dig 命令的简化版本，返回当前请求域名的各种记录。</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ host github.com
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>github.com has address 192.30.252.121
</span></span><span style="display:flex;"><span>github.com mail is handled by <span style="color:#3677a9">5</span> ALT2.ASPMX.L.GOOGLE.COM.
</span></span><span style="display:flex;"><span>github.com mail is handled by <span style="color:#3677a9">10</span> ALT4.ASPMX.L.GOOGLE.COM.
</span></span><span style="display:flex;"><span>github.com mail is handled by <span style="color:#3677a9">10</span> ALT3.ASPMX.L.GOOGLE.COM.
</span></span><span style="display:flex;"><span>github.com mail is handled by <span style="color:#3677a9">5</span> ALT1.ASPMX.L.GOOGLE.COM.
</span></span><span style="display:flex;"><span>github.com mail is handled by <span style="color:#3677a9">1</span> ASPMX.L.GOOGLE.COM.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ host facebook.github.com
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>facebook.github.com is an <span style="color:#24909d">alias</span> <span style="color:#6ab825;font-weight:bold">for</span> github.map.fastly.net.
</span></span><span style="display:flex;"><span>github.map.fastly.net has address 103.245.222.133
</span></span></code></pre></div><p>host 命令也可以用于逆向查询，即从 IP 地址查询域名，等同于 dig -x <!-- raw HTML omitted -->。</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>host 192.30.252.153
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>153.252.30.192.in-addr.arpa domain name pointer pages.github.com.
</span></span></code></pre></div><p>（2）nslookup 命令</p>
<p>nslookup 命令用于互动式地查询域名记录。</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ nslookup
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&gt; facebook.github.io
</span></span><span style="display:flex;"><span>Server:     192.168.1.253
</span></span><span style="display:flex;"><span>Address:    192.168.1.253#53
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Non-authoritative answer:
</span></span><span style="display:flex;"><span>facebook.github.io  canonical <span style="color:#40ffff">name</span> = github.map.fastly.net.
</span></span><span style="display:flex;"><span>Name:   github.map.fastly.net
</span></span><span style="display:flex;"><span>Address: 103.245.222.133
</span></span></code></pre></div><p>（3）whois 命令</p>
<p>whois 命令用来查看域名的注册情况。</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ whois github.com
</span></span></code></pre></div><h2 id="十参考链接">十、参考链接</h2>
<ul>
<li><a href="https://www.petekeen.net/dns-the-good-parts">DNS: The Good Parts, by Pete Keen</a></li>
<li><a href="http://www.integralist.co.uk/posts/dnsbasics.html">DNS 101, by Mark McDonnell</a></li>
</ul>
<h2 id="转载声明">转载声明</h2>
<p>本文转载自 <a href="http://www.ruanyifeng.com/blog/2016/06/dns.html">DNS 原理入门</a>，笔者在文字描述和图片排版上略作修改。</p>
<h2 id="小结">小结</h2>
<p>下面是笔者补充的部分，简述下 <code>DNS</code> 的流程。</p>
<p><img src="https://dbwu.tech/images/dns_2.png" alt="图片来源: https://aws.amazon.com/cn/route53/what-is-dns/"></p>
<ul>
<li>浏览器输入域名，如 <code>www.example.com</code></li>
<li>查询当前硬件的缓存（<code>host 文件</code> 或浏览器缓存）中是否存在该域名对应的记录，如果存在直接使用，如果不存在则进入后续流程</li>
<li>向运营商的 DNS 服务器发起 DNS 解析的请求，一般称运营商的 DNS 服务器为 <code>Local DNS</code></li>
<li><code>Local DNS</code> 会查询缓存记录 (内部实现对请求端来说是透明的)</li>
<li><code>Local DNS</code> 如果没有缓存，会把域名从右往左扫描，依次请求对应的服务器</li>
<li>对于域名 <code>www.example.com</code>，先去请求根域名服务器，假设根域名服务器返回了管理 <code>.com</code> 域的服务器，名字为 TLD</li>
<li><code>Local DNS</code> 请求管理 TLD 服务器</li>
<li>一般来说，TLD 返回的记录是一条 CNAME 记录，这里假设域名的 CNAME 解析到了 Amazon</li>
<li><code>Local DNS</code> 请求 Amazon 的 DNS 服务器 (一般称之为权威服务器，权威服务器是 Amazon 自己构建的)</li>
<li>Amazon 返回 <code>www.example.com</code> 对应的服务器 IP 地址</li>
<li><code>Local DNS</code> 缓存这个 IP 地址，并且返回给浏览器</li>
<li>浏览器和返回的 IP 地址建立 TCP 连接，发送 HTTP 报文</li>
</ul>
<h2 id="如何自建-dns-服务器">如何自建 DNS 服务器</h2>
<ul>
<li>在自己的服务器上 (例如 10.0.0.1) 构建一个 <code>DNS</code> 服务 (可以理解为一个软件，支持 <code>DNS</code> 协议，就像 Nginx 支持 HTTP 协议)</li>
<li>在域名系统管理后台，新增一条 CNAME 记录，将域名的解析转交给 10.0.0.1</li>
<li>10.0.0.1 可以自定义返回各个域名对应的 IP 地址，实现自定义 <code>DNS</code> 服务器</li>
</ul>
<h2 id="扩展阅读">扩展阅读</h2>
<ul>
<li><a href="https://scoolor.github.io/2018/11/10/dns-udp-tcp/">为什么 DNS 同时使用 TCP 和 UDP</a></li>
<li><a href="https://www.cloudflare.com/zh-cn/learning/dns/what-is-dns/">what-is-dns</a></li>
</ul>


</article>

<article>
    <img src="https://dbwu.tech/images/wechat.png">
</article>

<article>
    <h3>转载申请</h3>

    <p>
        本作品采用 <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">知识共享署名 4.0 国际许可协议</a> 进行许可，转载时请注明原文链接，图片在使用时请保留全部内容，商业转载请联系作者获得授权。
    </p>
</article>

<section class="post-nav">
    <ul>
        <li>
        
            <a href="https://dbwu.tech/posts/go1.20/"><i class="fa fa-chevron-circle-left"></i> Go 1.20 发布了</a>
        
        </li>
        <li>
        
            <a href="https://dbwu.tech/posts/byte_order/">字节序概述 <i class="fa fa-chevron-circle-right"></i> </a>
        
        </li>
    </ul>
</section>
  
    
    
  


<script src="https://giscus.app/client.js"
        data-repo="duanbiaowu/dbwu.tech"
        data-repo-id="R_kgDOIkkjjw"
        data-category="Announcements"
        data-category-id="DIC_kwDOIkkjj84CV78j"
        data-mapping="specific"
        data-term="DNS 原理"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="1"
        data-input-position="top"
        data-theme="light"
        data-lang="zh-CN"
        crossorigin="anonymous" async>
</script>




</main>
    <footer>
        <ul>
            <li>
                <h6><a href="mailto:codean.net@gmail.com">codean.net@gmail.com</a> | 
                    <img src="https://dbwu.tech/images/%E5%A4%87%E6%A1%88%E5%9B%BE%E6%A0%87.png" />
                    <a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=61011302001681" target="_blank">陕公网安备 61011302001681 号</a> |
                    <a href="https://beian.miit.gov.cn" target="_blank">陕ICP备2023004378号-1</a> |
                    Rendered by <a href="https://themes.gohugo.io" title="Hugo" target="_blank">Hugo</a>
                </h6>
            </li>
            
            
        </ul>
    </footer>
</div>
<script src="https://dbwu.tech/js/scripts.js"></script>


</body>

</html>

