<!doctype html>

<html lang="en">

<head>
  <title>Go 并发模式 - 蛮荆</title>
  <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="description" content="Go 语言常用的并发模式代码模板，已更新。" />
<meta name="author" content="" />
<link rel="shortcut icon" href="https://dbwu.tech/favicon.ico" type="image/x-icon" /><meta property="og:title" content="Go 并发模式" />
<meta property="og:description" content="Go 语言常用的并发模式有哪些？" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://dbwu.tech/posts/golang_concurrency_patterns/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-04-18T00:00:00+00:00" />
<meta property="article:modified_time" content="2023-04-18T00:00:00+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Go 并发模式"/>
<meta name="twitter:description" content="Go 语言常用的并发模式有哪些？"/>

<meta name="generator" content="Hugo 0.113.0">
    
    <script src="https://dbwu.tech/js/mathjax-config.js" defer></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-CZMGTTFLNY"></script>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3261056100776781" crossorigin="anonymous"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-CZMGTTFLNY');
  </script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js" integrity="sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js" integrity="sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa" crossorigin="anonymous"
        onload="renderMathInElement(document.body);"></script>


  <link rel="stylesheet" href="https://dbwu.tech/fontawesome/css/normalize.min.css" />
  <link rel="stylesheet" href="https://dbwu.tech/fontawesome/css/all.min.css" />
  
    
    <link href="//fonts.googleapis.com/css?family=Staatliches" rel="stylesheet">
  
  
  <link rel="stylesheet" type="text/css" href="https://dbwu.tech/css/styles-light.css" />
  </head>

<body>
  <div id="container">
    <header>
      
      <h1>
        <a href="https://dbwu.tech/">蛮荆</a>
      </h1>

      <ul id="social-media">
      </ul>
      
    </header>

    
<nav>
    <ul>
        
        <li>
            <a class="active" href="https://dbwu.tech/posts/">
                <i class="fa-li fa  fa-lg"></i><span>归档</span>
            </a>
        </li>
        
        <li>
            <a class="" href="https://dbwu.tech/tags/">
                <i class="fa-li fa  fa-lg"></i><span>标签</span>
            </a>
        </li>
        
        <li>
            <a class="" href="https://github.com/duanbiaowu">
                <i class="fa-li fa  fa-lg"></i><span>Github</span>
            </a>
        </li>
        
        <li>
            <a class="" href="https://dbwu.tech/index.xml">
                <i class="fa-li fa  fa-lg"></i><span>RSS</span>
            </a>
        </li>
        
    </ul>
</nav>


    <main>




<article>

    <h1>Go 并发模式</h1>

    
      
<li>
    
    
    <a href="https://dbwu.tech/tags/golang">Golang</a>
    
    
    <a href="https://dbwu.tech/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B">并发编程</a>
    
</li>

    

    
      

    

    <h2 id="前言">前言</h2>
<p><strong>文章代码量较多，如果是初次阅读，建议了解每种模式的基础用法即可，工作中有实际的应用开发场景时，再回来研究代码细节</strong>。</p>
<h2 id="经典模式-pipeline--selector">经典模式 (pipeline + selector)</h2>
<p>这里有一个来自 Go 官方博客的例子，通过管道筛选质数并打印。</p>
<p><img src="https://dbwu.tech/images/primesieve.png" alt="质数筛选器"></p>
<h3 id="第一个版本">第一个版本</h3>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">package</span> main
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">import</span> <span style="color:#ed9d13">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic">// 生成数字并发送到通道
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span><span style="color:#6ab825;font-weight:bold">func</span> <span style="color:#447fcf">generate</span>(ch <span style="color:#6ab825;font-weight:bold">chan</span> <span style="color:#6ab825;font-weight:bold">int</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">for</span> i := <span style="color:#3677a9">2</span>; ; i++ {
</span></span><span style="display:flex;"><span>        ch &lt;- i
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic">// 通过参数质数过滤 in 通道传递的数字
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span><span style="color:#6ab825;font-weight:bold">func</span> <span style="color:#447fcf">filter</span>(in, out <span style="color:#6ab825;font-weight:bold">chan</span> <span style="color:#6ab825;font-weight:bold">int</span>, prime <span style="color:#6ab825;font-weight:bold">int</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">for</span> {
</span></span><span style="display:flex;"><span>        i := &lt;-in 
</span></span><span style="display:flex;"><span>        <span style="color:#6ab825;font-weight:bold">if</span> i%prime != <span style="color:#3677a9">0</span> {
</span></span><span style="display:flex;"><span>            out &lt;- i 
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">func</span> <span style="color:#447fcf">main</span>() {
</span></span><span style="display:flex;"><span>    ch := <span style="color:#24909d">make</span>(<span style="color:#6ab825;font-weight:bold">chan</span> <span style="color:#6ab825;font-weight:bold">int</span>) 
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">go</span> <span style="color:#447fcf">generate</span>(ch)      
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">for</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#999;font-style:italic">// 不断生成数字和筛选管道
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>        prime := &lt;-ch
</span></span><span style="display:flex;"><span>        fmt.<span style="color:#447fcf">Print</span>(prime, <span style="color:#ed9d13">&#34; &#34;</span>)
</span></span><span style="display:flex;"><span>        ch1 := <span style="color:#24909d">make</span>(<span style="color:#6ab825;font-weight:bold">chan</span> <span style="color:#6ab825;font-weight:bold">int</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#6ab825;font-weight:bold">go</span> <span style="color:#447fcf">filter</span>(ch, ch1, prime)
</span></span><span style="display:flex;"><span>        ch = ch1
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="第二个版本">第二个版本</h3>
<p>第二个版本在之前的基础上进行了改进：<code>sieve</code>, <code>generate</code>, <code>filter</code> 改为工厂函数，创建通道并返回，而且使用了协程的 <code>lambda</code> 函数。
<code>main</code> 函数变得更加短小清晰：调用 <code>sieve()</code> 返回包含质数的通道，然后打印即可。</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">package</span> main
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">import</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#ed9d13">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">func</span> <span style="color:#447fcf">generate</span>() <span style="color:#6ab825;font-weight:bold">chan</span> <span style="color:#6ab825;font-weight:bold">int</span> {
</span></span><span style="display:flex;"><span>    ch := <span style="color:#24909d">make</span>(<span style="color:#6ab825;font-weight:bold">chan</span> <span style="color:#6ab825;font-weight:bold">int</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">go</span> <span style="color:#6ab825;font-weight:bold">func</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#6ab825;font-weight:bold">for</span> i := <span style="color:#3677a9">2</span>; ; i++ {
</span></span><span style="display:flex;"><span>            ch &lt;- i
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }()
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">return</span> ch
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">func</span> <span style="color:#447fcf">filter</span>(in <span style="color:#6ab825;font-weight:bold">chan</span> <span style="color:#6ab825;font-weight:bold">int</span>, prime <span style="color:#6ab825;font-weight:bold">int</span>) <span style="color:#6ab825;font-weight:bold">chan</span> <span style="color:#6ab825;font-weight:bold">int</span> {
</span></span><span style="display:flex;"><span>    out := <span style="color:#24909d">make</span>(<span style="color:#6ab825;font-weight:bold">chan</span> <span style="color:#6ab825;font-weight:bold">int</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">go</span> <span style="color:#6ab825;font-weight:bold">func</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#6ab825;font-weight:bold">for</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#6ab825;font-weight:bold">if</span> i := &lt;-in; i%prime != <span style="color:#3677a9">0</span> {
</span></span><span style="display:flex;"><span>                out &lt;- i
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }()
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">return</span> out
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">func</span> <span style="color:#447fcf">sieve</span>() <span style="color:#6ab825;font-weight:bold">chan</span> <span style="color:#6ab825;font-weight:bold">int</span> {
</span></span><span style="display:flex;"><span>    out := <span style="color:#24909d">make</span>(<span style="color:#6ab825;font-weight:bold">chan</span> <span style="color:#6ab825;font-weight:bold">int</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">go</span> <span style="color:#6ab825;font-weight:bold">func</span>() {
</span></span><span style="display:flex;"><span>        ch := <span style="color:#447fcf">generate</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#6ab825;font-weight:bold">for</span> {
</span></span><span style="display:flex;"><span>            prime := &lt;-ch
</span></span><span style="display:flex;"><span>            ch = <span style="color:#447fcf">filter</span>(ch, prime)
</span></span><span style="display:flex;"><span>            out &lt;- prime
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }()
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">return</span> out
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">func</span> <span style="color:#447fcf">main</span>() {
</span></span><span style="display:flex;"><span>    primes := <span style="color:#447fcf">sieve</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">for</span> {
</span></span><span style="display:flex;"><span>        fmt.<span style="color:#447fcf">Println</span>(&lt;-primes)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><img src="https://dbwu.tech/images/primesieve.gif" alt="质数筛选器动图"></p>
<h2 id="fanin-fanout">FanIn FanOut</h2>
<blockquote>
<p>Fan-In:  1 个 goroutine 从多个通道读取数据 (一对多)
Fan-Out: 多个 goroutine 从 1 个通道读取数据 (多对一)</p>
</blockquote>
<p><img src="https://dbwu.tech/images/fanout-fanin.png" alt="图片来源: https://jguer.space/posts/go-fanout-context/"></p>
<p>官网上有一个经典用例 <code>质数求和</code>，同时用到了这两种模式。</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">package</span> main
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#ed9d13">&#34;math&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ed9d13">&#34;sync&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ed9d13">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">func</span> <span style="color:#447fcf">echo</span>(numbs []<span style="color:#6ab825;font-weight:bold">int</span>) &lt;-<span style="color:#6ab825;font-weight:bold">chan</span> <span style="color:#6ab825;font-weight:bold">int</span> {
</span></span><span style="display:flex;"><span>	out := <span style="color:#24909d">make</span>(<span style="color:#6ab825;font-weight:bold">chan</span> <span style="color:#6ab825;font-weight:bold">int</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#6ab825;font-weight:bold">go</span> <span style="color:#6ab825;font-weight:bold">func</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#6ab825;font-weight:bold">for</span> _, n := <span style="color:#6ab825;font-weight:bold">range</span> numbs {
</span></span><span style="display:flex;"><span>			out &lt;- n
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#24909d">close</span>(out)
</span></span><span style="display:flex;"><span>	}()
</span></span><span style="display:flex;"><span>	<span style="color:#6ab825;font-weight:bold">return</span> out
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic">// 求和函数
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span><span style="color:#6ab825;font-weight:bold">func</span> <span style="color:#447fcf">sum</span>(in &lt;-<span style="color:#6ab825;font-weight:bold">chan</span> <span style="color:#6ab825;font-weight:bold">int</span>) &lt;-<span style="color:#6ab825;font-weight:bold">chan</span> <span style="color:#6ab825;font-weight:bold">int</span> {
</span></span><span style="display:flex;"><span>	out := <span style="color:#24909d">make</span>(<span style="color:#6ab825;font-weight:bold">chan</span> <span style="color:#6ab825;font-weight:bold">int</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#6ab825;font-weight:bold">go</span> <span style="color:#6ab825;font-weight:bold">func</span>() {
</span></span><span style="display:flex;"><span>		res := <span style="color:#3677a9">0</span>
</span></span><span style="display:flex;"><span>		<span style="color:#6ab825;font-weight:bold">for</span> n := <span style="color:#6ab825;font-weight:bold">range</span> in {
</span></span><span style="display:flex;"><span>			res += n
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		out &lt;- res
</span></span><span style="display:flex;"><span>		<span style="color:#24909d">close</span>(out)
</span></span><span style="display:flex;"><span>	}()
</span></span><span style="display:flex;"><span>	<span style="color:#6ab825;font-weight:bold">return</span> out
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">func</span> <span style="color:#447fcf">makeRange</span>(min, max <span style="color:#6ab825;font-weight:bold">int</span>) []<span style="color:#6ab825;font-weight:bold">int</span> {
</span></span><span style="display:flex;"><span>	a := <span style="color:#24909d">make</span>([]<span style="color:#6ab825;font-weight:bold">int</span>, max-min+<span style="color:#3677a9">1</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#6ab825;font-weight:bold">for</span> i := <span style="color:#6ab825;font-weight:bold">range</span> a {
</span></span><span style="display:flex;"><span>		a[i] = min + i
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#6ab825;font-weight:bold">return</span> a
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">func</span> <span style="color:#447fcf">isPrime</span>(value <span style="color:#6ab825;font-weight:bold">int</span>) <span style="color:#6ab825;font-weight:bold">bool</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#6ab825;font-weight:bold">for</span> i := <span style="color:#3677a9">2</span>; i &lt;= <span style="color:#24909d">int</span>(math.<span style="color:#447fcf">Floor</span>(<span style="color:#24909d">float64</span>(value)/<span style="color:#3677a9">2</span>)); i++ {
</span></span><span style="display:flex;"><span>		<span style="color:#6ab825;font-weight:bold">if</span> value%i == <span style="color:#3677a9">0</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#6ab825;font-weight:bold">return</span> <span style="color:#6ab825;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#6ab825;font-weight:bold">return</span> value &gt; <span style="color:#3677a9">1</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">func</span> <span style="color:#447fcf">prime</span>(in &lt;-<span style="color:#6ab825;font-weight:bold">chan</span> <span style="color:#6ab825;font-weight:bold">int</span>) &lt;-<span style="color:#6ab825;font-weight:bold">chan</span> <span style="color:#6ab825;font-weight:bold">int</span> {
</span></span><span style="display:flex;"><span>	out := <span style="color:#24909d">make</span>(<span style="color:#6ab825;font-weight:bold">chan</span> <span style="color:#6ab825;font-weight:bold">int</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#6ab825;font-weight:bold">go</span> <span style="color:#6ab825;font-weight:bold">func</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#6ab825;font-weight:bold">for</span> n := <span style="color:#6ab825;font-weight:bold">range</span> in {
</span></span><span style="display:flex;"><span>			<span style="color:#6ab825;font-weight:bold">if</span> <span style="color:#447fcf">isPrime</span>(n) {
</span></span><span style="display:flex;"><span>				out &lt;- n
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#24909d">close</span>(out)
</span></span><span style="display:flex;"><span>	}()
</span></span><span style="display:flex;"><span>	<span style="color:#6ab825;font-weight:bold">return</span> out
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">func</span> <span style="color:#447fcf">merge</span>(cs []&lt;-<span style="color:#6ab825;font-weight:bold">chan</span> <span style="color:#6ab825;font-weight:bold">int</span>) &lt;-<span style="color:#6ab825;font-weight:bold">chan</span> <span style="color:#6ab825;font-weight:bold">int</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#6ab825;font-weight:bold">var</span> wg sync.WaitGroup
</span></span><span style="display:flex;"><span>	out := <span style="color:#24909d">make</span>(<span style="color:#6ab825;font-weight:bold">chan</span> <span style="color:#6ab825;font-weight:bold">int</span>)
</span></span><span style="display:flex;"><span>	wg.<span style="color:#447fcf">Add</span>(<span style="color:#24909d">len</span>(cs))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6ab825;font-weight:bold">for</span> _, c := <span style="color:#6ab825;font-weight:bold">range</span> cs {
</span></span><span style="display:flex;"><span>		<span style="color:#6ab825;font-weight:bold">go</span> <span style="color:#6ab825;font-weight:bold">func</span>(c &lt;-<span style="color:#6ab825;font-weight:bold">chan</span> <span style="color:#6ab825;font-weight:bold">int</span>) {
</span></span><span style="display:flex;"><span>			<span style="color:#6ab825;font-weight:bold">for</span> n := <span style="color:#6ab825;font-weight:bold">range</span> c {
</span></span><span style="display:flex;"><span>				out &lt;- n
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			wg.<span style="color:#447fcf">Done</span>()
</span></span><span style="display:flex;"><span>		}(c)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6ab825;font-weight:bold">go</span> <span style="color:#6ab825;font-weight:bold">func</span>() {
</span></span><span style="display:flex;"><span>		wg.<span style="color:#447fcf">Wait</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#24909d">close</span>(out)
</span></span><span style="display:flex;"><span>	}()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6ab825;font-weight:bold">return</span> out
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">func</span> <span style="color:#447fcf">main</span>() {
</span></span><span style="display:flex;"><span>	nums := <span style="color:#447fcf">makeRange</span>(<span style="color:#3677a9">1</span>, <span style="color:#3677a9">10</span>)
</span></span><span style="display:flex;"><span>	in := <span style="color:#447fcf">echo</span>(nums)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#999;font-style:italic">// Fan-Out
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	<span style="color:#6ab825;font-weight:bold">var</span> cs [<span style="color:#3677a9">4</span>]&lt;-<span style="color:#6ab825;font-weight:bold">chan</span> <span style="color:#6ab825;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span>	<span style="color:#6ab825;font-weight:bold">for</span> i := <span style="color:#6ab825;font-weight:bold">range</span> cs {
</span></span><span style="display:flex;"><span>		cs[i] = <span style="color:#447fcf">sum</span>(<span style="color:#447fcf">prime</span>(in))
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#999;font-style:italic">// Fan-In
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	out := <span style="color:#447fcf">sum</span>(<span style="color:#447fcf">merge</span>(cs[:]))
</span></span><span style="display:flex;"><span>	<span style="color:#24909d">println</span>(&lt;-out)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	time.<span style="color:#447fcf">Sleep</span>(time.Second) <span style="color:#999;font-style:italic">// 等待 out 通道关闭
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>}
</span></span></code></pre></div><h2 id="pipeline">Pipeline</h2>
<p><code>管道 (pipeline)</code> 是由通道连接的一系列阶段，其中每个阶段都是一组运行相同功能的 <code>goroutine</code>，例如 <code>Linux</code> 中的管道命令:</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ps –ef | grep systemd | awk <span style="color:#ed9d13">&#39;{print $2}&#39;</span>
</span></span></code></pre></div><p><img src="https://dbwu.tech/images/pipeline.png" alt="图片来源: https://medium.com/@eric.g.yuan/go-concurrency-patterns-pipeline-2845d84bd92d"></p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">package</span> main
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">import</span> <span style="color:#ed9d13">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">func</span> <span style="color:#447fcf">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#999;font-style:italic">// 数值生成器管道
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	generator := <span style="color:#6ab825;font-weight:bold">func</span>(done &lt;-<span style="color:#6ab825;font-weight:bold">chan</span> <span style="color:#6ab825;font-weight:bold">int</span>, nums []<span style="color:#6ab825;font-weight:bold">int</span>) &lt;-<span style="color:#6ab825;font-weight:bold">chan</span> <span style="color:#6ab825;font-weight:bold">int</span> {
</span></span><span style="display:flex;"><span>		intStream := <span style="color:#24909d">make</span>(<span style="color:#6ab825;font-weight:bold">chan</span> <span style="color:#6ab825;font-weight:bold">int</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#6ab825;font-weight:bold">go</span> <span style="color:#6ab825;font-weight:bold">func</span>() {
</span></span><span style="display:flex;"><span>			<span style="color:#6ab825;font-weight:bold">defer</span> <span style="color:#24909d">close</span>(intStream)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#6ab825;font-weight:bold">for</span> _, n := <span style="color:#6ab825;font-weight:bold">range</span> nums {
</span></span><span style="display:flex;"><span>				<span style="color:#6ab825;font-weight:bold">select</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#6ab825;font-weight:bold">case</span> &lt;-done:
</span></span><span style="display:flex;"><span>					<span style="color:#6ab825;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>				<span style="color:#6ab825;font-weight:bold">case</span> intStream &lt;- n:
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#6ab825;font-weight:bold">return</span> intStream
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#999;font-style:italic">// 数值相乘管道
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	multiply := <span style="color:#6ab825;font-weight:bold">func</span>(done &lt;-<span style="color:#6ab825;font-weight:bold">chan</span> <span style="color:#6ab825;font-weight:bold">int</span>, intStream &lt;-<span style="color:#6ab825;font-weight:bold">chan</span> <span style="color:#6ab825;font-weight:bold">int</span>, multiplier <span style="color:#6ab825;font-weight:bold">int</span>) &lt;-<span style="color:#6ab825;font-weight:bold">chan</span> <span style="color:#6ab825;font-weight:bold">int</span> {
</span></span><span style="display:flex;"><span>		multiplyStream := <span style="color:#24909d">make</span>(<span style="color:#6ab825;font-weight:bold">chan</span> <span style="color:#6ab825;font-weight:bold">int</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#6ab825;font-weight:bold">go</span> <span style="color:#6ab825;font-weight:bold">func</span>() {
</span></span><span style="display:flex;"><span>			<span style="color:#6ab825;font-weight:bold">defer</span> <span style="color:#24909d">close</span>(multiplyStream)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#6ab825;font-weight:bold">for</span> i := <span style="color:#6ab825;font-weight:bold">range</span> intStream {
</span></span><span style="display:flex;"><span>				<span style="color:#6ab825;font-weight:bold">select</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#6ab825;font-weight:bold">case</span> &lt;-done:
</span></span><span style="display:flex;"><span>					<span style="color:#6ab825;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>				<span style="color:#6ab825;font-weight:bold">case</span> multiplyStream &lt;- i * multiplier:
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		}()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#6ab825;font-weight:bold">return</span> multiplyStream
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#999;font-style:italic">// 数值相加管道
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	add := <span style="color:#6ab825;font-weight:bold">func</span>(done &lt;-<span style="color:#6ab825;font-weight:bold">chan</span> <span style="color:#6ab825;font-weight:bold">int</span>, intStream &lt;-<span style="color:#6ab825;font-weight:bold">chan</span> <span style="color:#6ab825;font-weight:bold">int</span>, addition <span style="color:#6ab825;font-weight:bold">int</span>) &lt;-<span style="color:#6ab825;font-weight:bold">chan</span> <span style="color:#6ab825;font-weight:bold">int</span> {
</span></span><span style="display:flex;"><span>		addedStream := <span style="color:#24909d">make</span>(<span style="color:#6ab825;font-weight:bold">chan</span> <span style="color:#6ab825;font-weight:bold">int</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#6ab825;font-weight:bold">go</span> <span style="color:#6ab825;font-weight:bold">func</span>() {
</span></span><span style="display:flex;"><span>			<span style="color:#6ab825;font-weight:bold">defer</span> <span style="color:#24909d">close</span>(addedStream)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#6ab825;font-weight:bold">for</span> i := <span style="color:#6ab825;font-weight:bold">range</span> intStream {
</span></span><span style="display:flex;"><span>				<span style="color:#6ab825;font-weight:bold">select</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#6ab825;font-weight:bold">case</span> &lt;-done:
</span></span><span style="display:flex;"><span>					<span style="color:#6ab825;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>				<span style="color:#6ab825;font-weight:bold">case</span> addedStream &lt;- i + addition:
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		}()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#6ab825;font-weight:bold">return</span> addedStream
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	done := <span style="color:#24909d">make</span>(<span style="color:#6ab825;font-weight:bold">chan</span> <span style="color:#6ab825;font-weight:bold">int</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#6ab825;font-weight:bold">defer</span> <span style="color:#24909d">close</span>(done)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	intStream := <span style="color:#447fcf">generator</span>(done, []<span style="color:#6ab825;font-weight:bold">int</span>{<span style="color:#3677a9">1</span>, <span style="color:#3677a9">2</span>, <span style="color:#3677a9">3</span>})
</span></span><span style="display:flex;"><span>	<span style="color:#999;font-style:italic">// 执行了类似 Linux 中的管道命令: generator | multiply | add
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	pipeline := <span style="color:#447fcf">add</span>(done, <span style="color:#447fcf">multiply</span>(done, intStream, <span style="color:#3677a9">2</span>), <span style="color:#3677a9">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6ab825;font-weight:bold">for</span> p := <span style="color:#6ab825;font-weight:bold">range</span> pipeline {
</span></span><span style="display:flex;"><span>		fmt.<span style="color:#447fcf">Println</span>(p)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="generate">Generate</h2>
<p><code>生成者模式 (Generate)</code> 像 <code>yield</code> 一样，生成一系列连续的值。</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">package</span> main
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">func</span> <span style="color:#447fcf">Count</span>(start <span style="color:#6ab825;font-weight:bold">int</span>, end <span style="color:#6ab825;font-weight:bold">int</span>) <span style="color:#6ab825;font-weight:bold">chan</span> <span style="color:#6ab825;font-weight:bold">int</span> {
</span></span><span style="display:flex;"><span>    ch := <span style="color:#24909d">make</span>(<span style="color:#6ab825;font-weight:bold">chan</span> <span style="color:#6ab825;font-weight:bold">int</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">go</span> <span style="color:#6ab825;font-weight:bold">func</span>(ch <span style="color:#6ab825;font-weight:bold">chan</span> <span style="color:#6ab825;font-weight:bold">int</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#6ab825;font-weight:bold">for</span> i := start; i &lt;= end; i++ {
</span></span><span style="display:flex;"><span>            ch &lt;- i
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#24909d">close</span>(ch)
</span></span><span style="display:flex;"><span>	}(ch)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6ab825;font-weight:bold">return</span> ch
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">func</span> <span style="color:#447fcf">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#6ab825;font-weight:bold">for</span> i := <span style="color:#6ab825;font-weight:bold">range</span> <span style="color:#447fcf">Count</span>(<span style="color:#3677a9">1</span>, <span style="color:#3677a9">5</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#24909d">println</span>(i)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic">// $ go run main.go
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic">// 1
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic">// 2
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic">// 3
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic">// 4
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic">// 5
</span></span></span></code></pre></div><h2 id="生产者消费者">生产者/消费者</h2>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">package</span> main
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">import</span> <span style="color:#ed9d13">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic">// 生产者
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span><span style="color:#6ab825;font-weight:bold">func</span> <span style="color:#447fcf">produce</span>(start, count <span style="color:#6ab825;font-weight:bold">int</span>, out <span style="color:#6ab825;font-weight:bold">chan</span>&lt;- <span style="color:#6ab825;font-weight:bold">int</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#6ab825;font-weight:bold">for</span> i := <span style="color:#3677a9">0</span>; i &lt; count; i++ {
</span></span><span style="display:flex;"><span>		out &lt;- start
</span></span><span style="display:flex;"><span>		start = start + count
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#24909d">close</span>(out)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic">// 消费者
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span><span style="color:#6ab825;font-weight:bold">func</span> <span style="color:#447fcf">consume</span>(in &lt;-<span style="color:#6ab825;font-weight:bold">chan</span> <span style="color:#6ab825;font-weight:bold">int</span>, done <span style="color:#6ab825;font-weight:bold">chan</span>&lt;- <span style="color:#6ab825;font-weight:bold">bool</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#6ab825;font-weight:bold">for</span> num := <span style="color:#6ab825;font-weight:bold">range</span> in {
</span></span><span style="display:flex;"><span>		fmt.<span style="color:#447fcf">Printf</span>(<span style="color:#ed9d13">&#34;%d\n&#34;</span>, num)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	done &lt;- <span style="color:#6ab825;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">func</span> <span style="color:#447fcf">main</span>() {
</span></span><span style="display:flex;"><span>	numChan := <span style="color:#24909d">make</span>(<span style="color:#6ab825;font-weight:bold">chan</span> <span style="color:#6ab825;font-weight:bold">int</span>)
</span></span><span style="display:flex;"><span>	done := <span style="color:#24909d">make</span>(<span style="color:#6ab825;font-weight:bold">chan</span> <span style="color:#6ab825;font-weight:bold">bool</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#6ab825;font-weight:bold">go</span> <span style="color:#447fcf">produce</span>(<span style="color:#3677a9">0</span>, <span style="color:#3677a9">10</span>, numChan)
</span></span><span style="display:flex;"><span>	<span style="color:#6ab825;font-weight:bold">go</span> <span style="color:#447fcf">consume</span>(numChan, done)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	&lt;-done
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic">// $ go run ma1in.go
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic">// 输出如下
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic">// 0
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic">// 10
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic">// 20
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic">// 30
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic">// 40
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic">// 50
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic">// 60
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic">// 70
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic">// 80
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic">// 90
</span></span></span></code></pre></div><h2 id="信号量模式">信号量模式</h2>
<p><code>信号量</code> 是一种同步原语，对数量有限的资源的访问进行控制。</p>
<h3 id="接口">接口</h3>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">type</span> Interface <span style="color:#6ab825;font-weight:bold">interface</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#447fcf">Acquire</span>() <span style="color:#6ab825;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>	<span style="color:#447fcf">Release</span>() <span style="color:#6ab825;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="资源信号量">资源信号量</h3>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">package</span> main
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">var</span> (
</span></span><span style="display:flex;"><span>	ErrNoTickets      = errors.<span style="color:#447fcf">New</span>(<span style="color:#ed9d13">&#34;semaphore: could not aquire semaphore&#34;</span>)
</span></span><span style="display:flex;"><span>	ErrIllegalRelease = errors.<span style="color:#447fcf">New</span>(<span style="color:#ed9d13">&#34;semaphore: can&#39;t release the semaphore without acquiring it first&#34;</span>)
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">type</span> implementation <span style="color:#6ab825;font-weight:bold">struct</span> {
</span></span><span style="display:flex;"><span>	sem     <span style="color:#6ab825;font-weight:bold">chan</span> <span style="color:#6ab825;font-weight:bold">struct</span>{}
</span></span><span style="display:flex;"><span>	timeout time.Duration
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic">// Acquire 请求资源
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span><span style="color:#6ab825;font-weight:bold">func</span> (s *implementation) <span style="color:#447fcf">Acquire</span>() <span style="color:#6ab825;font-weight:bold">error</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#6ab825;font-weight:bold">select</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#6ab825;font-weight:bold">case</span> s.sem &lt;- <span style="color:#6ab825;font-weight:bold">struct</span>{}{}:
</span></span><span style="display:flex;"><span>		<span style="color:#6ab825;font-weight:bold">return</span> <span style="color:#6ab825;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#6ab825;font-weight:bold">case</span> &lt;-time.<span style="color:#447fcf">After</span>(s.timeout):
</span></span><span style="display:flex;"><span>		<span style="color:#6ab825;font-weight:bold">return</span> ErrNoTickets
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic">// Release 释放资源
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span><span style="color:#6ab825;font-weight:bold">func</span> (s *implementation) <span style="color:#447fcf">Release</span>() <span style="color:#6ab825;font-weight:bold">error</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#6ab825;font-weight:bold">select</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#6ab825;font-weight:bold">case</span> _ = &lt;-s.sem:
</span></span><span style="display:flex;"><span>		<span style="color:#6ab825;font-weight:bold">return</span> <span style="color:#6ab825;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#6ab825;font-weight:bold">case</span> &lt;-time.<span style="color:#447fcf">After</span>(s.timeout):
</span></span><span style="display:flex;"><span>		<span style="color:#6ab825;font-weight:bold">return</span> ErrIllegalRelease
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6ab825;font-weight:bold">return</span> <span style="color:#6ab825;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">func</span> <span style="color:#447fcf">New</span>(tickets <span style="color:#6ab825;font-weight:bold">int</span>, timeout time.Duration) Interface {
</span></span><span style="display:flex;"><span>	<span style="color:#6ab825;font-weight:bold">return</span> &amp;implementation{
</span></span><span style="display:flex;"><span>		sem:     <span style="color:#24909d">make</span>(<span style="color:#6ab825;font-weight:bold">chan</span> <span style="color:#6ab825;font-weight:bold">struct</span>{}, tickets),
</span></span><span style="display:flex;"><span>		timeout: timeout,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="超时信号">超时信号</h3>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>tickets, timeout := <span style="color:#3677a9">1</span>, <span style="color:#3677a9">3</span>*time.Second
</span></span><span style="display:flex;"><span>s := semaphore.<span style="color:#447fcf">New</span>(tickets, timeout)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">if</span> err := s.<span style="color:#447fcf">Acquire</span>(); err != <span style="color:#6ab825;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#24909d">panic</span>(err)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic">// do something
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">if</span> err := s.<span style="color:#447fcf">Release</span>(); err != <span style="color:#6ab825;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#24909d">panic</span>(err)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="无超时信号-非阻塞">无超时信号 (非阻塞)</h3>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>tickets, timeout := <span style="color:#3677a9">0</span>, <span style="color:#3677a9">0</span>
</span></span><span style="display:flex;"><span>s := semaphore.<span style="color:#447fcf">New</span>(tickets, timeout)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">if</span> err := s.<span style="color:#447fcf">Acquire</span>(); err != <span style="color:#6ab825;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">if</span> err != semaphore.ErrNoTickets {
</span></span><span style="display:flex;"><span>        <span style="color:#24909d">panic</span>(err)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>    os.<span style="color:#447fcf">Exit</span>(<span style="color:#3677a9">1</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="流式计算">流式计算</h2>
<p><img src="https://dbwu.tech/images/pi.png" alt="π 的计算公式"></p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">package</span> main
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#ed9d13">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ed9d13">&#34;math&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ed9d13">&#34;runtime&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">const</span> NCPU = <span style="color:#3677a9">2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">func</span> <span style="color:#447fcf">main</span>() {
</span></span><span style="display:flex;"><span>	runtime.<span style="color:#447fcf">GOMAXPROCS</span>(<span style="color:#3677a9">2</span>)
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#447fcf">Println</span>(<span style="color:#447fcf">CalculatePi</span>(<span style="color:#3677a9">5000</span>))
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">func</span> <span style="color:#447fcf">CalculatePi</span>(end <span style="color:#6ab825;font-weight:bold">int</span>) <span style="color:#6ab825;font-weight:bold">float64</span> {
</span></span><span style="display:flex;"><span>	ch := <span style="color:#24909d">make</span>(<span style="color:#6ab825;font-weight:bold">chan</span> <span style="color:#6ab825;font-weight:bold">float64</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6ab825;font-weight:bold">for</span> i := <span style="color:#3677a9">0</span>; i &lt; NCPU; i++ {
</span></span><span style="display:flex;"><span>		<span style="color:#999;font-style:italic">// 启动 2 个 goroutine
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>		<span style="color:#999;font-style:italic">// 1 个 goroutine 计算 k (0 -&gt; 2500)
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>		<span style="color:#999;font-style:italic">// 1 个 goroutine 计算 k (2500 -&gt; 5000)
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>		<span style="color:#6ab825;font-weight:bold">go</span> <span style="color:#447fcf">term</span>(ch, i*end/NCPU, (i+<span style="color:#3677a9">1</span>)*end/NCPU)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	result := <span style="color:#3677a9">0.0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#6ab825;font-weight:bold">for</span> i := <span style="color:#3677a9">0</span>; i &lt; NCPU; i++ {
</span></span><span style="display:flex;"><span>		result += &lt;-ch
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#6ab825;font-weight:bold">return</span> result
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic">// 计算公式展开式
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span><span style="color:#6ab825;font-weight:bold">func</span> <span style="color:#447fcf">term</span>(ch <span style="color:#6ab825;font-weight:bold">chan</span> <span style="color:#6ab825;font-weight:bold">float64</span>, start, end <span style="color:#6ab825;font-weight:bold">int</span>) {
</span></span><span style="display:flex;"><span>	result := <span style="color:#3677a9">0.0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#6ab825;font-weight:bold">for</span> i := start; i &lt; end; i++ {
</span></span><span style="display:flex;"><span>		x := <span style="color:#24909d">float64</span>(i)
</span></span><span style="display:flex;"><span>		result += <span style="color:#3677a9">4</span> * (math.<span style="color:#447fcf">Pow</span>(-<span style="color:#3677a9">1</span>, x) / (<span style="color:#3677a9">2.0</span>*x + <span style="color:#3677a9">1.0</span>))
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	ch &lt;- result
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic">// $ go run ma1in.go
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic">// 输出如下
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic">// 3.1413926535917938
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>*/
</span></span></code></pre></div><h2 id="简单-masterworker">简单 Master/Worker</h2>
<p>对于任何可以建模为 <code>Master-Worker</code> 的问题，各个 <code>Worker</code> 通道和 <code>Master</code> 通信，如果系统是分布式部署的，各个工作节点充当 <code>Worker</code>，
中央节点<code>Master</code> 和 <code>Worker</code> 之间使用 <code>RPC</code> 等协议进行通信。</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">package</span> main
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">func</span> <span style="color:#447fcf">main</span>() {
</span></span><span style="display:flex;"><span>    pending, done := <span style="color:#24909d">make</span>(<span style="color:#6ab825;font-weight:bold">chan</span> *Task), <span style="color:#24909d">make</span>(<span style="color:#6ab825;font-weight:bold">chan</span> *Task)
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">go</span> <span style="color:#447fcf">sendWork</span>(pending)       
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">for</span> i := <span style="color:#3677a9">0</span>; i &lt; N; i++ {   
</span></span><span style="display:flex;"><span>        <span style="color:#6ab825;font-weight:bold">go</span> <span style="color:#447fcf">Worker</span>(pending, done)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>    <span style="color:#447fcf">consumeWork</span>(done)          
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">func</span> <span style="color:#447fcf">Worker</span>(in, out <span style="color:#6ab825;font-weight:bold">chan</span> *Task) {
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">for</span> {
</span></span><span style="display:flex;"><span>        t := &lt;-in
</span></span><span style="display:flex;"><span>        <span style="color:#447fcf">process</span>(t)
</span></span><span style="display:flex;"><span>        out &lt;- t
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="futures-模式">Futures 模式</h2>
<p><code>Futures</code> 模式是指在使用某一个值之前需要先对其进行计算。这时可以在另一个 <code>goroutine</code> 进行该值的计算，到该值真正使用时就已经计算完毕了。
<code>Futures</code> 模式通过闭包和通道可以很容易实现，类似于生成器，不同地方在于 <code>Futures</code> 需要返回一个值。</p>
<p>假设我们有一个矩阵类型，我们需要计算两个矩阵 A 和 B 乘积的逆，首先我们通过函数 <code>Inverse(M)</code> 分别对其进行求逆运算，再将结果相乘。</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">func</span> <span style="color:#447fcf">InverseProduct</span>(a Matrix, b Matrix) {
</span></span><span style="display:flex;"><span>    a_inv_future := <span style="color:#447fcf">InverseFuture</span>(a)   
</span></span><span style="display:flex;"><span>    b_inv_future := <span style="color:#447fcf">InverseFuture</span>(b)   
</span></span><span style="display:flex;"><span>    a_inv := &lt;-a_inv_future
</span></span><span style="display:flex;"><span>    b_inv := &lt;-b_inv_future
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">return</span> <span style="color:#447fcf">Product</span>(a_inv, b_inv)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>InverseFuture</code> 函数以 <code>goroutine</code> 的形式起了一个闭包，该闭包会将矩阵求逆结果放入到 <code>future</code> 通道中：</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">func</span> <span style="color:#447fcf">InverseFuture</span>(a Matrix) <span style="color:#6ab825;font-weight:bold">chan</span> Matrix {
</span></span><span style="display:flex;"><span>    future := <span style="color:#24909d">make</span>(<span style="color:#6ab825;font-weight:bold">chan</span> Matrix)
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">go</span> <span style="color:#6ab825;font-weight:bold">func</span>() {
</span></span><span style="display:flex;"><span>        future &lt;- <span style="color:#447fcf">Inverse</span>(a)
</span></span><span style="display:flex;"><span>    }()
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">return</span> future
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>当开发一个计算密集型库时，使用 <code>Futures</code> 模式设计API接口是很有意义的。在你的包使用 <code>Futures</code> 模式，且能保持友好的 API 接口。
此外，<code>Futures</code> 可以通过一个异步的 API 暴露出来。这样就可以用最小的成本将包中的并行计算移到用户代码中。</p>
<h2 id="限制并发请求处理数量">限制并发请求处理数量</h2>
<p><strong>使用带缓冲区的通道很容易实现，其缓冲区容量就是同时处理请求的最大数量</strong>。程序中超过 <code>MAXREQS</code> 的请求将不会被同时处理，
因为当 <code>sem</code> 通道表示缓冲区已满时，<code>handle</code> 函数会阻塞且不再处理其他请求，直到某个请求从 <code>sem</code> 通道中被移除。</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">package</span> main
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">const</span> MAXREQS = <span style="color:#3677a9">50</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">var</span> sem = <span style="color:#24909d">make</span>(<span style="color:#6ab825;font-weight:bold">chan</span> <span style="color:#6ab825;font-weight:bold">int</span>, MAXREQS)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">type</span> Request <span style="color:#6ab825;font-weight:bold">struct</span> {
</span></span><span style="display:flex;"><span>    a, b   <span style="color:#6ab825;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span>    replyc <span style="color:#6ab825;font-weight:bold">chan</span> <span style="color:#6ab825;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">func</span> <span style="color:#447fcf">process</span>(r *Request) {
</span></span><span style="display:flex;"><span>    <span style="color:#999;font-style:italic">// do something
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic">// 一进一出，一来一回，很巧妙
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span><span style="color:#6ab825;font-weight:bold">func</span> <span style="color:#447fcf">handle</span>(r *Request) {
</span></span><span style="display:flex;"><span>    sem &lt;- <span style="color:#3677a9">1</span> <span style="color:#999;font-style:italic">// doesn&#39;t matter what we put in it
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>    <span style="color:#447fcf">process</span>(r)
</span></span><span style="display:flex;"><span>    &lt;-sem <span style="color:#999;font-style:italic">// one empty place in the buffer: the next request can start
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">func</span> <span style="color:#447fcf">server</span>(service <span style="color:#6ab825;font-weight:bold">chan</span> *Request) {
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">for</span> {
</span></span><span style="display:flex;"><span>        request := &lt;-service
</span></span><span style="display:flex;"><span>        <span style="color:#6ab825;font-weight:bold">go</span> <span style="color:#447fcf">handle</span>(request)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">func</span> <span style="color:#447fcf">main</span>() {
</span></span><span style="display:flex;"><span>    service := <span style="color:#24909d">make</span>(<span style="color:#6ab825;font-weight:bold">chan</span> *Request)
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">go</span> <span style="color:#447fcf">server</span>(service)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="状态模式">状态模式</h2>
<p>假设我们需要处理一些数量巨大且互不相关的数据项，它们从一个<code> in</code> 通道被传递进来，当我们处理完以后又要将它们放入另一个 <code>out</code> 通道，
就像一个工厂流水线一样。处理每个数据项也可能包含许多步骤：<code>Preprocess（预处理） / StepA（步骤A） / StepB（步骤B） / ... / PostProcess（后处理）</code>。</p>
<p>让每一个处理步骤作为一个 <code>goroutine</code> 独立工作，每一个步骤从上一步的输出通道中获得输入数据。
这种方式仅有极少数时间会被浪费，而大部分时间所有的步骤都在一直执行中。</p>
<p><strong>单纯从流程描述的话，很像设计模式里面的 “状态模式”，核心是下一个数据依赖于上一个数据处理完成，通道的缓冲区大小可以调整优化。</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">func</span> <span style="color:#447fcf">ParallelProcessData</span> (in &lt;-<span style="color:#6ab825;font-weight:bold">chan</span> *Data, out <span style="color:#6ab825;font-weight:bold">chan</span>&lt;- *Data) {
</span></span><span style="display:flex;"><span>    preOut := <span style="color:#24909d">make</span>(<span style="color:#6ab825;font-weight:bold">chan</span> *Data, <span style="color:#3677a9">100</span>)
</span></span><span style="display:flex;"><span>    stepAOut := <span style="color:#24909d">make</span>(<span style="color:#6ab825;font-weight:bold">chan</span> *Data, <span style="color:#3677a9">100</span>)
</span></span><span style="display:flex;"><span>    stepBOut := <span style="color:#24909d">make</span>(<span style="color:#6ab825;font-weight:bold">chan</span> *Data, <span style="color:#3677a9">100</span>)
</span></span><span style="display:flex;"><span>    stepCOut := <span style="color:#24909d">make</span>(<span style="color:#6ab825;font-weight:bold">chan</span> *Data, <span style="color:#3677a9">100</span>)
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">go</span> <span style="color:#447fcf">PreprocessData</span>(in, preOut)
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">go</span> <span style="color:#447fcf">ProcessStepA</span>(preOut,StepAOut)
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">go</span> <span style="color:#447fcf">ProcessStepB</span>(StepAOut,StepBOut)
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">go</span> <span style="color:#447fcf">ProcessStepC</span>(StepBOut,StepCOut)
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">go</span> <span style="color:#447fcf">PostProcessData</span>(StepCOut,out)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="链式调用">链式调用</h2>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">package</span> main
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic">// 反向执行过程很像递归
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span><span style="color:#6ab825;font-weight:bold">func</span> <span style="color:#447fcf">f</span>(left, right <span style="color:#6ab825;font-weight:bold">chan</span> <span style="color:#6ab825;font-weight:bold">int</span>) {
</span></span><span style="display:flex;"><span>	left &lt;- <span style="color:#3677a9">1</span> + &lt;-right
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">func</span> <span style="color:#447fcf">main</span>() {
</span></span><span style="display:flex;"><span>	leftmost := <span style="color:#24909d">make</span>(<span style="color:#6ab825;font-weight:bold">chan</span> <span style="color:#6ab825;font-weight:bold">int</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#6ab825;font-weight:bold">var</span> left, right <span style="color:#6ab825;font-weight:bold">chan</span> <span style="color:#6ab825;font-weight:bold">int</span> = <span style="color:#6ab825;font-weight:bold">nil</span>, leftmost
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6ab825;font-weight:bold">for</span> i := <span style="color:#3677a9">0</span>; i &lt; <span style="color:#3677a9">100000</span>; i++ {
</span></span><span style="display:flex;"><span>		left, right = right, <span style="color:#24909d">make</span>(<span style="color:#6ab825;font-weight:bold">chan</span> <span style="color:#6ab825;font-weight:bold">int</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#6ab825;font-weight:bold">go</span> <span style="color:#447fcf">f</span>(left, right)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	right &lt;- <span style="color:#3677a9">0</span>      <span style="color:#999;font-style:italic">// bang!
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	x := &lt;-leftmost <span style="color:#999;font-style:italic">// wait for completion
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	<span style="color:#24909d">println</span>(x)      <span style="color:#999;font-style:italic">// 100000
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>}
</span></span></code></pre></div><p>当循环完成之后，一个 0 被写入到 <code>最右边</code> 的通道里，于是 <code>100000</code> 个  <code>goroutine</code> 开始顺序执行。</p>
<h2 id="reference">Reference</h2>
<ul>
<li><a href="https://github.com/duanbiaowu/go-examples-for-beginners/tree/master/patterns/concurrency">Github Design-Patterns</a></li>
<li><a href="https://go.dev/talks/2012/concurrency.slide">Go Concurrency Patterns</a></li>
<li><a href="https://go.dev/blog/pipelines">Go Concurrency Patterns: Pipelines and cancellation</a></li>
<li><a href="https://divan.github.io/posts/go_concurrency_visualize/">Visualizing Concurrency in Go</a></li>
<li><a href="http://www.golangpatterns.info/">Go Language Patterns</a></li>
<li><a href="https://github.com/tmrts/go-patterns">tmrts/go-patterns</a></li>
<li><a href="https://book.douban.com/subject/26994591/">Concurrency in Go</a></li>
<li><a href="https://drive.google.com/file/d/1nPdvhB0PutEJzdCq5ms6UI58dp50fcAN/view">Rethinking Classical Concurrency Patterns</a></li>
<li><a href="https://blogtitle.github.io/categories/concurrency/">Go Concurrency</a></li>
<li><a href="https://www.cloudbees.com/blog/visualizing-concurrency-go">visualizing-concurrency-go</a></li>
<li><a href="https://book.douban.com/subject/24536403/">代码的未来</a></li>
</ul>


</article>

<article>
    <img src="https://dbwu.tech/images/wechat.png">
</article>

<article>
    <h3>转载申请</h3>

    <p>
        本作品采用 <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">知识共享署名 4.0 国际许可协议</a> 进行许可，转载时请注明原文链接，图片在使用时请保留全部内容，商业转载请联系作者获得授权。
    </p>
</article>

<section class="post-nav">
    <ul>
        <li>
        
            <a href="https://dbwu.tech/posts/golang_asm/"><i class="fa fa-chevron-circle-left"></i> Go 汇编</a>
        
        </li>
        <li>
        
            <a href="https://dbwu.tech/posts/golang_godebug/">GODEBUG <i class="fa fa-chevron-circle-right"></i> </a>
        
        </li>
    </ul>
</section>
  
    
    
  


<script src="https://giscus.app/client.js"
        data-repo="duanbiaowu/dbwu.tech"
        data-repo-id="R_kgDOIkkjjw"
        data-category="Announcements"
        data-category-id="DIC_kwDOIkkjj84CV78j"
        data-mapping="specific"
        data-term="Go 并发模式"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="1"
        data-input-position="top"
        data-theme="light"
        data-lang="zh-CN"
        crossorigin="anonymous" async>
</script>




</main>
    <footer>
        <ul>
            <li>
                <h6><a href="mailto:codean.net@gmail.com">codean.net@gmail.com</a> | 
                    <img src="https://dbwu.tech/images/%E5%A4%87%E6%A1%88%E5%9B%BE%E6%A0%87.png" />
                    <a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=61011302001681" target="_blank">陕公网安备 61011302001681 号</a> |
                    <a href="https://beian.miit.gov.cn" target="_blank">陕ICP备2023004378号-1</a> |
                    Rendered by <a href="https://themes.gohugo.io" title="Hugo" target="_blank">Hugo</a>
                </h6>
            </li>
            
            
        </ul>
    </footer>
</div>
<script src="https://dbwu.tech/js/scripts.js"></script>


</body>

</html>

