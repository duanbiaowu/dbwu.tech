<!doctype html>

<html lang="en">

<head>
  <title>GODEBUG - 蛮荆</title>
  <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="description" content="GODEBUG 环境变量可以控制程序运行时的调度信息输出，方便开发者了解程序运行内部细节。" />
<meta name="author" content="" />
<link rel="shortcut icon" href="https://dbwu.tech/favicon.ico" type="image/x-icon" /><meta property="og:title" content="GODEBUG" />
<meta property="og:description" content="GODEBUG 环境变量可以控制程序运行时的调度信息输出，方便开发者了解程序运行内部细节。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://dbwu.tech/posts/golang_godebug/" />
<meta property="article:published_time" content="2023-04-19T00:00:00+08:00" />
<meta property="article:modified_time" content="2023-04-19T00:00:00+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="GODEBUG"/>
<meta name="twitter:description" content="GODEBUG 环境变量可以控制程序运行时的调度信息输出，方便开发者了解程序运行内部细节。"/>

<meta name="generator" content="Hugo 0.68.3" />
    
    <script src="https://dbwu.tech/js/mathjax-config.js" defer></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-CZMGTTFLNY"></script>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3261056100776781" crossorigin="anonymous"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-CZMGTTFLNY');
  </script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js" integrity="sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js" integrity="sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa" crossorigin="anonymous"
        onload="renderMathInElement(document.body);"></script>


  <link rel="stylesheet" href="https://dbwu.tech/fontawesome/css/normalize.min.css" />
  <link rel="stylesheet" href="https://dbwu.tech/fontawesome/css/all.min.css" />
  
    
    <link href="//fonts.googleapis.com/css?family=Staatliches" rel="stylesheet">
  
  
  <link rel="stylesheet" type="text/css" href="https://dbwu.tech/css/styles-light.css" />
  </head>

<body>
  <div id="container">
    <header>
      
      <h1>
        <a href="https://dbwu.tech/">蛮荆</a>
      </h1>

      <ul id="social-media">
      </ul>
      
    </header>

    
<nav>
    <ul>
        
        <li>
            <a class="" href="https://dbwu.tech/posts/">
                <i class="fa-li fa  fa-lg"></i><span>归档</span>
            </a>
        </li>
        
        <li>
            <a class="" href="https://dbwu.tech/tags/">
                <i class="fa-li fa  fa-lg"></i><span>标签</span>
            </a>
        </li>
        
        <li>
            <a class="" href="https://github.com/duanbiaowu">
                <i class="fa-li fa  fa-lg"></i><span>Github</span>
            </a>
        </li>
        
        <li>
            <a class="" href="https://dbwu.tech/index.xml">
                <i class="fa-li fa  fa-lg"></i><span>RSS</span>
            </a>
        </li>
        
    </ul>
</nav>


    <main>




<article>

    <h1>GODEBUG</h1>

    
      
<li>
    
    
    <a href="https://dbwu.tech/tags/golang">Golang</a>
    
    
    <a href="https://dbwu.tech/tags/golang-%E8%B0%83%E8%AF%95">Golang 调试</a>
    
</li>

    

    
      

    

    <h2 id="简介">简介</h2>
<blockquote>
<p>GODEBUG 环境变量可以控制程序运行时的调度信息输出，方便开发者了解程序运行内部细节。</p>
</blockquote>
<p>语法是通过逗号分割多个键值对，例如:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#999;font-style:italic"># 运行 main.go, 每秒输出 1 次调度信息</span>
$ <span style="color:#40ffff">GODEBUG</span>=<span style="color:#40ffff">scheddetail</span>=1,schedtrace=<span style="color:#3677a9">1000</span> go run main.go
</code></pre></div><h2 id="常用参数">常用参数</h2>
<table>
<thead>
<tr>
<th>名称</th>
<th>  值  </th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>scheddetail</td>
<td>1</td>
<td>设置 schedtrace=X 和 scheddetail=1, 每 X 毫秒输出 1 次调度信息</td>
</tr>
<tr>
<td>schedtrace</td>
<td>X</td>
<td>每 X 毫秒输出 1 次调度信息</td>
</tr>
<tr>
<td>allocfreetrace</td>
<td>1</td>
<td>监控每次分配，分析和打印每个对象的分配和释放的调用堆栈</td>
</tr>
<tr>
<td>cgocheck</td>
<td>[0, 1, 2]</td>
<td>CGO 是否检查 Go 指针传递给非 Go 代码, 0: 禁用 1: 弱检查 2: 强检查</td>
</tr>
<tr>
<td>efence</td>
<td>1</td>
<td>让分配器把每个对象都分配在一个唯一的从未回收的页面</td>
</tr>
<tr>
<td>gccheckmark</td>
<td>1</td>
<td>启用 GC 执行并发标记</td>
</tr>
<tr>
<td>gcpacertrace</td>
<td>1</td>
<td>打印并发 pacer 的内部状态</td>
</tr>
<tr>
<td>gcshrinkstackoff</td>
<td>1</td>
<td>禁用移动 goroutines 到较小的栈上，在这种模式下，goroutine 的栈只能增长</td>
</tr>
<tr>
<td>gcstoptheworld</td>
<td>1</td>
<td>禁用并发 GC，每次 GC 都会触发 STW</td>
</tr>
<tr>
<td>gctrace</td>
<td>1</td>
<td>每次 GC 时输出一行日志，统计内存回收和暂停时间</td>
</tr>
<tr>
<td>memprofilerate</td>
<td>[0, X]</td>
<td>0: 禁用 X: 更新 runtime.MemProfileRate 的值</td>
</tr>
</tbody>
</table>
<h2 id="示例程序">示例程序</h2>
<p>本文后面的几个用例，全部使用该程序演示。</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#6ab825;font-weight:bold">package</span> main

<span style="color:#6ab825;font-weight:bold">import</span> (
	<span style="color:#ed9d13">&#34;sync&#34;</span>
	<span style="color:#ed9d13">&#34;time&#34;</span>
)

<span style="color:#6ab825;font-weight:bold">func</span> <span style="color:#447fcf">main</span>() {
	<span style="color:#6ab825;font-weight:bold">var</span> wg sync.WaitGroup

	<span style="color:#6ab825;font-weight:bold">for</span> i := <span style="color:#3677a9">0</span>; i &lt; <span style="color:#3677a9">10</span>; i++ {
		wg.<span style="color:#447fcf">Add</span>(<span style="color:#3677a9">1</span>)

		<span style="color:#6ab825;font-weight:bold">go</span> <span style="color:#6ab825;font-weight:bold">func</span>() {
			<span style="color:#6ab825;font-weight:bold">defer</span> wg.<span style="color:#447fcf">Done</span>()

			time.<span style="color:#447fcf">Sleep</span>(<span style="color:#3677a9">1</span> * time.Second)
		}()
	}

	wg.<span style="color:#447fcf">Wait</span>()
}
</code></pre></div><h2 id="输出调度基础信息">输出调度基础信息</h2>
<h3 id="执行命令">执行命令</h3>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ <span style="color:#40ffff">GODEBUG</span>=<span style="color:#40ffff">schedtrace</span>=<span style="color:#3677a9">1000</span> go run main.go

<span style="color:#999;font-style:italic"># 输出如下</span>
SCHED 0ms: <span style="color:#40ffff">gomaxprocs</span>=<span style="color:#3677a9">8</span> <span style="color:#40ffff">idleprocs</span>=<span style="color:#3677a9">6</span> <span style="color:#40ffff">threads</span>=<span style="color:#3677a9">5</span> <span style="color:#40ffff">spinningthreads</span>=<span style="color:#3677a9">1</span> <span style="color:#40ffff">idlethreads</span>=<span style="color:#3677a9">0</span> <span style="color:#40ffff">runqueue</span>=<span style="color:#3677a9">0</span> [<span style="color:#3677a9">1</span> <span style="color:#3677a9">0</span> <span style="color:#3677a9">0</span> <span style="color:#3677a9">0</span> <span style="color:#3677a9">0</span> <span style="color:#3677a9">0</span> <span style="color:#3677a9">0</span> 0]

...

SCHED 0ms: <span style="color:#40ffff">gomaxprocs</span>=<span style="color:#3677a9">8</span> <span style="color:#40ffff">idleprocs</span>=<span style="color:#3677a9">6</span> <span style="color:#40ffff">threads</span>=<span style="color:#3677a9">5</span> <span style="color:#40ffff">spinningthreads</span>=<span style="color:#3677a9">1</span> <span style="color:#40ffff">idlethreads</span>=<span style="color:#3677a9">2</span> <span style="color:#40ffff">runqueue</span>=<span style="color:#3677a9">0</span> [<span style="color:#3677a9">0</span> <span style="color:#3677a9">0</span> <span style="color:#3677a9">0</span> <span style="color:#3677a9">0</span> <span style="color:#3677a9">0</span> <span style="color:#3677a9">0</span> <span style="color:#3677a9">0</span> 0]
SCHED 0ms: <span style="color:#40ffff">gomaxprocs</span>=<span style="color:#3677a9">8</span> <span style="color:#40ffff">idleprocs</span>=<span style="color:#3677a9">6</span> <span style="color:#40ffff">threads</span>=<span style="color:#3677a9">5</span> <span style="color:#40ffff">spinningthreads</span>=<span style="color:#3677a9">1</span> <span style="color:#40ffff">idlethreads</span>=<span style="color:#3677a9">2</span> <span style="color:#40ffff">runqueue</span>=<span style="color:#3677a9">0</span> [<span style="color:#3677a9">9</span> <span style="color:#3677a9">0</span> <span style="color:#3677a9">0</span> <span style="color:#3677a9">0</span> <span style="color:#3677a9">0</span> <span style="color:#3677a9">0</span> <span style="color:#3677a9">0</span> 0]
SCHED 1007ms: <span style="color:#40ffff">gomaxprocs</span>=<span style="color:#3677a9">8</span> <span style="color:#40ffff">idleprocs</span>=<span style="color:#3677a9">8</span> <span style="color:#40ffff">threads</span>=<span style="color:#3677a9">13</span> <span style="color:#40ffff">spinningthreads</span>=<span style="color:#3677a9">0</span> <span style="color:#40ffff">idlethreads</span>=<span style="color:#3677a9">6</span> <span style="color:#40ffff">runqueue</span>=<span style="color:#3677a9">0</span> [<span style="color:#3677a9">0</span> <span style="color:#3677a9">0</span> <span style="color:#3677a9">0</span> <span style="color:#3677a9">0</span> <span style="color:#3677a9">0</span> <span style="color:#3677a9">0</span> <span style="color:#3677a9">0</span> 0]
</code></pre></div><h3 id="输出结果说明">输出结果说明</h3>
<table>
<thead>
<tr>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>SCHED</td>
<td>标志字符串，代表 goroutine 调度器</td>
</tr>
<tr>
<td>0ms</td>
<td>从程序启动到输出这行日志的时间</td>
</tr>
<tr>
<td>gomaxprocs</td>
<td>P 的数量，(默认的 P 和 CPU 核心数量一致</td>
</tr>
<tr>
<td>idleprocs</td>
<td>空闲状态的 P 的数量</td>
</tr>
<tr>
<td>threads</td>
<td>线程数量</td>
</tr>
<tr>
<td>spinningthreads</td>
<td>自旋状态的线程数量</td>
</tr>
<tr>
<td>idlethread</td>
<td>空闲状态的线程数量</td>
</tr>
<tr>
<td>runqueue</td>
<td>全局队列中 G 的数量</td>
</tr>
<tr>
<td>[0 &hellip; 0]</td>
<td>每个 P 的本地队列中 G 的数量</td>
</tr>
</tbody>
</table>
<h2 id="输出-gc-时内存示例">输出 GC 时内存示例</h2>
<h3 id="执行命令-1">执行命令</h3>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ <span style="color:#40ffff">GODEBUG</span>=<span style="color:#40ffff">gctrace</span>=<span style="color:#3677a9">1</span> go run main.go

<span style="color:#999;font-style:italic"># 输出如下</span>
gc <span style="color:#3677a9">1</span> @0.028s 1%: 0.058+1.1+0.19 ms clock, 0.46+0/1.0/0.36+1.5 ms cpu, 3-&gt;4-&gt;0 MB, <span style="color:#3677a9">4</span> MB goal, <span style="color:#3677a9">0</span> MB stacks, <span style="color:#3677a9">0</span> MB globals, <span style="color:#3677a9">8</span> P
gc <span style="color:#3677a9">2</span> @0.034s 1%: 0.083+0.63+0.005 ms clock, 0.66+0.094/0.51/0.27+0.044 ms cpu, 3-&gt;3-&gt;0 MB, <span style="color:#3677a9">4</span> MB goal, <span style="color:#3677a9">0</span> MB stacks, <span style="color:#3677a9">0</span> MB globals, <span style="color:#3677a9">8</span> P
gc <span style="color:#3677a9">3</span> @0.039s 1%: 0.031+0.66+0.042 ms clock, 0.25+0.091/0.49/0.39+0.34 ms cpu, 3-&gt;4-&gt;0 MB, <span style="color:#3677a9">4</span> MB goal, <span style="color:#3677a9">0</span> MB stacks, <span style="color:#3677a9">0</span> MB globals, <span style="color:#3677a9">8</span> P
gc <span style="color:#3677a9">4</span> @0.043s 2%: 0.027+0.70+0.14 ms clock, 0.22+0.039/0.50/0.34+1.1 ms cpu, 3-&gt;3-&gt;0 MB, <span style="color:#3677a9">4</span> MB goal, <span style="color:#3677a9">0</span> MB stacks, <span style="color:#3677a9">0</span> MB globals, <span style="color:#3677a9">8</span> P

...

gc <span style="color:#3677a9">1</span> @0.002s 4%: 0.012+0.78+0.005 ms clock, 0.098+0.49/0.58/0.32+0.040 ms cpu, 4-&gt;6-&gt;5 MB, <span style="color:#3677a9">4</span> MB goal, <span style="color:#3677a9">0</span> MB stacks, <span style="color:#3677a9">0</span> MB globals, <span style="color:#3677a9">8</span> P
gc <span style="color:#3677a9">2</span> @0.015s 2%: 0.016+1.3+0.034 ms clock, 0.12+0.022/1.1/0.90+0.27 ms cpu, 9-&gt;9-&gt;7 MB, <span style="color:#3677a9">10</span> MB goal, <span style="color:#3677a9">0</span> MB stacks, <span style="color:#3677a9">0</span> MB globals, <span style="color:#3677a9">8</span> P
</code></pre></div><h3 id="输出结果说明-1">输出结果说明</h3>
<table>
<thead>
<tr>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>gc</td>
<td>GC 次数编号，每次 GC 时递增</td>
</tr>
<tr>
<td>@#s</td>
<td>距离程序开始执行的时间</td>
</tr>
<tr>
<td>#%</td>
<td>GC 执行占用的时间百分比</td>
</tr>
<tr>
<td>#ms</td>
<td>GC 使用的时间</td>
</tr>
<tr>
<td>#MB</td>
<td>GC 开始前，结束时，当前正在被使用堆内存的大小</td>
</tr>
<tr>
<td>MB goal</td>
<td>下一次触发 GC 的堆大小</td>
</tr>
<tr>
<td>MB stacks</td>
<td>估计扫描栈大小</td>
</tr>
<tr>
<td>MB global</td>
<td>可扫描的全局大小</td>
</tr>
<tr>
<td>#P</td>
<td>P 的数量</td>
</tr>
</tbody>
</table>
<p>下面以最后一行输出为例进行说明：</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">gc <span style="color:#3677a9">2</span> @0.015s 2%: 0.016+1.3+0.034 ms clock, 0.12+0.022/1.1/0.90+0.27 ms cpu, 9-&gt;9-&gt;7 MB, <span style="color:#3677a9">10</span> MB goal, <span style="color:#3677a9">0</span> MB stacks, <span style="color:#3677a9">0</span> MB globals, <span style="color:#3677a9">8</span> P
</code></pre></div><table>
<thead>
<tr>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>gc 17</td>
<td>GC 编号为 2</td>
</tr>
<tr>
<td>@0.015s</td>
<td>程序已经执行了 0.015s</td>
</tr>
<tr>
<td>2%</td>
<td>GC 执行占用的时间为 1%</td>
</tr>
<tr>
<td>0.016+1.3+0.034 ms clock</td>
<td>GC 使用时间，分别为 STW 清扫的时间 + 并发标记和扫描的时间 + STW 标记的时间</td>
</tr>
<tr>
<td>0.12+0.022/1.1/0.90+0.27 ms cpu</td>
<td>GC 占用 CPU 时间</td>
</tr>
<tr>
<td>9-&gt;9-&gt;7 MB</td>
<td>GC 开始前堆内存 9 M， 结束时堆内存 9 M，当前正在被使用堆内存 7 M</td>
</tr>
<tr>
<td>10 MB goal</td>
<td>下一次触发 GC 的堆大小为 10M</td>
</tr>
<tr>
<td>8 P</td>
<td>P 的数量为 8 个</td>
</tr>
</tbody>
</table>
<h2 id="输出调度完整信息">输出调度完整信息</h2>
<h3 id="执行命令-2">执行命令</h3>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ <span style="color:#40ffff">GODEBUG</span>=<span style="color:#40ffff">scheddetail</span>=1,schedtrace=<span style="color:#3677a9">1000</span> go run main.go

<span style="color:#999;font-style:italic"># 输出如下</span>
SCHED 0ms: <span style="color:#40ffff">gomaxprocs</span>=<span style="color:#3677a9">8</span> <span style="color:#40ffff">idleprocs</span>=<span style="color:#3677a9">6</span> <span style="color:#40ffff">threads</span>=<span style="color:#3677a9">6</span> <span style="color:#40ffff">spinningthreads</span>=<span style="color:#3677a9">1</span> <span style="color:#40ffff">idlethreads</span>=<span style="color:#3677a9">2</span> <span style="color:#40ffff">runqueue</span>=<span style="color:#3677a9">0</span> <span style="color:#40ffff">gcwaiting</span>=<span style="color:#3677a9">0</span> <span style="color:#40ffff">nmidlelocked</span>=<span style="color:#3677a9">0</span> <span style="color:#40ffff">stopwait</span>=<span style="color:#3677a9">0</span> <span style="color:#40ffff">sysmonwait</span>=<span style="color:#3677a9">0</span>
  P0: <span style="color:#40ffff">status</span>=<span style="color:#3677a9">1</span> <span style="color:#40ffff">schedtick</span>=<span style="color:#3677a9">1</span> <span style="color:#40ffff">syscalltick</span>=<span style="color:#3677a9">0</span> <span style="color:#40ffff">m</span>=<span style="color:#3677a9">0</span> <span style="color:#40ffff">runqsize</span>=<span style="color:#3677a9">0</span> <span style="color:#40ffff">gfreecnt</span>=<span style="color:#3677a9">0</span> <span style="color:#40ffff">timerslen</span>=<span style="color:#3677a9">0</span>
  P1: <span style="color:#40ffff">status</span>=<span style="color:#3677a9">0</span> <span style="color:#40ffff">schedtick</span>=<span style="color:#3677a9">2</span> <span style="color:#40ffff">syscalltick</span>=<span style="color:#3677a9">0</span> <span style="color:#40ffff">m</span>=-1 <span style="color:#40ffff">runqsize</span>=<span style="color:#3677a9">0</span> <span style="color:#40ffff">gfreecnt</span>=<span style="color:#3677a9">0</span> <span style="color:#40ffff">timerslen</span>=<span style="color:#3677a9">0</span>
  
...

  P7: <span style="color:#40ffff">status</span>=<span style="color:#3677a9">0</span> <span style="color:#40ffff">schedtick</span>=<span style="color:#3677a9">0</span> <span style="color:#40ffff">syscalltick</span>=<span style="color:#3677a9">0</span> <span style="color:#40ffff">m</span>=-1 <span style="color:#40ffff">runqsize</span>=<span style="color:#3677a9">0</span> <span style="color:#40ffff">gfreecnt</span>=<span style="color:#3677a9">0</span> <span style="color:#40ffff">timerslen</span>=<span style="color:#3677a9">0</span>
  M5: <span style="color:#40ffff">p</span>=<span style="color:#3677a9">2</span> <span style="color:#40ffff">curg</span>=-1 <span style="color:#40ffff">mallocing</span>=<span style="color:#3677a9">0</span> <span style="color:#40ffff">throwing</span>=<span style="color:#3677a9">0</span> <span style="color:#40ffff">preemptoff</span>= <span style="color:#40ffff">locks</span>=<span style="color:#3677a9">1</span> <span style="color:#40ffff">dying</span>=<span style="color:#3677a9">0</span> <span style="color:#40ffff">spinning</span>=<span style="color:#24909d">true</span> <span style="color:#40ffff">blocked</span>=<span style="color:#24909d">false</span> <span style="color:#40ffff">lockedg</span>=-1
  
...

  M0: <span style="color:#40ffff">p</span>=<span style="color:#3677a9">0</span> <span style="color:#40ffff">curg</span>=<span style="color:#3677a9">1</span> <span style="color:#40ffff">mallocing</span>=<span style="color:#3677a9">0</span> <span style="color:#40ffff">throwing</span>=<span style="color:#3677a9">0</span> <span style="color:#40ffff">preemptoff</span>= <span style="color:#40ffff">locks</span>=<span style="color:#3677a9">5</span> <span style="color:#40ffff">dying</span>=<span style="color:#3677a9">0</span> <span style="color:#40ffff">spinning</span>=<span style="color:#24909d">false</span> <span style="color:#40ffff">blocked</span>=<span style="color:#24909d">false</span> <span style="color:#40ffff">lockedg</span>=<span style="color:#3677a9">1</span>
  G1: <span style="color:#40ffff">status</span>=2(chan receive) <span style="color:#40ffff">m</span>=<span style="color:#3677a9">0</span> <span style="color:#40ffff">lockedm</span>=<span style="color:#3677a9">0</span>
  
...

  G4: <span style="color:#40ffff">status</span>=4(GC scavenge <span style="color:#24909d">wait</span>) <span style="color:#40ffff">m</span>=-1 <span style="color:#40ffff">lockedm</span>=-1

...

SCHED 1008ms: <span style="color:#40ffff">gomaxprocs</span>=<span style="color:#3677a9">8</span> <span style="color:#40ffff">idleprocs</span>=<span style="color:#3677a9">8</span> <span style="color:#40ffff">threads</span>=<span style="color:#3677a9">14</span> <span style="color:#40ffff">spinningthreads</span>=<span style="color:#3677a9">0</span> <span style="color:#40ffff">idlethreads</span>=<span style="color:#3677a9">7</span> <span style="color:#40ffff">runqueue</span>=<span style="color:#3677a9">0</span> <span style="color:#40ffff">gcwaiting</span>=<span style="color:#3677a9">0</span> <span style="color:#40ffff">nmidlelocked</span>=<span style="color:#3677a9">1</span> <span style="color:#40ffff">stopwait</span>=<span style="color:#3677a9">0</span> <span style="color:#40ffff">sysmonwait</span>=<span style="color:#3677a9">0</span>
  P0: <span style="color:#40ffff">status</span>=<span style="color:#3677a9">0</span> <span style="color:#40ffff">schedtick</span>=<span style="color:#3677a9">262</span> <span style="color:#40ffff">syscalltick</span>=<span style="color:#3677a9">826</span> <span style="color:#40ffff">m</span>=-1 <span style="color:#40ffff">runqsize</span>=<span style="color:#3677a9">0</span> <span style="color:#40ffff">gfreecnt</span>=<span style="color:#3677a9">0</span> <span style="color:#40ffff">timerslen</span>=<span style="color:#3677a9">0</span>

...

  P7: <span style="color:#40ffff">status</span>=<span style="color:#3677a9">0</span> <span style="color:#40ffff">schedtick</span>=<span style="color:#3677a9">17</span> <span style="color:#40ffff">syscalltick</span>=<span style="color:#3677a9">307</span> <span style="color:#40ffff">m</span>=-1 <span style="color:#40ffff">runqsize</span>=<span style="color:#3677a9">0</span> <span style="color:#40ffff">gfreecnt</span>=<span style="color:#3677a9">3</span> <span style="color:#40ffff">timerslen</span>=<span style="color:#3677a9">0</span>
  M13: <span style="color:#40ffff">p</span>=-1 <span style="color:#40ffff">curg</span>=-1 <span style="color:#40ffff">mallocing</span>=<span style="color:#3677a9">0</span> <span style="color:#40ffff">throwing</span>=<span style="color:#3677a9">0</span> <span style="color:#40ffff">preemptoff</span>= <span style="color:#40ffff">locks</span>=<span style="color:#3677a9">0</span> <span style="color:#40ffff">dying</span>=<span style="color:#3677a9">0</span> <span style="color:#40ffff">spinning</span>=<span style="color:#24909d">false</span> <span style="color:#40ffff">blocked</span>=<span style="color:#24909d">true</span> <span style="color:#40ffff">lockedg</span>=-1

...

  M0: <span style="color:#40ffff">p</span>=-1 <span style="color:#40ffff">curg</span>=-1 <span style="color:#40ffff">mallocing</span>=<span style="color:#3677a9">0</span> <span style="color:#40ffff">throwing</span>=<span style="color:#3677a9">0</span> <span style="color:#40ffff">preemptoff</span>= <span style="color:#40ffff">locks</span>=<span style="color:#3677a9">0</span> <span style="color:#40ffff">dying</span>=<span style="color:#3677a9">0</span> <span style="color:#40ffff">spinning</span>=<span style="color:#24909d">false</span> <span style="color:#40ffff">blocked</span>=<span style="color:#24909d">true</span> <span style="color:#40ffff">lockedg</span>=-1
  G1: <span style="color:#40ffff">status</span>=4(semacquire) <span style="color:#40ffff">m</span>=-1 <span style="color:#40ffff">lockedm</span>=-1
  G17: <span style="color:#40ffff">status</span>=6() <span style="color:#40ffff">m</span>=<span style="color:#3677a9">1</span> <span style="color:#40ffff">lockedm</span>=<span style="color:#3677a9">1</span>
  G2: <span style="color:#40ffff">status</span>=4(force gc (idle)) <span style="color:#40ffff">m</span>=-1 <span style="color:#40ffff">lockedm</span>=-1
  G3: <span style="color:#40ffff">status</span>=4(GC sweep <span style="color:#24909d">wait</span>) <span style="color:#40ffff">m</span>=-1 <span style="color:#40ffff">lockedm</span>=-1
  G4: <span style="color:#40ffff">status</span>=4(sleep) <span style="color:#40ffff">m</span>=-1 <span style="color:#40ffff">lockedm</span>=-1
  G5: <span style="color:#40ffff">status</span>=4(finalizer <span style="color:#24909d">wait</span>) <span style="color:#40ffff">m</span>=-1 <span style="color:#40ffff">lockedm</span>=-1
  G12: <span style="color:#40ffff">status</span>=6() <span style="color:#40ffff">m</span>=-1 <span style="color:#40ffff">lockedm</span>=-1
  G22: <span style="color:#40ffff">status</span>=6() <span style="color:#40ffff">m</span>=-1 <span style="color:#40ffff">lockedm</span>=-1
  G10: <span style="color:#40ffff">status</span>=4(GC worker (idle)) <span style="color:#40ffff">m</span>=-1 <span style="color:#40ffff">lockedm</span>=-1

...

  G78: <span style="color:#40ffff">status</span>=4(<span style="color:#6ab825;font-weight:bold">select</span>) <span style="color:#40ffff">m</span>=-1 <span style="color:#40ffff">lockedm</span>=<span style="color:#3677a9">10</span>
  G146: <span style="color:#40ffff">status</span>=4(chan receive) <span style="color:#40ffff">m</span>=-1 <span style="color:#40ffff">lockedm</span>=-1
</code></pre></div><h3 id="输出结果说明-2">输出结果说明</h3>
<p><strong><code>P</code> 的相关输出说明</strong>，以下面这行输出为例:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">P0: <span style="color:#40ffff">status</span>=<span style="color:#3677a9">1</span> <span style="color:#40ffff">schedtick</span>=<span style="color:#3677a9">1</span> <span style="color:#40ffff">syscalltick</span>=<span style="color:#3677a9">0</span> <span style="color:#40ffff">m</span>=<span style="color:#3677a9">0</span> <span style="color:#40ffff">runqsize</span>=<span style="color:#3677a9">0</span> <span style="color:#40ffff">gfreecnt</span>=<span style="color:#3677a9">0</span> <span style="color:#40ffff">timerslen</span>=<span style="color:#3677a9">0</span>
</code></pre></div><table>
<thead>
<tr>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>P0</td>
<td>编号</td>
</tr>
<tr>
<td>status</td>
<td>状态</td>
</tr>
<tr>
<td>schedtick</td>
<td>调度次数</td>
</tr>
<tr>
<td>syscalltick</td>
<td>系统调用次数</td>
</tr>
<tr>
<td>m</td>
<td>关联的 M</td>
</tr>
<tr>
<td>runqsize</td>
<td>运行队列中 G 的数量</td>
</tr>
<tr>
<td>gfreecnt</td>
<td>可用的 G 的数量</td>
</tr>
<tr>
<td>timerslen</td>
<td>关联的定时器数量</td>
</tr>
</tbody>
</table>
<p><strong><code>P</code> 的状态列表</strong></p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#6ab825;font-weight:bold">const</span> (
	<span style="color:#999;font-style:italic">// 处理器没有在执行代码或者调度，位于空闲列表或者被可以改变其状态的结构持有
</span><span style="color:#999;font-style:italic"></span>	_Pidle = <span style="color:#6ab825;font-weight:bold">iota</span>
	
	<span style="color:#999;font-style:italic">// 处理器被线程 M 持有，并且正在执行代码或者调度
</span><span style="color:#999;font-style:italic"></span>	_Prunning
	
	<span style="color:#999;font-style:italic">// 处理器没有在执行代码，线程陷入系统调用
</span><span style="color:#999;font-style:italic"></span>	_Psyscall
	
	<span style="color:#999;font-style:italic">// 处理器被线程 M 持有，由于 GC 被停止
</span><span style="color:#999;font-style:italic"></span>	_Pgcstop
	
	<span style="color:#999;font-style:italic">// 处理器不再被使用
</span><span style="color:#999;font-style:italic"></span>	_Pdead
)
</code></pre></div><hr>
<p><strong><code>M</code> 的相关输出说明</strong>，以下面这行输出为例:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">M0: <span style="color:#40ffff">p</span>=<span style="color:#3677a9">0</span> <span style="color:#40ffff">curg</span>=<span style="color:#3677a9">1</span> <span style="color:#40ffff">mallocing</span>=<span style="color:#3677a9">0</span> <span style="color:#40ffff">throwing</span>=<span style="color:#3677a9">0</span> <span style="color:#40ffff">preemptoff</span>= <span style="color:#40ffff">locks</span>=<span style="color:#3677a9">5</span> <span style="color:#40ffff">dying</span>=<span style="color:#3677a9">0</span> <span style="color:#40ffff">spinning</span>=<span style="color:#24909d">false</span> <span style="color:#40ffff">blocked</span>=<span style="color:#24909d">false</span> <span style="color:#40ffff">lockedg</span>=<span style="color:#3677a9">1</span>
</code></pre></div><table>
<thead>
<tr>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>M0</td>
<td>编号</td>
</tr>
<tr>
<td>p</td>
<td>关联的 P</td>
</tr>
<tr>
<td>curg</td>
<td>当前运行的 G</td>
</tr>
<tr>
<td>mallocing</td>
<td>是否正在分配内存</td>
</tr>
<tr>
<td>throwing</td>
<td>是否抛出异常</td>
</tr>
<tr>
<td>preemptoff</td>
<td>是否和当前运行的 G 绑定</td>
</tr>
<tr>
<td>locks</td>
<td>锁</td>
</tr>
<tr>
<td>dying</td>
<td>销毁状态</td>
</tr>
<tr>
<td>spinning</td>
<td>是否正在自旋</td>
</tr>
<tr>
<td>blocked</td>
<td>是否阻塞</td>
</tr>
</tbody>
</table>
<hr>
<p><strong><code>G</code> 的相关输出说明</strong>，以下面这行输出为例:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">G1: <span style="color:#40ffff">status</span>=2(chan receive) <span style="color:#40ffff">m</span>=<span style="color:#3677a9">0</span> <span style="color:#40ffff">lockedm</span>=<span style="color:#3677a9">0</span>
</code></pre></div><table>
<thead>
<tr>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>G1</td>
<td>编号</td>
</tr>
<tr>
<td>status</td>
<td>状态</td>
</tr>
<tr>
<td>m</td>
<td>关联的 M</td>
</tr>
</tbody>
</table>
<p><strong><code>G</code> 的状态列表</strong></p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#6ab825;font-weight:bold">const</span> (
	<span style="color:#999;font-style:italic">// goroutine 刚被分配并且还没有被初始化
</span><span style="color:#999;font-style:italic"></span>    _Gidle = <span style="color:#6ab825;font-weight:bold">iota</span> <span style="color:#999;font-style:italic">// 0
</span><span style="color:#999;font-style:italic"></span>
	<span style="color:#999;font-style:italic">// goroutine 处于运行队列中，没有在执行代码，没有栈的所有权
</span><span style="color:#999;font-style:italic"></span>	_Grunnable <span style="color:#999;font-style:italic">// 1
</span><span style="color:#999;font-style:italic"></span>
	<span style="color:#999;font-style:italic">// goroutine 可以执行代码并且拥有有栈的所有权，M 和 P 已经设置并且有效
</span><span style="color:#999;font-style:italic"></span>	_Grunning <span style="color:#999;font-style:italic">// 2
</span><span style="color:#999;font-style:italic"></span>
	<span style="color:#999;font-style:italic">// goroutine 正在执行系统调用，没有在执行代码，拥有栈的所有权但是不在运行队列中，此外，M 已经设置
</span><span style="color:#999;font-style:italic"></span>	_Gsyscall <span style="color:#999;font-style:italic">// 3
</span><span style="color:#999;font-style:italic"></span>
	<span style="color:#999;font-style:italic">// goroutine 处于阻塞中，没有在执行代码并且不在运行队列中，但是可能存在于 Channel 的等待队列上
</span><span style="color:#999;font-style:italic"></span>	_Gwaiting <span style="color:#999;font-style:italic">// 4
</span><span style="color:#999;font-style:italic"></span>
	<span style="color:#999;font-style:italic">// 没有使用这个状态，但是被硬编码到了 gbd 脚本中
</span><span style="color:#999;font-style:italic"></span>	_Gmoribund_unused <span style="color:#999;font-style:italic">// 5
</span><span style="color:#999;font-style:italic"></span>
	<span style="color:#999;font-style:italic">// goroutine 没有被使用 (可能已经退出或刚刚初始化)，没有在执行代码，可能存在分配的栈
</span><span style="color:#999;font-style:italic"></span>	_Gdead <span style="color:#999;font-style:italic">// 6
</span><span style="color:#999;font-style:italic"></span>
	<span style="color:#999;font-style:italic">// 没有使用这个状态
</span><span style="color:#999;font-style:italic"></span>	_Genqueue_unused <span style="color:#999;font-style:italic">// 7
</span><span style="color:#999;font-style:italic"></span>
	<span style="color:#999;font-style:italic">// goroutine 的栈正在被移动，没有在执行代码并且不在运行队列中
</span><span style="color:#999;font-style:italic"></span>	_Gcopystack <span style="color:#999;font-style:italic">// 8
</span><span style="color:#999;font-style:italic"></span>
	<span style="color:#999;font-style:italic">// goroutine 由于抢占而阻塞，等待唤醒
</span><span style="color:#999;font-style:italic"></span>	_Gpreempted <span style="color:#999;font-style:italic">// 9
</span><span style="color:#999;font-style:italic"></span>
	<span style="color:#999;font-style:italic">// GC 正在扫描栈空间，没有在执行代码，可以与上述其他状态同时存在
</span><span style="color:#999;font-style:italic"></span>	_Gscan          = <span style="color:#3677a9">0x1000</span>
)
</code></pre></div><h2 id="可视化">可视化</h2>
<p>国外的大佬 <code>Dave Cheney</code> 开发了一个工具，可以实时可视化 <code>GC trace</code> 数据，项目地址 <a href="https://github.com/davecheney/gcvis">在这里</a>。</p>
<p><img src="https://dbwu.tech/images/gcvis.png" alt="图片来源: https://dave.cheney.net/2014/07/11/visualising-the-go-garbage-collector"></p>
<h2 id="reference">Reference</h2>
<ul>
<li><a href="hacking.md">Go Hacking.md</a></li>
<li><a href="https://pkg.go.dev/runtime">runtime</a></li>
<li><a href="https://github.com/golang/go/wiki/Performance#scheduler-trace">scheduler-trace</a></li>
<li><a href="https://ydkgo.netlify.app/docs/profiling/godebug/readme/">GODEBUG</a></li>
<li><a href="https://pkg.go.dev/runtime#hdr-Environment_Variables">Go Environment Variables</a></li>
<li><a href="https://www.ardanlabs.com/blog/2015/02/scheduler-tracing-in-go.html">Scheduler Tracing In Go</a></li>
</ul>


</article>

<article>
    <img src="https://dbwu.tech/images/wechat.png">
</article>

<article>
    <h3>转载申请</h3>

    <p>
        本作品采用 <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">知识共享署名 4.0 国际许可协议</a> 进行许可，转载时请注明原文链接，图片在使用时请保留全部内容，商业转载请联系作者获得授权。
    </p>
</article>

<section class="post-nav">
    <ul>
        <li>
        
            <a href="https://dbwu.tech/posts/golang_concurrency_patterns/"><i class="fa fa-chevron-circle-left"></i> Go 并发模式</a>
        
        </li>
        <li>
        
            <a href="https://dbwu.tech/posts/goroutine_alternate_print/">goroutine 交替打印奇偶数 <i class="fa fa-chevron-circle-right"></i> </a>
        
        </li>
    </ul>
</section>
  
    
    
  


<script src="https://giscus.app/client.js"
        data-repo="duanbiaowu/dbwu.tech"
        data-repo-id="R_kgDOIkkjjw"
        data-category="Announcements"
        data-category-id="DIC_kwDOIkkjj84CV78j"
        data-mapping="specific"
        data-term="GODEBUG"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="1"
        data-input-position="top"
        data-theme="light"
        data-lang="zh-CN"
        crossorigin="anonymous" async>
</script>




</main>
    <footer>
        <ul>
            <li>
                <h6><a href="mailto:codean.net@gmail.com">codean.net@gmail.com</a> | 
                    <img src="https://dbwu.tech/images/%E5%A4%87%E6%A1%88%E5%9B%BE%E6%A0%87.png" />
                    <a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=61011302001681" target="_blank">陕公网安备 61011302001681 号</a> |
                    <a href="https://beian.miit.gov.cn" target="_blank">陕ICP备2023004378号-1</a> |
                    Rendered by <a href="https://themes.gohugo.io" title="Hugo" target="_blank">Hugo</a>
                </h6>
            </li>
            
            
        </ul>
    </footer>
</div>
<script src="https://dbwu.tech/js/scripts.js"></script>


</body>

</html>

