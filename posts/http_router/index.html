<!doctype html>

<html lang="en">

<head>
  <title>HTTP Router ç®—æ³•æ¼”è¿› - è›®è†</title>
  <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="description" content="" />
<meta name="author" content="" />
<link rel="shortcut icon" href="https://dbwu.tech/favicon.ico" type="image/x-icon" /><meta property="og:title" content="HTTP Router ç®—æ³•æ¼”è¿›" />
<meta property="og:description" content="" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://dbwu.tech/posts/http_router/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-07-13T00:00:00+00:00" />
<meta property="article:modified_time" content="2023-07-13T00:00:00+00:00" />


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="HTTP Router ç®—æ³•æ¼”è¿›"/>
<meta name="twitter:description" content=""/>

<meta name="generator" content="Hugo 0.120.3">
    
    <script src="https://dbwu.tech/js/mathjax-config.js" defer></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-CZMGTTFLNY"></script>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3261056100776781" crossorigin="anonymous"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-CZMGTTFLNY');
  </script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js" integrity="sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js" integrity="sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa" crossorigin="anonymous"
        onload="renderMathInElement(document.body);"></script>


  <link rel="stylesheet" href="https://dbwu.tech/fontawesome/css/normalize.min.css" />
  <link rel="stylesheet" href="https://dbwu.tech/fontawesome/css/all.min.css" />
  
    
    <link href="//fonts.googleapis.com/css?family=Staatliches" rel="stylesheet">
  
  
  <link rel="stylesheet" type="text/css" href="https://dbwu.tech/css/styles-light.css" />
  </head>

<body>
  <div id="container">
    <header>
      
      <h1>
        <a href="https://dbwu.tech/">è›®è†</a>
      </h1>

      <ul id="social-media">
      </ul>
      
    </header>

    
<nav>
    <ul>
        
        <li>
            <a class="active" href="https://dbwu.tech/posts/">
                <i class="fa-li fa  fa-lg"></i><span>å½’æ¡£</span>
            </a>
        </li>
        
        <li>
            <a class="" href="https://dbwu.tech/tags/">
                <i class="fa-li fa  fa-lg"></i><span>æ ‡ç­¾</span>
            </a>
        </li>
        
        <li>
            <a class="" href="https://github.com/duanbiaowu">
                <i class="fa-li fa  fa-lg"></i><span>Github</span>
            </a>
        </li>
        
        <li>
            <a class="" href="https://dbwu.tech/index.xml">
                <i class="fa-li fa  fa-lg"></i><span>RSS</span>
            </a>
        </li>
        
    </ul>
</nav>


    <main>




<article>

    <h1>HTTP Router ç®—æ³•æ¼”è¿›</h1>

    
      
<p>
    <span>2023-07-13</span>
    
    
    <a class="article-tag" href="https://dbwu.tech/tags/%E7%AE%97%E6%B3%95">ç®—æ³•</a>
    
    
    <a class="article-tag" href="https://dbwu.tech/tags/trie-tree">Trie Tree</a>
    
    
    <a class="article-tag" href="https://dbwu.tech/tags/radix-tree">Radix Tree</a>
    
    
    <a class="article-tag" href="https://dbwu.tech/tags/go-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90">Go æºç åˆ†æ</a>
    
    
    <a class="article-tag" href="https://dbwu.tech/tags/%E8%AF%BB%E4%BB%A3%E7%A0%81">è¯»ä»£ç </a>
    
</p>

    

    
      

    

    <h2 id="æ¦‚è¿°">æ¦‚è¿°</h2>
<p>æœ¬æ–‡ä»å¼€å‘ä¸­å¸¸è§çš„åº”ç”¨åœºæ™¯ â€œè·¯ç”±ç®¡ç†â€ ä¸ºä¾‹ï¼Œä»‹ç»ä¸‰ç§å¸¸ç”¨çš„å®ç°æ–¹æ¡ˆèƒŒåçš„æ•°æ®ç»“æ„å’Œç®—æ³• (ä»£ç å®ç°ä¸º Go è¯­è¨€)ã€‚</p>
<h2 id="åº”ç”¨ç¤ºä¾‹">åº”ç”¨ç¤ºä¾‹</h2>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ªå…¸å‹çš„ REST é£æ ¼çš„ API åˆ—è¡¨:</p>
<table>
<thead>
<tr>
<th>Method</th>
<th>URL</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td>/users/list</td>
</tr>
<tr>
<td>GET</td>
<td>/users/dbwu</td>
</tr>
<tr>
<td>POST</td>
<td>/users</td>
</tr>
<tr>
<td>PUT</td>
<td>/users/dbwu</td>
</tr>
<tr>
<td>DELETE</td>
<td>/users/dbwu</td>
</tr>
</tbody>
</table>
<p>ä¸Šé¢çš„ API ç¿»è¯‘ä¸º Go ä»£ç ï¼Œå¤§è‡´å¦‚ä¸‹ (å¿½ç•¥æ–¹æ³•çš„å…·ä½“å®ç°):</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">package</span> main
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#ed9d13">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ed9d13">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">func</span> <span style="color:#447fcf">main</span>() {
</span></span><span style="display:flex;"><span>	http.<span style="color:#447fcf">HandleFunc</span>(<span style="color:#ed9d13">&#34;/users/list&#34;</span>, <span style="color:#6ab825;font-weight:bold">nil</span>)
</span></span><span style="display:flex;"><span>	http.<span style="color:#447fcf">HandleFunc</span>(<span style="color:#ed9d13">&#34;/users/dbwu&#34;</span>, <span style="color:#6ab825;font-weight:bold">nil</span>)
</span></span><span style="display:flex;"><span>	http.<span style="color:#447fcf">HandleFunc</span>(<span style="color:#ed9d13">&#34;/users&#34;</span>, <span style="color:#6ab825;font-weight:bold">nil</span>)
</span></span><span style="display:flex;"><span>	http.<span style="color:#447fcf">HandleFunc</span>(<span style="color:#ed9d13">&#34;/users/dbwu&#34;</span>, <span style="color:#6ab825;font-weight:bold">nil</span>)
</span></span><span style="display:flex;"><span>	http.<span style="color:#447fcf">HandleFunc</span>(<span style="color:#ed9d13">&#34;/users/dbwu&#34;</span>, <span style="color:#6ab825;font-weight:bold">nil</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	log.<span style="color:#447fcf">Fatal</span>(http.<span style="color:#447fcf">ListenAndServe</span>(<span style="color:#ed9d13">&#34;:8080&#34;</span>, <span style="color:#6ab825;font-weight:bold">nil</span>))
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="æ ‡å‡†åº“æ–¹æ¡ˆ">æ ‡å‡†åº“æ–¹æ¡ˆ</h2>
<p>æœ€ç®€å•çš„æ–¹æ¡ˆå°±æ˜¯ç›´æ¥ä½¿ç”¨ <code>map[string]func()</code> ä½œä¸ºè·¯ç”±çš„æ•°æ®ç»“æ„ï¼Œé”®ä¸ºå…·ä½“çš„è·¯ç”±ï¼Œå€¼ä¸ºå…·ä½“çš„å¤„ç†æ–¹æ³•ã€‚</p>
<p>æ ‡å‡†åº“ä¸­ä½¿ç”¨çš„å°±æ˜¯è¿™ç§æ–¹æ¡ˆï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•è¿½è¸ªä¸€ä¸‹å¯¹åº”çš„ä»£ç :</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#999;font-style:italic">// è·¯ç”±ç®¡ç†æ•°æ®ç»“æ„
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">type</span> ServeMux <span style="color:#6ab825;font-weight:bold">struct</span> {
</span></span><span style="display:flex;"><span>	mu    sync.RWMutex          <span style="color:#999;font-style:italic">// å¯¹è±¡æ“ä½œè¯»å†™é”
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	m     <span style="color:#6ab825;font-weight:bold">map</span>[<span style="color:#6ab825;font-weight:bold">string</span>]muxEntry   <span style="color:#999;font-style:italic">// å­˜å‚¨è·¯ç”±æ˜ å°„å…³ç³»
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>}
</span></span></code></pre></div><p>æ–¹æ³•ä» http.HandleFunc æ–¹æ³•å¼€å§‹è¿½è¸ª:</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#999;font-style:italic">// æ³¨å†Œè·¯ç”±å¤„ç†æ–¹æ³•
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span><span style="color:#6ab825;font-weight:bold">func</span> <span style="color:#447fcf">HandleFunc</span>(pattern <span style="color:#6ab825;font-weight:bold">string</span>, handler <span style="color:#6ab825;font-weight:bold">func</span>(ResponseWriter, *Request)) {
</span></span><span style="display:flex;"><span>	DefaultServeMux.<span style="color:#447fcf">HandleFunc</span>(pattern, handler)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">func</span> (mux *ServeMux) <span style="color:#447fcf">HandleFunc</span>(pattern <span style="color:#6ab825;font-weight:bold">string</span>, handler <span style="color:#6ab825;font-weight:bold">func</span>(ResponseWriter, *Request)) {
</span></span><span style="display:flex;"><span>	mux.<span style="color:#447fcf">Handle</span>(pattern, <span style="color:#447fcf">HandlerFunc</span>(handler))
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">func</span> (mux *ServeMux) <span style="color:#447fcf">Handle</span>(pattern <span style="color:#6ab825;font-weight:bold">string</span>, handler Handler) {
</span></span><span style="display:flex;"><span>	mux.mu.<span style="color:#447fcf">Lock</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#6ab825;font-weight:bold">defer</span> mux.mu.<span style="color:#447fcf">Unlock</span>()
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	...
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#6ab825;font-weight:bold">if</span> _, exist := mux.m[pattern]; exist {
</span></span><span style="display:flex;"><span>		<span style="color:#999;font-style:italic">// å¦‚æœæ³¨å†Œçš„ URL é‡å¤äº†ï¼ŒæŠ›å‡º panic
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>		<span style="color:#24909d">panic</span>(<span style="color:#ed9d13">&#34;http: multiple registrations for &#34;</span> + pattern)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6ab825;font-weight:bold">if</span> mux.m == <span style="color:#6ab825;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#999;font-style:italic">// æƒ°æ€§åˆå§‹åŒ–
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>		mux.m = <span style="color:#24909d">make</span>(<span style="color:#6ab825;font-weight:bold">map</span>[<span style="color:#6ab825;font-weight:bold">string</span>]muxEntry)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#999;font-style:italic">// æ³¨å†Œå®Œæˆ
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	e := muxEntry{h: handler, pattern: pattern}
</span></span><span style="display:flex;"><span>	mux.m[pattern] = e
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>	...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="ä¼˜ç‚¹å’Œä¸è¶³">ä¼˜ç‚¹å’Œä¸è¶³</h3>
<p>ä½¿ç”¨ <code>map[string]func()</code> ä½œä¸ºè·¯ç”±çš„æ•°æ®ç»“æ„ï¼Œæœ€æ˜æ˜¾çš„ä¼˜ç‚¹å°±æ˜¯:</p>
<ol>
<li>å®ç°ç®€å•: map æ˜¯æ ‡å‡†åº“å†…ç½®çš„æ•°æ®ç»“æ„ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨å¹¶ä¸”ä»£ç å¯è¯»æ€§é«˜</li>
<li>æ€§èƒ½è¾ƒé«˜: å› ä¸ºè·¯ç”±å†™å…¥æ“ä½œåªä¼šå‘ç”Ÿä¸€æ¬¡ (æ³¨å†Œæ—¶)ï¼Œåç»­çš„æ“ä½œå…¨éƒ¨æ˜¯è¯»å–æ“ä½œï¼ŒåŸºäºæ ‡å‡†åº“çš„ map æ€§èƒ½å·²ç»è¶³å¤Ÿä¼˜ç§€</li>
</ol>
<p>åŒæ—¶ï¼Œè¯¥æ–¹æ¡ˆçš„ä¸è¶³ä¹Ÿæ˜¯æ˜¾è€Œæ˜“è§çš„:</p>
<ol>
<li>å†…å­˜æµªè´¹: å³ä½¿å­˜åœ¨å¾ˆå¤šå‰ç¼€ç›¸åŒçš„è·¯å¾„ (ä¾‹å¦‚ /users, /users/list, /users/dbwu, ä¸‰ä¸ªè·¯å¾„çš„å‰ç¼€éƒ½æ˜¯ /users, è¿™éƒ¨åˆ†æ˜¯å¯ä»¥å¤ç”¨çš„)ï¼Œmap ç»“æ„è¿˜æ˜¯ä¼šæ¯ä¸ªè·¯å¾„å•ç‹¬æ˜ å°„ï¼Œæµªè´¹å¤§é‡çš„å†…å­˜</li>
<li>ä¸å¤Ÿçµæ´»: éš¾ä»¥å¤„ç†åŠ¨æ€è·¯ç”±å’Œæ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ç­‰å¤æ‚çš„è·¯å¾„ (ä¾‹å¦‚ /users/:id æˆ– /users/{id:[0-9]+})</li>
<li>æ— æ³•å¤„ç†é‡å¤è·¯å¾„ï¼šå¦‚æœå¤šä¸ªå¤„ç†æ–¹æ³•ç»‘å®šåˆ°ç›¸åŒçš„è·¯å¾„ä¸Š (ä¾‹å¦‚ GET /users å’Œ POST /users)ï¼Œmap åªèƒ½å­˜å‚¨ä¸€ä¸ªé”®å€¼å¯¹ï¼Œä¹Ÿå°±æ˜¯åªæœ‰æœ€åä¸€ä¸ªæ³¨å†Œçš„å¤„ç†å‡½æ•°ä¼šè¢«è°ƒç”¨</li>
<li>ä¸æ”¯æŒä¸­é—´ä»¶ï¼šmap ç»“æ„ä¸æ”¯æŒä¸­é—´ä»¶ï¼Œè¿™åœ¨ç°ä»£ Web å¼€å‘ä¸­å‡ ä¹æ˜¯ä¸å¯æ¥å—çš„</li>
</ol>
<p>åŸºäºä»¥ä¸Šç‰¹ç‚¹ï¼Œåœ¨çœŸå®çš„é¡¹ç›®å¼€å‘ä¸­ä¸ä¼šä½¿ç”¨ <code>map[string]func()</code> ä½œä¸ºè·¯ç”±çš„å®ç°æ•°æ®ç»“æ„ã€‚</p>
<h2 id="trie-tree">Trie Tree</h2>
<blockquote>
<p>Trie Tree ä¹Ÿç§°ä¸ºå­—å…¸æ ‘æˆ–å‰ç¼€æ ‘ï¼Œæ˜¯ä¸€ç§ç”¨äºé«˜æ•ˆå­˜å‚¨å’Œæ£€ç´¢ã€ç”¨äºä»æŸä¸ªé›†åˆä¸­æŸ¥åˆ°æŸä¸ªç‰¹å®š key çš„æ•°æ®ç»“æ„ã€‚
è¿™äº› key é€šå¸¸æ˜¯å­—ç¬¦ä¸²ï¼ŒèŠ‚ç‚¹ä¹‹é—´çš„çˆ¶å­å…³ç³»ä¸æ˜¯ç”±æ•´ä¸ª key å®šä¹‰ï¼Œè€Œæ˜¯ç”± key ä¸­çš„å•ä¸ªå­—ç¬¦å®šä¹‰ã€‚
å¯¹æŸä¸ª key å¯¹åº”çš„å…ƒç´ è¿›è¡Œç›¸å…³æ“ä½œ (å†™å…¥ã€æ›´æ–°ã€åˆ é™¤) å°±æ˜¯ä¸€æ¬¡ DFS (æ·±åº¦ä¼˜å…ˆéå†) è¿‡ç¨‹ã€‚</p>
</blockquote>
<h3 id="ç®—æ³•å¤æ‚åº¦">ç®—æ³•å¤æ‚åº¦</h3>
<ul>
<li>N: å­—ç¬¦ä¸²çš„æ•°é‡</li>
<li>M: å­—ç¬¦ä¸²çš„å¹³å‡é•¿åº¦</li>
<li>L: å­—ç¬¦ä¸²çš„é•¿åº¦</li>
</ul>
<table>
<thead>
<tr>
<th>ç©ºé—´å¤æ‚åº¦</th>
</tr>
</thead>
<tbody>
<tr>
<td>O(NM)</td>
</tr>
</tbody>
</table>
<p>Â </p>
<table>
<thead>
<tr>
<th>æ“ä½œ</th>
<th>æ—¶é—´å¤æ‚åº¦</th>
</tr>
</thead>
<tbody>
<tr>
<td>æ’å…¥</td>
<td>O(L)</td>
</tr>
<tr>
<td>æŸ¥æ‰¾</td>
<td>O(L)</td>
</tr>
<tr>
<td>åˆ é™¤</td>
<td>O(L)</td>
</tr>
</tbody>
</table>
<blockquote>
<p>Trie Tree çš„æ ¸å¿ƒæ€æƒ³æ˜¯ç©ºé—´æ¢æ—¶é—´ï¼Œåˆ©ç”¨å­—ç¬¦ä¸²çš„å…¬å…±å‰ç¼€æ¥å‡å°‘å­—ç¬¦æ¯”è¾ƒæ“ä½œï¼Œæå‡æŸ¥è¯¢æ•ˆç‡ã€‚</p>
</blockquote>
<h3 id="å›¾ç¤º">å›¾ç¤º</h3>
<p><img src="https://dbwu.tech/images/trie12.jpeg" alt="å›¾ç‰‡æ¥æº: https://theoryofprogramming.wordpress.com/2015/01/16/trie-tree-implementation/"></p>
<p>å¦‚å›¾æ‰€ç¤ºï¼Œæ˜¯ä¸€ä¸ªå…¸å‹çš„ Trie Tree, å…¶ä¸­åŒ…å«äº†å¦‚ä¸‹å…ƒç´ :</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#ed9d13">&#34;their&#34;</span>, <span style="color:#ed9d13">&#34;there&#34;</span>, <span style="color:#ed9d13">&#34;this&#34;</span>, <span style="color:#ed9d13">&#34;that&#34;</span>, <span style="color:#ed9d13">&#34;does&#34;</span>, <span style="color:#ed9d13">&#34;did&#34;</span>
</span></span></code></pre></div><p>æœ¬æ–‡ä¸å†æè¿°ç®—æ³•çš„å…·ä½“æ“ä½œè¿‡ç¨‹äº†ï¼Œè¯»è€…å¯ä»¥é€šè¿‡ä»£ç æ¥æ„Ÿå—ä¸€ä¸‹ï¼Œå¦‚æœå¸Œæœ›æŠ“ä½ç»†èŠ‚ï¼Œå¯ä»¥é˜…è¯»ç»´åŸºç™¾ç§‘çš„ä»‹ç»ï¼Œ
æˆ–è€…é€šè¿‡ <a href="https://www.cs.usfca.edu/~galles/visualization/Trie.html">è¿™ä¸ªå¯è§†åŒ–åœ¨çº¿å·¥å…·</a> æ¥æ‰‹åŠ¨æ“ä½œä½“éªŒã€‚</p>
<h3 id="å®ç°ä»£ç ">å®ç°ä»£ç </h3>
<p>é¦–å…ˆå†™ä¸€ä¸ªåŸºç¡€ç‰ˆçš„ Trie Tree ä»£ç ï¼Œå¯¹ç®—æ³•æœ¬èº«åšä¸€ä¸ªåˆæ­¥è®¤è¯†ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">package</span> trie
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic">// Trie Tree èŠ‚ç‚¹
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span><span style="color:#6ab825;font-weight:bold">type</span> Trie <span style="color:#6ab825;font-weight:bold">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#999;font-style:italic">// æ ‡è®°å½“å‰èŠ‚ç‚¹æ˜¯å¦ä¸ºæœ‰æ•ˆçš„è·¯ç”±
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	<span style="color:#999;font-style:italic">// ä¾‹å¦‚æ·»åŠ äº†è·¯ç”± /users
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	<span style="color:#999;font-style:italic">// é‚£ä¹ˆ /user, /usr ä¸èƒ½ç®—ä½œæœ‰æ•ˆçš„è·¯ç”±
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	<span style="color:#999;font-style:italic">// ä¹Ÿå°±æ˜¯åªæœ‰å­—ç¬¦ &#34;s&#34; èŠ‚ç‚¹çš„ IsPath å­—æ®µä¸º true
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	IsPath <span style="color:#6ab825;font-weight:bold">bool</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#999;font-style:italic">// å½“å‰èŠ‚ç‚¹çš„å­èŠ‚ç‚¹
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	Children <span style="color:#6ab825;font-weight:bold">map</span>[<span style="color:#6ab825;font-weight:bold">byte</span>]*Trie
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">func</span> <span style="color:#447fcf">New</span>() Trie {
</span></span><span style="display:flex;"><span>	<span style="color:#6ab825;font-weight:bold">return</span> Trie{<span style="color:#6ab825;font-weight:bold">false</span>, <span style="color:#24909d">make</span>(<span style="color:#6ab825;font-weight:bold">map</span>[<span style="color:#6ab825;font-weight:bold">byte</span>]*Trie)}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic">// Add æ·»åŠ ä¸€ä¸ªè·¯ç”±åˆ° Trie Tree
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span><span style="color:#6ab825;font-weight:bold">func</span> (t *Trie) <span style="color:#447fcf">Add</span>(path <span style="color:#6ab825;font-weight:bold">string</span>) {
</span></span><span style="display:flex;"><span>	parent := t
</span></span><span style="display:flex;"><span>	<span style="color:#999;font-style:italic">// é€ä¸ª byte åŠ å…¥åˆ° Trie Tree
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	<span style="color:#6ab825;font-weight:bold">for</span> i := <span style="color:#6ab825;font-weight:bold">range</span> path {
</span></span><span style="display:flex;"><span>		<span style="color:#6ab825;font-weight:bold">if</span> child, ok := parent.Children[path[i]]; ok {
</span></span><span style="display:flex;"><span>			<span style="color:#999;font-style:italic">// å¦‚æœå­èŠ‚ç‚¹ä¸ä¸ºç©ºï¼Œç»§ç»­å‘ä¸‹éå†
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>			parent = child
</span></span><span style="display:flex;"><span>		} <span style="color:#6ab825;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#999;font-style:italic">// å¦‚æœå­èŠ‚ç‚¹ä¸ºç©ºï¼Œæ„é€ æ–°çš„èŠ‚ç‚¹
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>			newChild := &amp;Trie{<span style="color:#6ab825;font-weight:bold">false</span>, <span style="color:#24909d">make</span>(<span style="color:#6ab825;font-weight:bold">map</span>[<span style="color:#6ab825;font-weight:bold">byte</span>]*Trie)}
</span></span><span style="display:flex;"><span>			parent.Children[path[i]] = newChild
</span></span><span style="display:flex;"><span>			parent = newChild
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#999;font-style:italic">// æ›´æ–°å½“å‰è·¯ç”±çš„å¶å­èŠ‚ç‚¹çš„ IsPath å­—æ®µ
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	parent.IsPath = <span style="color:#6ab825;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic">// Find è¿”å›æŒ‡å®šè·¯ç”±æ˜¯å¦å­˜åœ¨äº Trie Tree ä¸­
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span><span style="color:#6ab825;font-weight:bold">func</span> (t *Trie) <span style="color:#447fcf">Find</span>(path <span style="color:#6ab825;font-weight:bold">string</span>) <span style="color:#6ab825;font-weight:bold">bool</span> {
</span></span><span style="display:flex;"><span>	parent := t
</span></span><span style="display:flex;"><span>	<span style="color:#6ab825;font-weight:bold">for</span> i := <span style="color:#6ab825;font-weight:bold">range</span> path {
</span></span><span style="display:flex;"><span>		<span style="color:#6ab825;font-weight:bold">if</span> child, ok := parent.Children[path[i]]; ok {
</span></span><span style="display:flex;"><span>			parent = child
</span></span><span style="display:flex;"><span>		} <span style="color:#6ab825;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#6ab825;font-weight:bold">return</span> <span style="color:#6ab825;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#6ab825;font-weight:bold">return</span> parent.IsPath
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ç„¶åå¯¹ä¸Šé¢çš„å®ç°ä»£ç åšä¸€ä¸ªç®€å•çš„å°æµ‹è¯•:</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">package</span> trie
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">import</span> <span style="color:#ed9d13">&#34;testing&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">func</span> <span style="color:#447fcf">TestTrie</span>(t *testing.T) {
</span></span><span style="display:flex;"><span>	trieTree := <span style="color:#447fcf">New</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6ab825;font-weight:bold">if</span> got := trieTree.<span style="color:#447fcf">Find</span>(<span style="color:#ed9d13">&#34;hello&#34;</span>); got != <span style="color:#6ab825;font-weight:bold">false</span> {
</span></span><span style="display:flex;"><span>		t.<span style="color:#447fcf">Errorf</span>(<span style="color:#ed9d13">&#34;Get() = %v, want %v&#34;</span>, got, <span style="color:#6ab825;font-weight:bold">false</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	trieTree.<span style="color:#447fcf">Add</span>(<span style="color:#ed9d13">&#34;hello&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6ab825;font-weight:bold">if</span> got := trieTree.<span style="color:#447fcf">Find</span>(<span style="color:#ed9d13">&#34;hello&#34;</span>); got != <span style="color:#6ab825;font-weight:bold">true</span> {
</span></span><span style="display:flex;"><span>		t.<span style="color:#447fcf">Errorf</span>(<span style="color:#ed9d13">&#34;Get() = %v, want %v&#34;</span>, got, <span style="color:#6ab825;font-weight:bold">true</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#6ab825;font-weight:bold">if</span> got := trieTree.<span style="color:#447fcf">Find</span>(<span style="color:#ed9d13">&#34;he&#34;</span>); got != <span style="color:#6ab825;font-weight:bold">false</span> {
</span></span><span style="display:flex;"><span>		t.<span style="color:#447fcf">Errorf</span>(<span style="color:#ed9d13">&#34;Get() = %v, want %v&#34;</span>, got, <span style="color:#6ab825;font-weight:bold">false</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	trieTree.<span style="color:#447fcf">Add</span>(<span style="color:#ed9d13">&#34;he&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#6ab825;font-weight:bold">if</span> got := trieTree.<span style="color:#447fcf">Find</span>(<span style="color:#ed9d13">&#34;he&#34;</span>); got != <span style="color:#6ab825;font-weight:bold">true</span> {
</span></span><span style="display:flex;"><span>		t.<span style="color:#447fcf">Errorf</span>(<span style="color:#ed9d13">&#34;Get() = %v, want %v&#34;</span>, got, <span style="color:#6ab825;font-weight:bold">true</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="å®ç°è·¯ç”±ç®¡ç†">å®ç°è·¯ç”±ç®¡ç†</h3>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬å°†åˆšæ‰çš„ â€œç®—æ³•éƒ¨åˆ†â€ ä»£ç é…åˆæ ‡å‡†åº“æä¾›çš„ API ä»£ç ï¼Œå®Œæˆä¸€ä¸ªåŸºç¡€ç‰ˆçš„è·¯ç”±ç®¡ç†åŠŸèƒ½ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">package</span> main
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#ed9d13">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ed9d13">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ed9d13">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic">// Router èŠ‚ç‚¹
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span><span style="color:#6ab825;font-weight:bold">type</span> Router <span style="color:#6ab825;font-weight:bold">struct</span> {
</span></span><span style="display:flex;"><span>	Path   <span style="color:#6ab825;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>	Method <span style="color:#6ab825;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#999;font-style:italic">// æ ‡è®°å½“å‰èŠ‚ç‚¹æ˜¯å¦ä¸ºæœ‰æ•ˆçš„è·¯ç”±
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	<span style="color:#999;font-style:italic">// ä¾‹å¦‚æ·»åŠ äº†è·¯ç”± /users
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	<span style="color:#999;font-style:italic">// é‚£ä¹ˆ /user, /usr ä¸èƒ½ç®—ä½œæœ‰æ•ˆçš„è·¯ç”±
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	<span style="color:#999;font-style:italic">// ä¹Ÿå°±æ˜¯åªæœ‰å­—ç¬¦ &#34;s&#34; èŠ‚ç‚¹çš„ IsPath å­—æ®µä¸º true
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	IsPath <span style="color:#6ab825;font-weight:bold">bool</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#999;font-style:italic">// å½“å‰èŠ‚ç‚¹çš„å­èŠ‚ç‚¹
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	Children <span style="color:#6ab825;font-weight:bold">map</span>[<span style="color:#6ab825;font-weight:bold">byte</span>]*Router
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#999;font-style:italic">// è·¯ç”±å¤„ç†æ–¹æ³•
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	Handler http.HandlerFunc
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">func</span> <span style="color:#447fcf">NewRouter</span>() *Router {
</span></span><span style="display:flex;"><span>	<span style="color:#6ab825;font-weight:bold">return</span> &amp;Router{IsPath: <span style="color:#6ab825;font-weight:bold">false</span>, Children: <span style="color:#24909d">make</span>(<span style="color:#6ab825;font-weight:bold">map</span>[<span style="color:#6ab825;font-weight:bold">byte</span>]*Router)}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic">// Add æ·»åŠ ä¸€ä¸ªè·¯ç”±åˆ° Router
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span><span style="color:#6ab825;font-weight:bold">func</span> (r *Router) <span style="color:#447fcf">Add</span>(method, path <span style="color:#6ab825;font-weight:bold">string</span>, handler http.HandlerFunc) {
</span></span><span style="display:flex;"><span>	parent := r
</span></span><span style="display:flex;"><span>	<span style="color:#999;font-style:italic">// é€ä¸ª byte åŠ å…¥åˆ° Router Tree
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	<span style="color:#6ab825;font-weight:bold">for</span> i := <span style="color:#6ab825;font-weight:bold">range</span> path {
</span></span><span style="display:flex;"><span>		<span style="color:#6ab825;font-weight:bold">if</span> child, ok := parent.Children[path[i]]; ok {
</span></span><span style="display:flex;"><span>			<span style="color:#999;font-style:italic">// å¦‚æœå­èŠ‚ç‚¹ä¸ä¸ºç©ºï¼Œç»§ç»­å‘ä¸‹éå†
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>			parent = child
</span></span><span style="display:flex;"><span>		} <span style="color:#6ab825;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#999;font-style:italic">// å¦‚æœå­èŠ‚ç‚¹ä¸ºç©ºï¼Œæ„é€ æ–°çš„èŠ‚ç‚¹
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>			newChild := <span style="color:#447fcf">NewRouter</span>()
</span></span><span style="display:flex;"><span>			parent.Children[path[i]] = newChild
</span></span><span style="display:flex;"><span>			parent = newChild
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	parent.Method = method
</span></span><span style="display:flex;"><span>	parent.Handler = handler
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#999;font-style:italic">// æ›´æ–°å½“å‰è·¯ç”±çš„å¶å­èŠ‚ç‚¹çš„ IsPath å­—æ®µ
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	parent.IsPath = <span style="color:#6ab825;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic">// Find è¿”å›æŒ‡å®šè·¯ç”±æ˜¯å¦å­˜åœ¨äº Router ä¸­
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span><span style="color:#6ab825;font-weight:bold">func</span> (r *Router) <span style="color:#447fcf">Find</span>(method, path <span style="color:#6ab825;font-weight:bold">string</span>) (http.HandlerFunc, <span style="color:#6ab825;font-weight:bold">bool</span>) {
</span></span><span style="display:flex;"><span>	parent := r
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6ab825;font-weight:bold">for</span> i := <span style="color:#6ab825;font-weight:bold">range</span> path {
</span></span><span style="display:flex;"><span>		<span style="color:#6ab825;font-weight:bold">if</span> child, ok := parent.Children[path[i]]; ok {
</span></span><span style="display:flex;"><span>			parent = child
</span></span><span style="display:flex;"><span>		} <span style="color:#6ab825;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#6ab825;font-weight:bold">return</span> <span style="color:#6ab825;font-weight:bold">nil</span>, <span style="color:#6ab825;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6ab825;font-weight:bold">return</span> parent.Handler, parent.IsPath &amp;&amp; parent.Method == method
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic">// å®ç° http.Handler æ¥å£
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span><span style="color:#6ab825;font-weight:bold">func</span> (r *Router) <span style="color:#447fcf">ServeHTTP</span>(w http.ResponseWriter, req *http.Request) {
</span></span><span style="display:flex;"><span>	handler, ok := r.<span style="color:#447fcf">Find</span>(req.Method, req.URL.Path)
</span></span><span style="display:flex;"><span>	<span style="color:#6ab825;font-weight:bold">if</span> ok {
</span></span><span style="display:flex;"><span>		<span style="color:#447fcf">handler</span>(w, req)
</span></span><span style="display:flex;"><span>	} <span style="color:#6ab825;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>		http.<span style="color:#447fcf">NotFound</span>(w, req)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic">// å¤„ç†æ‰€æœ‰è·¯ç”±çš„æ–¹æ³•
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic">// è¾“å‡ºè¯·æ±‚ Method å’Œ URL
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span><span style="color:#6ab825;font-weight:bold">func</span> <span style="color:#447fcf">allHandler</span>(w http.ResponseWriter, req *http.Request) {
</span></span><span style="display:flex;"><span>	_, _ = fmt.<span style="color:#447fcf">Fprintln</span>(w, req.Method, req.URL)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">func</span> <span style="color:#447fcf">main</span>() {
</span></span><span style="display:flex;"><span>	r := <span style="color:#447fcf">NewRouter</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	r.<span style="color:#447fcf">Add</span>(<span style="color:#ed9d13">&#34;GET&#34;</span>, <span style="color:#ed9d13">&#34;/hello&#34;</span>, allHandler)
</span></span><span style="display:flex;"><span>	r.<span style="color:#447fcf">Add</span>(<span style="color:#ed9d13">&#34;GET&#34;</span>, <span style="color:#ed9d13">&#34;/users/list&#34;</span>, allHandler)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	log.<span style="color:#447fcf">Fatal</span>(http.<span style="color:#447fcf">ListenAndServe</span>(<span style="color:#ed9d13">&#34;:8080&#34;</span>, r))
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ä¸ºäº†èŠ‚çœç¯‡å¹…ï¼Œè¿™é‡Œå°±ä¸å†™æµ‹è¯•ä»£ç äº†ï¼Œä¸‹é¢è¿›è¡Œå‡ ä¸ªç®€å•çš„æµ‹è¯•:</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#999;font-style:italic"># å¯åŠ¨æœåŠ¡</span>
</span></span><span style="display:flex;"><span>$ go run main.go
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"># æµ‹è¯•ä¸¤ä¸ªæ­£å¸¸çš„ URL</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ curl 127.0.0.1:8080/hello
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"># è¾“å‡ºå¦‚ä¸‹</span>
</span></span><span style="display:flex;"><span>GET /hello
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ curl 127.0.0.1:8080/users/list
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"># è¾“å‡ºå¦‚ä¸‹</span>
</span></span><span style="display:flex;"><span>GET /users/list
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"># æµ‹è¯•ä¸¤ä¸ªä¸å­˜åœ¨çš„ URL</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ curl 127.0.0.1:8080
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"># è¾“å‡ºå¦‚ä¸‹</span>
</span></span><span style="display:flex;"><span><span style="color:#3677a9">404</span> page not found
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ curl 127.0.0.1:8080/users/123456
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"># è¾“å‡ºå¦‚ä¸‹</span>
</span></span><span style="display:flex;"><span><span style="color:#3677a9">404</span> page not found
</span></span></code></pre></div><h3 id="ä¼˜ç‚¹">ä¼˜ç‚¹</h3>
<p>Trie Tree æ—¶é—´å¤æ‚åº¦ä½ï¼Œå’Œä¸€èˆ¬çš„æ ‘å½¢æ•°æ®ç»“æ„ç›¸æ¯”ï¼ŒTrie Tree æ‹¥æœ‰æ›´å¿«çš„å‰ç¼€æœç´¢å’ŒæŸ¥è¯¢æ€§èƒ½ï¼Œå’ŒæŸ¥è¯¢æ—¶é—´å¤æ‚åº¦ä¸º O(1) å¸¸æ•°çš„å“ˆå¸Œç®—æ³•ç›¸æ¯”ï¼Œ
Trie Tree æ”¯æŒå‰ç¼€æœç´¢ï¼Œå¹¶ä¸”å¯ä»¥èŠ‚çœå“ˆå¸Œå‡½æ•°çš„è®¡ç®—å¼€é”€å’Œé¿å…å“ˆå¸Œå€¼ç¢°æ’çš„æƒ…å†µï¼Œæœ€åï¼ŒTrie Tree è¿˜æ”¯æŒå¯¹å…³é”®å­—è¿›è¡Œå­—å…¸æ’åºã€‚</p>
<h3 id="é€‚ç”¨åœºæ™¯">é€‚ç”¨åœºæ™¯</h3>
<ul>
<li>æ’åº   :  ä¸€ç»„å­—ç¬¦ä¸² key çš„å­—å…¸æ’åºï¼Œå¯ä»¥é€šè¿‡ä¸ºç»™å®š key æ„å»ºä¸€ä¸ª Trie Treeï¼Œ ç„¶åé€šè¿‡å‰åºæ–¹å¼éå†æ ‘æ¥å®ç°, burstsort æ˜¯ 2007 å¹´æœ€å¿«çš„å­—ç¬¦ä¸²æ’åºç®—æ³•ï¼Œå…¶åŸºç¡€æ•°æ®ç»“æ„å°±æ˜¯ Trie Tree</li>
<li>å…¨æ–‡ç´¢å¼•: é€šè¿‡ä¸€ç§ç‰¹æ®Šçš„ Trie Tree å®ç°ï¼Œä¸€èˆ¬ç§°ä¸ºåç¼€æ ‘ï¼Œå¯ç”¨äºç´¢å¼•æ–‡æœ¬ä¸­çš„æ‰€æœ‰åç¼€ä»¥æ‰§è¡Œå¿«é€Ÿå…¨æ–‡æœç´¢</li>
<li>æœç´¢å¼•æ“: å½“ä½ åœ¨æœç´¢å¼•æ“çš„è¾“å…¥æ¡†ä¸­è¾“å…¥å…³é”®å­—æ—¶ï¼Œè‡ªåŠ¨è¡¥å…¨çš„æç¤ºä¿¡æ¯</li>
<li>ç”Ÿç‰©ä¿¡æ¯: åŸºå› åºåˆ—å¯¹æ¯”è½¯ä»¶</li>
<li>è·¯ç”±ç®¡ç†: ç½‘ç»œ IP è·¯ç”±è¡¨ï¼ŒWeb ä¸­çš„ HTTP Router ç®¡ç†</li>
</ul>
<h3 id="ä¸é€‚ç”¨åœºæ™¯">ä¸é€‚ç”¨åœºæ™¯</h3>
<ul>
<li>å­—ç¬¦ä¸²å…¬å…±å‰ç¼€å¤ªå°‘ï¼Œé€ æˆ Trie Tree èŠ‚ç‚¹ç¨€ç–åˆ†å¸ƒï¼Œè¿™æ—¶å“ˆå¸Œè¡¨æ˜¯æ›´å¥½çš„é€‰æ‹©</li>
<li>èŠ‚ç‚¹ä¹‹é—´çš„çˆ¶å­èŠ‚ç‚¹ä½¿ç”¨æŒ‡é’ˆè¿æ¥ï¼Œå¯¹ CPU å’Œè‡ªå¸¦ GC è¯­è¨€ä¸å¤ªå‹å¥½</li>
<li>å­—ç¬¦é›†è¿‡å¤§ä¼šé€ æˆè¿‡å¤šçš„å­˜å‚¨ç©ºé—´å ç”¨ (Trie Tree æ˜¯ç©ºé—´æ¢æ—¶é—´)</li>
<li>å­—ç¬¦ä¸²è¿‡é•¿ä¼šä½¿ Trie Tree æ·±åº¦å˜å¤§ï¼Œè¿™æ—¶åº”è¯¥ä½¿ç”¨æ¥ä¸‹æ¥è®²åˆ°çš„ Radix Tree</li>
</ul>
<h2 id="radix-tree">Radix Tree</h2>
<blockquote>
<p>Radix Treeï¼ˆåŸºæ•°æ ‘ï¼‰æ˜¯ä¸€ç§ç‰¹æ®Šçš„æ•°æ®ç»“æ„ï¼Œç”¨äºé«˜æ•ˆåœ°å­˜å‚¨å’Œæœç´¢å­—ç¬¦ä¸²é”®å€¼å¯¹ï¼Œå®ƒæ˜¯ä¸€ç§åŸºäºå‰ç¼€çš„æ ‘çŠ¶ç»“æ„ï¼Œé€šè¿‡å°†ç›¸åŒå‰ç¼€çš„é”®å€¼å¯¹åˆå¹¶åœ¨ä¸€èµ·æ¥å‡å°‘å­˜å‚¨ç©ºé—´çš„ä½¿ç”¨ã€‚
Radix Tree çš„å…³é”®æ€æƒ³æ˜¯åˆ©ç”¨å…¬å…±å‰ç¼€æ¥åˆå¹¶èŠ‚ç‚¹ï¼Œæ¯ä¸ªèŠ‚ç‚¹ä»£è¡¨ä¸€ä¸ªå­—ç¬¦ï¼Œä»æ ¹èŠ‚ç‚¹åˆ°å¶å­èŠ‚ç‚¹çš„è·¯å¾„å³ä¸ºä¸€ä¸ªå­—ç¬¦ä¸²é”®ï¼Œæ¯ä¸ªèŠ‚ç‚¹ä¸Šå­˜å‚¨ç€ä¸€ä¸ªå­—ç¬¦ä¸²çš„éƒ¨åˆ†å­ä¸²ï¼Œå¹¶ä¸”æ¯ä¸ªèŠ‚ç‚¹å¯ä»¥ä»£è¡¨å¤šä¸ªé”®å€¼å¯¹ã€‚</p>
</blockquote>
<h3 id="ç®—æ³•å¤æ‚åº¦-1">ç®—æ³•å¤æ‚åº¦</h3>
<ul>
<li>N: å­—ç¬¦ä¸²çš„æ•°é‡</li>
<li>M: å­—ç¬¦ä¸²çš„å¹³å‡é•¿åº¦</li>
<li>L: å­—ç¬¦ä¸²çš„é•¿åº¦</li>
</ul>
<table>
<thead>
<tr>
<th>ç©ºé—´å¤æ‚åº¦</th>
</tr>
</thead>
<tbody>
<tr>
<td>O(NM)</td>
</tr>
</tbody>
</table>
<p>æ³¨æ„: Radix Tree çš„ä½¿ç”¨åœºæ™¯æ˜¯æ ‘ä¸­æœ‰è¾ƒå¤šèŠ‚ç‚¹æ‹¥æœ‰ç›¸åŒå‰ç¼€ï¼Œæ‰€ä»¥å³ä½¿å’Œ Trie Tree çš„ç©ºé—´å¤æ‚åº¦ä¸€æ ·ï¼Œä½†æ˜¯å®é™…åº”ç”¨ä¸­ï¼ŒRadix Tree é€šè¿‡å‹ç¼©å…¬å…±å‰ç¼€ï¼Œ
ç©ºé—´ä½¿ç”¨è¦æ¯” Trie Tree èŠ‚çœå¾ˆå¤šã€‚</p>
<table>
<thead>
<tr>
<th>æ“ä½œ</th>
<th>æ—¶é—´å¤æ‚åº¦</th>
</tr>
</thead>
<tbody>
<tr>
<td>æ’å…¥</td>
<td>O(L)</td>
</tr>
<tr>
<td>æŸ¥æ‰¾</td>
<td>O(L)</td>
</tr>
<tr>
<td>åˆ é™¤</td>
<td>O(L)</td>
</tr>
</tbody>
</table>
<h3 id="æ“ä½œç¤ºä¾‹">æ“ä½œç¤ºä¾‹</h3>
<p>ä¸‹é¢å¼•ç”¨ç»´åŸºç™¾ç§‘é¡µé¢ä¸Šçš„ç¤ºä¾‹å›¾æ¥è¯´æ˜ Radix Tree çš„æ“ä½œè¿‡ç¨‹ã€‚</p>
<p>åˆå§‹çŠ¶æ€ä¸‹ï¼Œæ ‘ä¸­åŒ…å«ä¸¤ä¸ªèŠ‚ç‚¹ï¼Œåˆ†åˆ«æ˜¯å­—ç¬¦ä¸² test å’Œ slowã€‚</p>
<h4 id="1-å°†å­—ç¬¦ä¸²-water-æ’å…¥åˆ°æ ‘ä¸­">1. å°†å­—ç¬¦ä¸² water æ’å…¥åˆ°æ ‘ä¸­</h4>
<p><img src="https://dbwu.tech/images/radix_tree_op1.png" alt="å›¾ç‰‡æ¥æº: https://en.wikipedia.org/wiki/Radix_tree"></p>
<p>å› ä¸ºå­—ç¬¦ä¸² water å’Œå·²æœ‰çš„ä¸¤ä¸ªèŠ‚ç‚¹æ²¡æœ‰å…¬å…±å‰ç¼€ï¼Œæ‰€ä»¥ç›´æ¥æ’å…¥åˆ°æ–°çš„èŠ‚ç‚¹ä¸­ã€‚</p>
<h4 id="2-å°†å­—ç¬¦ä¸²-slower-æ’å…¥åˆ°æ ‘ä¸­">2. å°†å­—ç¬¦ä¸² slower æ’å…¥åˆ°æ ‘ä¸­</h4>
<p><img src="https://dbwu.tech/images/radix_tree_op2.png" alt="å›¾ç‰‡æ¥æº: https://en.wikipedia.org/wiki/Radix_tree"></p>
<p>å­—ç¬¦ä¸² slower å’Œå·²æœ‰çš„èŠ‚ç‚¹ slow å­˜åœ¨å…¬å…±å‰ç¼€ slow, æ‰€ä»¥æ”¾åœ¨ slow èŠ‚ç‚¹ä¸‹é¢ã€‚</p>
<h4 id="3-å°†å­—ç¬¦ä¸²-tester-æ’å…¥åˆ°æ ‘ä¸­">3. å°†å­—ç¬¦ä¸² tester æ’å…¥åˆ°æ ‘ä¸­</h4>
<p><img src="https://dbwu.tech/images/radix_tree_op3.png" alt="å›¾ç‰‡æ¥æº: https://en.wikipedia.org/wiki/Radix_tree"></p>
<p>å­—ç¬¦ä¸² tester å’Œå·²æœ‰çš„èŠ‚ç‚¹ test å­˜åœ¨å…¬å…±å‰ç¼€ test, æ‰€ä»¥æ”¾åœ¨ test èŠ‚ç‚¹ä¸‹é¢ã€‚</p>
<h4 id="4-å°†å­—ç¬¦ä¸²-team-æ’å…¥åˆ°æ ‘ä¸­">4. å°†å­—ç¬¦ä¸² team æ’å…¥åˆ°æ ‘ä¸­</h4>
<p><img src="https://dbwu.tech/images/radix_tree_op4.png" alt="å›¾ç‰‡æ¥æº: https://en.wikipedia.org/wiki/Radix_tree"></p>
<p>å­—ç¬¦ä¸² team å’Œå·²æœ‰çš„èŠ‚ç‚¹ test å­˜åœ¨å…¬å…±å‰ç¼€ te, å°† test èŠ‚ç‚¹åˆ†è£‚ä¸º st å’Œ am ä¸¤ä¸ªå­èŠ‚ç‚¹ï¼Œä¸¤ä¸ªå­èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ä¸º teã€‚</p>
<h4 id="5-å°†å­—ç¬¦ä¸²-toast-æ’å…¥åˆ°æ ‘ä¸­">5. å°†å­—ç¬¦ä¸² toast æ’å…¥åˆ°æ ‘ä¸­</h4>
<p><img src="https://dbwu.tech/images/radix_tree_op5.png" alt="å›¾ç‰‡æ¥æº: https://en.wikipedia.org/wiki/Radix_tree"></p>
<p>å­—ç¬¦ä¸² toast å’Œå·²æœ‰çš„èŠ‚ç‚¹ te å­˜åœ¨å…¬å…±å‰ç¼€ t, å°† te èŠ‚ç‚¹åˆ†è£‚ä¸º e å’Œ oast ä¸¤ä¸ªå­èŠ‚ç‚¹ï¼Œä¸¤ä¸ªå­èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ä¸º t, å°† te åŸæ¥çš„ä¸¤ä¸ªå­èŠ‚ç‚¹æ”¾åœ¨ e èŠ‚ç‚¹ä¸‹é¢ã€‚</p>
<h3 id="å®ç°ä»£ç -1">å®ç°ä»£ç </h3>
<p>ç¬”è€…é€‰æ‹©äº†å¼€æºçš„ç»„ä»¶åº“ <a href="https://github.com/julienschmidt/httprouter">httprouter</a> æ¥ä½œä¸ºä»£ç å®ç°çš„å­¦ä¹ æ–¹æ¡ˆï¼Œé€‰æ‹©è¿™ä¸ªç»„ä»¶çš„ä¸»è¦åŸå› æœ‰ä¸¤ç‚¹ï¼š</p>
<ol>
<li>è¯¥ç»„ä»¶ä¸“æ³¨äºè·¯ç”±ç®¡ç†ï¼Œä»£ç é‡å°‘ä¸”ç»“æ„ç®€å•ï¼Œæ¶‰åŠåˆ° Radix Tree æ•°æ®ç»“æ„å’Œç®—æ³•çš„ä»£ç å·²ç»ç‹¬ç«‹åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œè¿™å¯ä»¥å¤§å¤§é™ä½æˆ‘ä»¬é˜…è¯»æºä»£ç çš„å‹åŠ›å’Œæ—¶é—´æˆæœ¬</li>
<li>å¾ˆå¤š Web æ¡†æ¶ä¸­çš„è·¯ç”±ç®¡ç†åŠŸèƒ½éƒ½æ˜¯åŸºäºè¯¥ç»„ä»¶å®ç°çš„ï¼Œæ¯”å¦‚éå¸¸æµè¡Œçš„ Gin</li>
</ol>
<p><img src="https://dbwu.tech/images/based_on_httpRouter.png" alt="Web Frameworks based on HttpRouter"></p>
<p>httprouter æä¾›çš„ API éå¸¸ç®€æ´ï¼Œä¾‹å¦‚ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ Demo :</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">package</span> main
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">import</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#ed9d13">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ed9d13">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ed9d13">&#34;github.com/julienschmidt/httprouter&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">func</span> <span style="color:#447fcf">main</span>() {
</span></span><span style="display:flex;"><span>    router := httprouter.<span style="color:#447fcf">New</span>()
</span></span><span style="display:flex;"><span>    router.<span style="color:#447fcf">GET</span>(<span style="color:#ed9d13">&#34;/&#34;</span>, someHandle)
</span></span><span style="display:flex;"><span>    router.<span style="color:#447fcf">GET</span>(<span style="color:#ed9d13">&#34;/hello/:name&#34;</span>, someHandle)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    log.<span style="color:#447fcf">Fatal</span>(http.<span style="color:#447fcf">ListenAndServe</span>(<span style="color:#ed9d13">&#34;:8080&#34;</span>, router))
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>æ¥ä¸‹æ¥æˆ‘ä»¬åˆ†ä¸ºä¸¤éƒ¨åˆ†æ¥å­¦ä¹  httprouter ç»„ä»¶çš„æºä»£ç å®ç°:</p>
<ol>
<li>Radix Tree æ•°æ®ç»“æ„å’Œç®—æ³•çš„å®ç°</li>
<li>åŸºäº Radix Tree çš„è·¯ç”±ç®¡ç†åŠŸèƒ½å®ç°</li>
</ol>
<p><img src="https://dbwu.tech/images/httprouter_uml.png" alt="httprouter UML"></p>
<p>ğŸ’¡ <strong>é‡è¦æç¤º</strong>: ä¸‹æ–‡ä¸­çš„ä»£ç å’Œæ³¨é‡Šå†…å®¹è¾ƒå¤šï¼Œè¯»è€…å¦‚æœæ—¶é—´æœ‰é™ï¼Œå¯ä»¥å¿«é€Ÿæµè§ˆä¸€ä¸‹æ ¸å¿ƒå¯¹è±¡åŠæ–¹æ³•å’Œæ–‡æœ«çš„æ€»ç»“ï¼Œåœ¨éœ€è¦äº†è§£ç»†èŠ‚æ—¶å†å›æ¥é˜…è¯»ã€‚</p>
<h3 id="radix-tree-å®ç°">Radix Tree å®ç°</h3>
<h4 id="å·¥ä½œåŸç†ç®€è¿°">å·¥ä½œåŸç†ç®€è¿°</h4>
<p>è·¯ç”±ç®¡ç†åŠŸèƒ½ä¸­ï¼Œåº•å±‚çš„æ•°æ®ç»“æ„æ˜¯ä½¿ç”¨å…¬å…±å‰ç¼€çš„æ ‘å½¢ç»“æ„ï¼Œä¹Ÿå°±æ˜¯åŸºæ•°æ ‘ã€‚åœ¨è¯¥æ•°æ®ç»“æ„ä¸­ï¼Œæ‰€æœ‰å…·æœ‰å…¬å…±å‰ç¼€çš„èŠ‚ç‚¹å…±äº«åŒä¸€ä¸ªçˆ¶èŠ‚ç‚¹ï¼Œ
ä¸‹é¢æ˜¯ä¸€ä¸ªå…³äºè¿™ç§æ•°æ®ç»“æ„çš„ç¤ºä¾‹ (è¯·æ±‚æ–¹æ³•ä¸º GET)ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>Priority   Path             Handle
</span></span><span style="display:flex;"><span><span style="color:#3677a9">9</span>          <span style="color:#ed9d13">\ </span>               *&lt;1&gt;
</span></span><span style="display:flex;"><span><span style="color:#3677a9">3</span>          â”œs               nil
</span></span><span style="display:flex;"><span><span style="color:#3677a9">2</span>          |â”œearch<span style="color:#ed9d13">\ </span>        *&lt;2&gt;
</span></span><span style="display:flex;"><span><span style="color:#3677a9">1</span>          |â””upport<span style="color:#ed9d13">\ </span>       *&lt;3&gt;
</span></span><span style="display:flex;"><span><span style="color:#3677a9">2</span>          â”œblog<span style="color:#ed9d13">\ </span>          *&lt;4&gt;
</span></span><span style="display:flex;"><span><span style="color:#3677a9">1</span>          |    â””:post      nil
</span></span><span style="display:flex;"><span><span style="color:#3677a9">1</span>          |         â””<span style="color:#ed9d13">\ </span>    *&lt;5&gt;
</span></span><span style="display:flex;"><span><span style="color:#3677a9">2</span>          â”œabout-us<span style="color:#ed9d13">\ </span>      *&lt;6&gt;
</span></span><span style="display:flex;"><span><span style="color:#3677a9">1</span>          |        â””team<span style="color:#ed9d13">\ </span> *&lt;7&gt;
</span></span><span style="display:flex;"><span><span style="color:#3677a9">1</span>          â””contact<span style="color:#ed9d13">\ </span>       *&lt;8&gt;
</span></span></code></pre></div><p>å¯¹ä¸Šé¢çš„ç»“æ„å›¾åšä¸€ä¸ªç®€å•çš„è¯´æ˜:</p>
<ul>
<li>*&lt;æ•°å­—&gt; ä»£è¡¨ Handler æ–¹æ³•æŒ‡é’ˆ</li>
<li>search èŠ‚ç‚¹å’Œ support èŠ‚ç‚¹æ‹¥æœ‰å…±åŒçš„çˆ¶èŠ‚ç‚¹ s ï¼Œå¹¶ä¸” s æ²¡æœ‰å¯¹åº”çš„ Handleï¼Œ åªæœ‰å¶å­èŠ‚ç‚¹æ‰æœ‰ Handler</li>
<li>ä» root èŠ‚ç‚¹å¼€å§‹ï¼Œä¸€ç›´åˆ°å¶å­èŠ‚ç‚¹ï¼Œç®—ä½œä¸€æ¡è·¯ç”±çš„å®Œæ•´è·¯å¾„</li>
<li>è·¯å¾„æœç´¢çš„é¡ºåºæ˜¯ä»ä¸Šå‘ä¸‹ -&gt; ä»å·¦åˆ°å³ï¼Œä¸ºäº†å¿«é€Ÿæ‰¾åˆ°å°½å¯èƒ½å¤šçš„è·¯ç”±ï¼Œå­èŠ‚ç‚¹è¶Šå¤šçš„èŠ‚ç‚¹ä¼˜å…ˆçº§è¶Šé«˜</li>
</ul>
<p>å°†ä¸Šé¢çš„ç»“æ„å›¾è½¬æ¢ä»£ç :</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>router.<span style="color:#447fcf">GET</span>(<span style="color:#ed9d13">&#34;/&#34;</span>, func1)
</span></span><span style="display:flex;"><span>router.<span style="color:#447fcf">GET</span>(<span style="color:#ed9d13">&#34;/search/&#34;</span>, func2)
</span></span><span style="display:flex;"><span>router.<span style="color:#447fcf">GET</span>(<span style="color:#ed9d13">&#34;/support/&#34;</span>, func3)
</span></span><span style="display:flex;"><span>router.<span style="color:#447fcf">GET</span>(<span style="color:#ed9d13">&#34;/blog/:post/&#34;</span>, func5)
</span></span><span style="display:flex;"><span>router.<span style="color:#447fcf">GET</span>(<span style="color:#ed9d13">&#34;/about-us/&#34;</span>, func6)
</span></span><span style="display:flex;"><span>router.<span style="color:#447fcf">GET</span>(<span style="color:#ed9d13">&#34;/about-us/team/&#34;</span>, func7)
</span></span><span style="display:flex;"><span>router.<span style="color:#447fcf">GET</span>(<span style="color:#ed9d13">&#34;/contact/&#34;</span>, func8)
</span></span></code></pre></div><h4 id="node-å¯¹è±¡">node å¯¹è±¡</h4>
<p>node å¯¹è±¡è¡¨ç¤º Radix Tree çš„å•ä¸ªèŠ‚ç‚¹ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#999;font-style:italic">// èŠ‚ç‚¹ç±»å‹
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span><span style="color:#6ab825;font-weight:bold">type</span> nodeType <span style="color:#6ab825;font-weight:bold">uint8</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">const</span> (
</span></span><span style="display:flex;"><span>	static nodeType = <span style="color:#6ab825;font-weight:bold">iota</span> 
</span></span><span style="display:flex;"><span>	root        <span style="color:#999;font-style:italic">// æ ¹èŠ‚ç‚¹ 
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	param       <span style="color:#999;font-style:italic">// å‚æ•°èŠ‚ç‚¹ (ä¾‹å¦‚ /users/:id)
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	catchAll    <span style="color:#999;font-style:italic">// é€šç”¨èŠ‚ç‚¹ï¼ŒåŒ¹é…ä»»æ„å‚æ•° (ä¾‹å¦‚ /users/*logs)
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">type</span> node <span style="color:#6ab825;font-weight:bold">struct</span> {
</span></span><span style="display:flex;"><span>	path      <span style="color:#6ab825;font-weight:bold">string</span>    <span style="color:#999;font-style:italic">// è·¯å¾„
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	wildChild <span style="color:#6ab825;font-weight:bold">bool</span>      <span style="color:#999;font-style:italic">// æ˜¯å¦ä¸ºå‚æ•°èŠ‚ç‚¹
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	nType     nodeType  <span style="color:#999;font-style:italic">// èŠ‚ç‚¹ç±»å‹
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	maxParams <span style="color:#6ab825;font-weight:bold">uint8</span>     <span style="color:#999;font-style:italic">// è·¯å¾„å‚æ•°ä¸ªæ•°ä¸Šé™
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	priority  <span style="color:#6ab825;font-weight:bold">uint32</span>    <span style="color:#999;font-style:italic">// ä¼˜å…ˆçº§
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	indices   <span style="color:#6ab825;font-weight:bold">string</span>    <span style="color:#999;font-style:italic">// å¯¼è‡´å½“å‰èŠ‚ç‚¹å’Œå…¶å­èŠ‚ç‚¹åˆ†è£‚çš„é¦–ä¸ªå­—ç¬¦ (wildChild == true æ—¶, indices == &#34;&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	children  []*node   <span style="color:#999;font-style:italic">// å­èŠ‚ç‚¹
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	handle    Handle    <span style="color:#999;font-style:italic">// è·¯ç”±å¤„ç†æ–¹æ³•
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>}
</span></span></code></pre></div><h4 id="æ·»åŠ è·¯ç”±">æ·»åŠ è·¯ç”±</h4>
<p>addRoute æ–¹æ³•å°†ç»™å®šçš„è·¯ç”±å¤„ç†æ–¹æ³•ç»‘å®šåˆ°å…·ä½“çš„ Path ä¸Šé¢ï¼Œè¯¥æ–¹æ³•ä¸æ˜¯å¹¶å‘å®‰å…¨çš„ï¼Œä¹Ÿå°±æ˜¯éœ€è¦é€šè¿‡åŠ é”ç­‰æœºåˆ¶å°†æ“ä½œä¸²è¡ŒåŒ–ã€‚</p>
<p>ä¸ºäº†æœ€å¤§åŒ–æå‡è¯»è€…çš„é˜…è¯»ä½“éªŒå’Œæ•ˆç‡ï¼Œè¿™é‡Œå°†ä»£ç å‰–ææ³¨è§£ç›´æ¥è´´åœ¨æºä»£ç ä¸­ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">func</span> (n *node) <span style="color:#447fcf">addRoute</span>(path <span style="color:#6ab825;font-weight:bold">string</span>, handle Handle) {
</span></span><span style="display:flex;"><span>	fullPath := path
</span></span><span style="display:flex;"><span>	<span style="color:#999;font-style:italic">// å½“å‰èŠ‚ç‚¹ä¼˜å…ˆçº§ + 1
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	n.priority++
</span></span><span style="display:flex;"><span>	<span style="color:#999;font-style:italic">// è®¡ç®—è·¯å¾„ä¸­çš„å‚æ•°ä¸ªæ•°
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	numParams := <span style="color:#447fcf">countParams</span>(path)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#999;font-style:italic">// non-empty tree
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	<span style="color:#6ab825;font-weight:bold">if</span> <span style="color:#24909d">len</span>(n.path) &gt; <span style="color:#3677a9">0</span> || <span style="color:#24909d">len</span>(n.children) &gt; <span style="color:#3677a9">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#999;font-style:italic">// è¯´æ˜å½“å‰ Radix Tree å·²ç»å­˜åœ¨èŠ‚ç‚¹äº†
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>		<span style="color:#999;font-style:italic">// æ¥ä¸‹æ¥è¿›å…¥ walk å¾ªç¯æ ‡ç­¾
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	walk:
</span></span><span style="display:flex;"><span>		<span style="color:#6ab825;font-weight:bold">for</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#999;font-style:italic">// æ›´æ–°å½“å‰èŠ‚ç‚¹æœ€å¤§å‚æ•°ä¸ªæ•°
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>			<span style="color:#6ab825;font-weight:bold">if</span> numParams &gt; n.maxParams {
</span></span><span style="display:flex;"><span>				n.maxParams = numParams
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#999;font-style:italic">// æŸ¥æ‰¾å½“å‰èŠ‚ç‚¹è·¯å¾„å’Œå‚æ•°è·¯å¾„çš„æœ€é•¿å…¬å…±å‰ç¼€
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>			<span style="color:#999;font-style:italic">// å…¬å…±å‰ç¼€ä¸­ä¸èƒ½åŒ…å« &#39;:&#39;  &#39;*&#39; é€šé…ç¬¦ (å› ä¸ºè¿™æ ·å°±æ— æ³•åŒºåˆ†å…·ä½“çš„è·¯å¾„äº†)
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>			<span style="color:#999;font-style:italic">// PS: æŸ¥æ‰¾æœ€é•¿å…¬å…±å‰ç¼€åº”è¯¥ç‹¬ç«‹ä¸ºä¸€ä¸ªå‡½æ•°ï¼Œæé«˜ä»£ç å¯è¯»æ€§ï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨å†…è”ä¼˜åŒ–
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>			<span style="color:#999;font-style:italic">//     Gin æ¡†æ¶ä¸­å·²ç»ç‹¬ç«‹ä¸ºä¸€ä¸ªå‡½æ•° longestCommonPrefix 
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>			<span style="color:#999;font-style:italic">//     https://github.com/gin-gonic/gin/blob/d4a64265f21993368c90602c18e778bf04ef36db/tree.go#L75C6-L75C6
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>			i := <span style="color:#3677a9">0</span>
</span></span><span style="display:flex;"><span>			max := <span style="color:#24909d">min</span>(<span style="color:#24909d">len</span>(path), <span style="color:#24909d">len</span>(n.path))
</span></span><span style="display:flex;"><span>			<span style="color:#6ab825;font-weight:bold">for</span> i &lt; max &amp;&amp; path[i] == n.path[i] {
</span></span><span style="display:flex;"><span>				i++
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#999;font-style:italic">// å¦‚æœæœ€é•¿å…¬å…±å‰ç¼€é•¿åº¦å°äºå½“å‰èŠ‚ç‚¹è·¯å¾„é•¿åº¦
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>			<span style="color:#999;font-style:italic">// è¿™æ„å‘³ç€å¯èƒ½æ˜¯ä¸‹åˆ—ä¸¤ç§æƒ…å†µä¹‹ä¸€ :
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>			<span style="color:#999;font-style:italic">//    1. æœ€é•¿å…¬å…±å‰ç¼€ &gt; 0, ä¾‹å¦‚å½“å‰èŠ‚ç‚¹è·¯å¾„ä¸º /users, å‚æ•°è·¯å¾„ä¸º /usr
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>			<span style="color:#999;font-style:italic">//    2. æœ€é•¿å…¬å…±å‰ç¼€ == 0, ä¾‹å¦‚å½“å‰èŠ‚ç‚¹è·¯å¾„ä¸º /users, å‚æ•°è·¯å¾„ä¸º /books
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>			<span style="color:#999;font-style:italic">// æ­¤æ—¶å½“å‰èŠ‚ç‚¹å°±éœ€è¦åˆ†è£‚æˆä¸¤ä¸ªèŠ‚ç‚¹
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>			<span style="color:#6ab825;font-weight:bold">if</span> i &lt; <span style="color:#24909d">len</span>(n.path) {
</span></span><span style="display:flex;"><span>				<span style="color:#999;font-style:italic">// å°†å½“å‰èŠ‚ç‚¹è·¯å¾„ä¸­é â€œå…¬å…±å‰ç¼€â€ éƒ¨åˆ†ç‹¬ç«‹åˆ°ä¸€ä¸ªæ–°çš„å­èŠ‚ç‚¹ä¸­
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>				child := node{
</span></span><span style="display:flex;"><span>					<span style="color:#999;font-style:italic">// è·¯å¾„ä¸ºå½“å‰èŠ‚ç‚¹è·¯å¾„ä¸­é â€œå…¬å…±å‰ç¼€â€ éƒ¨åˆ†
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>					path:      n.path[i:],
</span></span><span style="display:flex;"><span>					<span style="color:#999;font-style:italic">// ç±»å‹å¾…å®š, æ²¡æœ‰ handler
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>					nType:     static,
</span></span><span style="display:flex;"><span>					indices:   n.indices,
</span></span><span style="display:flex;"><span>                    children:  n.children,
</span></span><span style="display:flex;"><span>                    handle:    n.handle,
</span></span><span style="display:flex;"><span>					<span style="color:#999;font-style:italic">// ä¼˜å…ˆçº§ - 1
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>					priority:  n.priority - <span style="color:#3677a9">1</span>,
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				<span style="color:#999;font-style:italic">// éå†æ–°çš„å­èŠ‚ç‚¹çš„æ‰€æœ‰å­èŠ‚ç‚¹ (ä¹Ÿå°±æ˜¯å½“å‰èŠ‚ç‚¹çš„æ‰€æœ‰å­èŠ‚ç‚¹)
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>				<span style="color:#999;font-style:italic">// æ›´æ–°å½“å‰èŠ‚ç‚¹æœ€å¤§å‚æ•°ä¸ªæ•°
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>				<span style="color:#6ab825;font-weight:bold">for</span> i := <span style="color:#6ab825;font-weight:bold">range</span> child.children { 
</span></span><span style="display:flex;"><span>					<span style="color:#6ab825;font-weight:bold">if</span> child.children[i].maxParams &gt; child.maxParams {
</span></span><span style="display:flex;"><span>						child.maxParams = child.children[i].maxParams
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				<span style="color:#999;font-style:italic">// å°†æ–°èŠ‚ç‚¹ä½œä¸ºå½“å‰èŠ‚ç‚¹çš„å­èŠ‚ç‚¹ (å½“å‰èŠ‚ç‚¹ä¹‹å‰çš„å­èŠ‚ç‚¹å·²ç»è¢«æŒ‚è½½åˆ°äº†æ–°èŠ‚ç‚¹çš„å­èŠ‚ç‚¹ä¸Šé¢)
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>				n.children = []*node{&amp;child}
</span></span><span style="display:flex;"><span>				
</span></span><span style="display:flex;"><span>				<span style="color:#999;font-style:italic">// è·å–å¯¼è‡´å½“å‰èŠ‚ç‚¹å’Œå…¶å­èŠ‚ç‚¹åˆ†è£‚çš„é¦–ä¸ªå­—ç¬¦ï¼Œå¹¶æ›´æ–° indices å­—æ®µ
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>				<span style="color:#999;font-style:italic">// (ä¾‹å¦‚ /users/dbwu å’Œ /users/dbwt, æ›´æ–° indices å­—æ®µä¸º &#34;u&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>				n.indices = <span style="color:#24909d">string</span>([]<span style="color:#6ab825;font-weight:bold">byte</span>{n.path[i]})
</span></span><span style="display:flex;"><span>				
</span></span><span style="display:flex;"><span>				<span style="color:#999;font-style:italic">// æ›´æ–°å½“å‰èŠ‚ç‚¹çš„è·¯å¾„ä¸ºå…¬å…±å‰ç¼€
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>				n.path = path[:i]
</span></span><span style="display:flex;"><span>				<span style="color:#999;font-style:italic">// åˆ é™¤å½“å‰èŠ‚ç‚¹çš„è·¯ç”±å¤„ç†æ–¹æ³•
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>				n.handle = <span style="color:#6ab825;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>				<span style="color:#999;font-style:italic">// åˆ é™¤å½“å‰èŠ‚ç‚¹çš„å‚æ•°èŠ‚ç‚¹æ ‡å¿—
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>				n.wildChild = <span style="color:#6ab825;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#999;font-style:italic">// å¦‚æœæœ€é•¿å…¬å…±å‰ç¼€é•¿åº¦å°äºå‚æ•°è·¯å¾„é•¿åº¦
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>			<span style="color:#999;font-style:italic">// ä¸ºä»€ä¹ˆè¿™æ ·åˆ¤æ–­å‘¢ï¼Ÿ
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>			<span style="color:#999;font-style:italic">//    å› ä¸ºå¦‚æœæœ€é•¿å…¬å…±å‰ç¼€é•¿åº¦å¤§äºç­‰äºå‚æ•°è·¯å¾„é•¿åº¦
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>			<span style="color:#999;font-style:italic">//    è¯´æ˜å‚æ•°è·¯å¾„æœ¬èº«å°±æ˜¯å…¬å…±å‰ç¼€çš„ä¸€éƒ¨åˆ†ï¼Œå°±æ²¡å¿…è¦æ’å…¥è¿™ä¸ªæ–°èŠ‚ç‚¹äº†
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>			<span style="color:#999;font-style:italic">// å°†æ–°èŠ‚ç‚¹æ’å…¥åˆ°å½“å‰èŠ‚ç‚¹çš„å­èŠ‚ç‚¹
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>			<span style="color:#6ab825;font-weight:bold">if</span> i &lt; <span style="color:#24909d">len</span>(path) {
</span></span><span style="display:flex;"><span>				<span style="color:#999;font-style:italic">// åˆ é™¤å…¬å…±å‰ç¼€éƒ¨åˆ†ï¼Œå‰©ä½™éƒ¨åˆ†çš„ path æ˜¯å­èŠ‚ç‚¹çš„è·¯å¾„
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>				path = path[i:]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				<span style="color:#999;font-style:italic">// å¦‚æœå½“å‰èŠ‚ç‚¹æ˜¯å‚æ•°èŠ‚ç‚¹ (ä¾‹å¦‚ /users/:id)
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>				<span style="color:#6ab825;font-weight:bold">if</span> n.wildChild {
</span></span><span style="display:flex;"><span>					<span style="color:#999;font-style:italic">// ä»£ç æ‰§è¡Œåˆ°è¿™é‡Œè¯´æ˜: æœ€é•¿å…¬å…±å‰ç¼€é•¿åº¦å¤§äºç­‰äºå½“å‰èŠ‚ç‚¹è·¯å¾„é•¿åº¦
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>					<span style="color:#999;font-style:italic">// ä¹Ÿå°±æ˜¯è¯´: å‚æ•°è·¯å¾„çš„é•¿åº¦è¦å¤§äºå½“å‰èŠ‚ç‚¹è·¯å¾„é•¿åº¦
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>					<span style="color:#999;font-style:italic">// (ä¾‹å¦‚ å½“å‰èŠ‚ç‚¹è·¯å¾„ä¸º /users/:id, å‚æ•°è·¯å¾„ä¸º /users/:id/profile)
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>					
</span></span><span style="display:flex;"><span>					
</span></span><span style="display:flex;"><span>					<span style="color:#999;font-style:italic">// è·å–åˆ°å½“å‰èŠ‚ç‚¹çš„ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>					n = n.children[<span style="color:#3677a9">0</span>]
</span></span><span style="display:flex;"><span>					<span style="color:#999;font-style:italic">// å½“å‰èŠ‚ç‚¹è¦æ’å…¥ä¸€ä¸ªæ–°èŠ‚ç‚¹ï¼Œä¼˜å…ˆçº§ + 1
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>					n.priority++
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>					<span style="color:#999;font-style:italic">// æ›´æ–°å½“å‰èŠ‚ç‚¹æœ€å¤§å‚æ•°ä¸ªæ•°
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>					<span style="color:#6ab825;font-weight:bold">if</span> numParams &gt; n.maxParams {
</span></span><span style="display:flex;"><span>						n.maxParams = numParams
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>					numParams--
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>					<span style="color:#999;font-style:italic">// æ£€æµ‹é€šé…ç¬¦æ¨¡å¼æ˜¯å¦åŒ¹é…
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>					<span style="color:#6ab825;font-weight:bold">if</span> <span style="color:#24909d">len</span>(path) &gt;= <span style="color:#24909d">len</span>(n.path) &amp;&amp; n.path == path[:<span style="color:#24909d">len</span>(n.path)] &amp;&amp;
</span></span><span style="display:flex;"><span>						n.nType != catchAll &amp;&amp;
</span></span><span style="display:flex;"><span>						<span style="color:#999;font-style:italic">// æ£€æµ‹æ›´é•¿çš„é€šé…ç¬¦åŒ¹é…
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>						<span style="color:#999;font-style:italic">// (ä¾‹å¦‚å½“å‰èŠ‚ç‚¹çš„ path = name, å­èŠ‚ç‚¹çš„è·¯å¾„æ˜¯ path = names)
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>						(<span style="color:#24909d">len</span>(n.path) &gt;= <span style="color:#24909d">len</span>(path) || path[<span style="color:#24909d">len</span>(n.path)] == <span style="color:#ed9d13">&#39;/&#39;</span>) {
</span></span><span style="display:flex;"><span>						
</span></span><span style="display:flex;"><span>						<span style="color:#999;font-style:italic">// å¦‚æœé€šé…ç¬¦æ¨¡å¼åŒ¹é…ï¼Œè¿›å…¥ä¸‹ä¸€æ¬¡å¾ªç¯
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>						<span style="color:#6ab825;font-weight:bold">continue</span> walk
</span></span><span style="display:flex;"><span>					} <span style="color:#6ab825;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>						<span style="color:#999;font-style:italic">// é€šé…ç¬¦å‘ç”Ÿäº†å†²çª
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>						<span style="color:#999;font-style:italic">// (ä¾‹å¦‚å½“å‰èŠ‚ç‚¹çš„ path = /users/:id/profile, å­èŠ‚ç‚¹çš„è·¯å¾„æ˜¯ path = /users/:name/profile)
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>						<span style="color:#6ab825;font-weight:bold">var</span> pathSeg <span style="color:#6ab825;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>						
</span></span><span style="display:flex;"><span>						<span style="color:#999;font-style:italic">// å¦‚æœå½“å‰èŠ‚ç‚¹ç±»å‹æ˜¯é€šç”¨èŠ‚ç‚¹ (é€šé…ç¬¦ç±»å‹)
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>						<span style="color:#6ab825;font-weight:bold">if</span> n.nType == catchAll {
</span></span><span style="display:flex;"><span>							pathSeg = path
</span></span><span style="display:flex;"><span>						} <span style="color:#6ab825;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>							<span style="color:#999;font-style:italic">// å¦‚æœå½“å‰èŠ‚ç‚¹ç±»å‹ä¸æ˜¯é€šç”¨èŠ‚ç‚¹
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>							<span style="color:#999;font-style:italic">// å°† path å­—ç¬¦ä¸²è¿›è¡Œåˆ†å‰²
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>							<span style="color:#999;font-style:italic">// (ä¾‹å¦‚ path = /users/:id/profile, åˆ†å‰²ä¹‹å pathSeg = profile)
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>							pathSeg = strings.<span style="color:#447fcf">SplitN</span>(path, <span style="color:#ed9d13">&#34;/&#34;</span>, <span style="color:#3677a9">2</span>)[<span style="color:#3677a9">0</span>]
</span></span><span style="display:flex;"><span>						}
</span></span><span style="display:flex;"><span>						
</span></span><span style="display:flex;"><span>						<span style="color:#999;font-style:italic">// æå–å‡ºå‚æ•° path çš„å‰ç¼€
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>						<span style="color:#999;font-style:italic">// (ä¾‹å¦‚ fullPath = /users/:id/profile, å½“å‰èŠ‚ç‚¹ path = :id, prefix = /user/:id)
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>						prefix := fullPath[:strings.<span style="color:#447fcf">Index</span>(fullPath, pathSeg)] + n.path
</span></span><span style="display:flex;"><span>						
</span></span><span style="display:flex;"><span>						<span style="color:#999;font-style:italic">// ç›´æ¥æŠ›å‡ºä¸€ä¸ª panic
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>						<span style="color:#999;font-style:italic">// ä¿¡æ¯ä¸­ä¼šè¾“å‡ºäº§ç”Ÿå†²çªçš„å…·ä½“é€šé…ç¬¦ path
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>						<span style="color:#24909d">panic</span>(<span style="color:#ed9d13">&#34;&#39;&#34;</span> + pathSeg +
</span></span><span style="display:flex;"><span>							<span style="color:#ed9d13">&#34;&#39; in new path &#39;&#34;</span> + fullPath +
</span></span><span style="display:flex;"><span>							<span style="color:#ed9d13">&#34;&#39; conflicts with existing wildcard &#39;&#34;</span> + n.path +
</span></span><span style="display:flex;"><span>							<span style="color:#ed9d13">&#34;&#39; in existing prefix &#39;&#34;</span> + prefix +
</span></span><span style="display:flex;"><span>							<span style="color:#ed9d13">&#34;&#39;&#34;</span>)
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				
</span></span><span style="display:flex;"><span>				c := path[<span style="color:#3677a9">0</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				<span style="color:#999;font-style:italic">// å¦‚æœå½“å‰èŠ‚ç‚¹æ˜¯ä¸€ä¸ªå‚æ•°èŠ‚ç‚¹å¹¶ä¸”åªæœ‰ä¸€ä¸ªå­èŠ‚ç‚¹ å¹¶ä¸”å‚æ•° path æ˜¯ä»¥ &#34;/&#34; å¼€å¤´çš„
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>				<span style="color:#999;font-style:italic">// (ä¾‹å¦‚å½“å‰èŠ‚ç‚¹ path = /:name/profile, å‚æ•° path = /:name/setting)
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>				<span style="color:#6ab825;font-weight:bold">if</span> n.nType == param &amp;&amp; c == <span style="color:#ed9d13">&#39;/&#39;</span> &amp;&amp; <span style="color:#24909d">len</span>(n.children) == <span style="color:#3677a9">1</span> {
</span></span><span style="display:flex;"><span>					<span style="color:#999;font-style:italic">// å°†å½“å‰èŠ‚ç‚¹ä¿®æ”¹ä¸ºå…¶ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>					n = n.children[<span style="color:#3677a9">0</span>]
</span></span><span style="display:flex;"><span>					<span style="color:#999;font-style:italic">// ä¼˜å…ˆçº§ + 1
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>					n.priority++
</span></span><span style="display:flex;"><span>					<span style="color:#999;font-style:italic">// è¿›å…¥ä¸‹ä¸€æ¬¡å¾ªç¯
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>					<span style="color:#6ab825;font-weight:bold">continue</span> walk
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				<span style="color:#999;font-style:italic">// æ£€æµ‹æ–°å¢å­èŠ‚ç‚¹çš„ path çš„é¦–å­—æ¯æ˜¯å¦å­˜åœ¨äºå½“å‰èŠ‚ç‚¹çš„ indices å­—æ®µä¸­
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>				<span style="color:#6ab825;font-weight:bold">for</span> i := <span style="color:#3677a9">0</span>; i &lt; <span style="color:#24909d">len</span>(n.indices); i++ {
</span></span><span style="display:flex;"><span>					<span style="color:#6ab825;font-weight:bold">if</span> c == n.indices[i] {
</span></span><span style="display:flex;"><span>						<span style="color:#999;font-style:italic">// æ›´æ–°å­èŠ‚ç‚¹çš„ä¼˜å…ˆçº§
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>						i = n.<span style="color:#447fcf">incrementChildPrio</span>(i)
</span></span><span style="display:flex;"><span>						<span style="color:#999;font-style:italic">// æ›´æ–°å½“å‰èŠ‚ç‚¹ä¸ºå¯¹åº”çš„å­èŠ‚ç‚¹
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>						<span style="color:#999;font-style:italic">//  (
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>						<span style="color:#999;font-style:italic">//    ä¾‹å¦‚å½“å‰èŠ‚ç‚¹ path = p, åŒ…å«ä¸¤ä¸ªå­èŠ‚ç‚¹ rofile, assword)
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>						<span style="color:#999;font-style:italic">//    æ­¤æ—¶ indices å­—æ®µå°±åŒ…å«å­—ç¬¦ r å’Œ a, æ­£å¥½å’Œä¸¤ä¸ªå­èŠ‚ç‚¹ç›¸å¯¹åº”
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>						<span style="color:#999;font-style:italic">//    æ–°å¢å­èŠ‚ç‚¹çš„ path = projects, åˆ é™¤å’Œå½“å‰èŠ‚ç‚¹çš„å…¬å…±å‰ç¼€ç¬¦ p åï¼Œå˜æˆäº† rojects 
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>						<span style="color:#999;font-style:italic">//    ç„¶åå½“å‰èŠ‚ç‚¹ä¼šè¢«æ›´æ–°ä¸º rofile å­èŠ‚ç‚¹
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>						<span style="color:#999;font-style:italic">//    æœ€åï¼Œè·³è½¬åˆ°ä¸‹ä¸€æ¬¡å¾ªç¯ï¼Œç„¶åæ‹¿ rofile å’Œ rojects è¿›è¡Œå¯¹æ¯”
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>						<span style="color:#999;font-style:italic">//  )
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>						n = n.children[i]
</span></span><span style="display:flex;"><span>						
</span></span><span style="display:flex;"><span>						<span style="color:#999;font-style:italic">// è¿›å…¥ä¸‹ä¸€æ¬¡å¾ªç¯
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>						<span style="color:#6ab825;font-weight:bold">continue</span> walk
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				<span style="color:#999;font-style:italic">// å¦‚æœä¸Šé¢çš„æ¡ä»¶éƒ½ä¸æ»¡è¶³
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>				<span style="color:#999;font-style:italic">// ç›´æ¥å°†æ–°çš„å­èŠ‚ç‚¹æ’å…¥
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>				<span style="color:#6ab825;font-weight:bold">if</span> c != <span style="color:#ed9d13">&#39;:&#39;</span> &amp;&amp; c != <span style="color:#ed9d13">&#39;*&#39;</span> {
</span></span><span style="display:flex;"><span>					<span style="color:#999;font-style:italic">// å¦‚æœå‚æ•° path çš„ç¬¬ä¸€ä¸ªå­—ç¬¦ä¸æ˜¯é€šé…ç¬¦
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>					<span style="color:#999;font-style:italic">// å°†ç¬¬ä¸€ä¸ªå­—ç¬¦è¿½åŠ åˆ°å½“å‰èŠ‚ç‚¹çš„ indices å­—æ®µ 
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>					n.indices += <span style="color:#24909d">string</span>([]<span style="color:#6ab825;font-weight:bold">byte</span>{c})
</span></span><span style="display:flex;"><span>					
</span></span><span style="display:flex;"><span>					<span style="color:#999;font-style:italic">// åˆå§‹åŒ–ä¸€ä¸ªæ–°çš„å­èŠ‚ç‚¹
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>					child := &amp;node{
</span></span><span style="display:flex;"><span>						maxParams: numParams,
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>					
</span></span><span style="display:flex;"><span>					<span style="color:#999;font-style:italic">// å°†æ–°çš„å­èŠ‚ç‚¹è¿½åŠ åˆ°å½“å‰èŠ‚ç‚¹çš„å­èŠ‚ç‚¹åˆ—è¡¨ä¸­
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>					n.children = <span style="color:#24909d">append</span>(n.children, child)
</span></span><span style="display:flex;"><span>                    <span style="color:#999;font-style:italic">// æ›´æ–°å­èŠ‚ç‚¹çš„ä¼˜å…ˆçº§ 
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>					n.<span style="color:#447fcf">incrementChildPrio</span>(<span style="color:#24909d">len</span>(n.indices) - <span style="color:#3677a9">1</span>)
</span></span><span style="display:flex;"><span>					<span style="color:#999;font-style:italic">// æ›´æ–°å½“å‰èŠ‚ç‚¹ä¸ºæ–°å¢çš„å­èŠ‚ç‚¹
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>					n = child
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				
</span></span><span style="display:flex;"><span>				n.<span style="color:#447fcf">insertChild</span>(numParams, path, fullPath, handle)
</span></span><span style="display:flex;"><span>				<span style="color:#6ab825;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			} <span style="color:#6ab825;font-weight:bold">else</span> <span style="color:#6ab825;font-weight:bold">if</span> i == <span style="color:#24909d">len</span>(path) { 
</span></span><span style="display:flex;"><span>				<span style="color:#999;font-style:italic">// å¦‚æœå…¬å…±å‰ç¼€å’Œå‚æ•° path é•¿åº¦ç›¸åŒ
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>				<span style="color:#999;font-style:italic">// è¯´æ˜å‚æ•° path æœ¬èº«å°±æ˜¯å½“å‰èŠ‚ç‚¹ path çš„ä¸€éƒ¨åˆ†
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>				<span style="color:#6ab825;font-weight:bold">if</span> n.handle != <span style="color:#6ab825;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>					<span style="color:#999;font-style:italic">// å¦‚æœå½“å‰èŠ‚ç‚¹å·²ç»æ³¨å†Œäº†è·¯ç”±å¤„ç†æ–¹æ³•
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>					<span style="color:#999;font-style:italic">// é‚£ä¹ˆå†æ¬¡æ³¨å†Œæ—¶ç­‰äºé‡å¤æ³¨å†Œ
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>					<span style="color:#999;font-style:italic">// ç›´æ¥æŠ›å‡º panic
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>					<span style="color:#24909d">panic</span>(<span style="color:#ed9d13">&#34;a handle is already registered for path &#39;&#34;</span> + fullPath + <span style="color:#ed9d13">&#34;&#39;&#34;</span>)
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				
</span></span><span style="display:flex;"><span>				<span style="color:#999;font-style:italic">// å¦‚æœå½“å‰èŠ‚ç‚¹æ²¡æœ‰æ³¨å†Œè·¯ç”±å¤„ç†æ–¹æ³•
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>				<span style="color:#999;font-style:italic">// è¯´æ˜å½“å‰èŠ‚ç‚¹æ˜¯ä½œä¸ºå…¶å­èŠ‚ç‚¹çš„å…¬å…±å‰ç¼€ç¬¦è€Œå­˜åœ¨çš„
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>				<span style="color:#999;font-style:italic">// (ä¾‹å¦‚ å½“å‰èŠ‚ç‚¹ path = p, åŒ…å«ä¸¤ä¸ªå­èŠ‚ç‚¹ rofile, assword))
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>				n.handle = handle
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#6ab825;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	} <span style="color:#6ab825;font-weight:bold">else</span> { 
</span></span><span style="display:flex;"><span>		<span style="color:#999;font-style:italic">// å¦‚æœå½“å‰èŠ‚ç‚¹æ˜¯ä¸€ä¸ªç©ºèŠ‚ç‚¹
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>		<span style="color:#999;font-style:italic">// è¯´æ˜å½“å‰ Radix Tree æ²¡æœ‰ä»»ä½•èŠ‚ç‚¹
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>		<span style="color:#999;font-style:italic">// ç›´æ¥æ’å…¥ä¸€ä¸ªæ–°èŠ‚ç‚¹
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>		<span style="color:#999;font-style:italic">// å¹¶ä¸”å°†æ’å…¥çš„æ–°èŠ‚ç‚¹ç±»å‹æ ‡è®°ä¸º root
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>		<span style="color:#999;font-style:italic">// PS: ç¬”è€…è®¤ä¸ºè¿™ä¸¤è¡Œè¾¹ç•Œæ£€æµ‹ä»£ç åº”è¯¥æ”¾åœ¨å‡½æ•°å¼€å¤´éƒ¨åˆ†ï¼Œæé«˜å¯è¯»æ€§
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>		n.<span style="color:#447fcf">insertChild</span>(numParams, path, fullPath, handle)
</span></span><span style="display:flex;"><span>		n.nType = root
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>incrementChildPrio æ–¹æ³•ç”¨äºæ›´æ–°ç»™å®šå­èŠ‚ç‚¹çš„ä¼˜å…ˆçº§ï¼Œå¹¶åœ¨å¿…è¦çš„æ—¶å€™è¿›è¡Œæ’åºã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">func</span> (n *node) <span style="color:#447fcf">incrementChildPrio</span>(pos <span style="color:#6ab825;font-weight:bold">int</span>) <span style="color:#6ab825;font-weight:bold">int</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#999;font-style:italic">// å°†å¯¹åº”ç´¢å¼•çš„å­èŠ‚ç‚¹çš„ä¼˜å…ˆçº§ + 1
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	n.children[pos].priority++
</span></span><span style="display:flex;"><span>	prio := n.children[pos].priority
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#999;font-style:italic">// å‘å‰ç§»åŠ¨ä½ç½®
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	<span style="color:#999;font-style:italic">// (ä¾‹å¦‚åŸæœ¬çš„å­èŠ‚ç‚¹é¡ºåºä¸º [a, b, c, d], æ­¤æ—¶ä¼ å…¥å‚æ•° 2, ç§»åŠ¨ä¹‹åçš„å­èŠ‚ç‚¹é¡ºåºä¸º [c, a, b, d])
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	newPos := pos
</span></span><span style="display:flex;"><span>	<span style="color:#6ab825;font-weight:bold">for</span> newPos &gt; <span style="color:#3677a9">0</span> &amp;&amp; n.children[newPos-<span style="color:#3677a9">1</span>].priority &lt; prio {
</span></span><span style="display:flex;"><span>		n.children[newPos-<span style="color:#3677a9">1</span>], n.children[newPos] = n.children[newPos], n.children[newPos-<span style="color:#3677a9">1</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		newPos--
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#999;font-style:italic">// æ›´æ–°å½“å‰èŠ‚ç‚¹çš„ indices å­—æ®µä¿¡æ¯
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	<span style="color:#999;font-style:italic">// (ä¾‹å¦‚åŸæœ¬çš„ indices å­—æ®µä¸º abcd, æ­¤æ—¶ä¼ å…¥å‚æ•° 2, ç§»åŠ¨ä¹‹åçš„ indices å­—æ®µä¸º cabd
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	<span style="color:#6ab825;font-weight:bold">if</span> newPos != pos {
</span></span><span style="display:flex;"><span>		n.indices = n.indices[:newPos] + <span style="color:#999;font-style:italic">// unchanged prefix, might be empty
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>			n.indices[pos:pos+<span style="color:#3677a9">1</span>] + <span style="color:#999;font-style:italic">// the index char we move
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>			n.indices[newPos:pos] + n.indices[pos+<span style="color:#3677a9">1</span>:] <span style="color:#999;font-style:italic">// rest without char at &#39;pos&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	}
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#999;font-style:italic">// è¿”å›ç§»åŠ¨åçš„æ–°çš„ä½ç½®
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	<span style="color:#6ab825;font-weight:bold">return</span> newPos
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>insertChild æ–¹æ³•è´Ÿè´£æ‰§è¡Œå°†å…·ä½“çš„ path æ’å…¥åˆ°èŠ‚ç‚¹ä¸­ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">func</span> (n *node) <span style="color:#447fcf">insertChild</span>(numParams <span style="color:#6ab825;font-weight:bold">uint8</span>, path, fullPath <span style="color:#6ab825;font-weight:bold">string</span>, handle Handle) {
</span></span><span style="display:flex;"><span>	<span style="color:#999;font-style:italic">// å‚æ•° path å·²ç»å¤„ç†å®Œçš„è®¡ç®—æ•°é‡ 
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	<span style="color:#6ab825;font-weight:bold">var</span> offset <span style="color:#6ab825;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#999;font-style:italic">// æŸ¥æ‰¾å‰ç¼€ç›´åˆ°ç¬¬ä¸€ä¸ªå‚æ•°åŒ¹é…æˆ–è€…é€šé…ç¬¦ (ä»¥ &#39;:&#39; æˆ– &#39;*&#39; å¼€å¤´)
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	<span style="color:#999;font-style:italic">// å‚æ•°åŒ¹é… (ç±»ä¼¼è¿™ç§å½¢å¼ :name)
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	<span style="color:#999;font-style:italic">// é€šé…ç¬¦ (ç±»ä¼¼è¿™ç§å½¢å¼ *logs)
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	<span style="color:#999;font-style:italic">// ä¸ºäº†ä¾¿äºæè¿°ï¼Œä¸‹æ–‡ä¸­ç»Ÿä¸€å°† å‚æ•°åŒ¹é…ç¬¦å· å’Œ é€šé…ç¬¦å· ç»Ÿç§°ä¸º Token
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	<span style="color:#6ab825;font-weight:bold">for</span> i, max := <span style="color:#3677a9">0</span>, <span style="color:#24909d">len</span>(path); numParams &gt; <span style="color:#3677a9">0</span>; i++ {
</span></span><span style="display:flex;"><span>		c := path[i]
</span></span><span style="display:flex;"><span>		<span style="color:#6ab825;font-weight:bold">if</span> c != <span style="color:#ed9d13">&#39;:&#39;</span> &amp;&amp; c != <span style="color:#ed9d13">&#39;*&#39;</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#999;font-style:italic">// å¦‚æœä¸æ˜¯ &#39;:&#39; æˆ– &#39;*&#39;, ç›´æ¥è·³è¿‡
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>			<span style="color:#6ab825;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#999;font-style:italic">// æŸ¥æ‰¾å½“å‰ Token ç»“æŸç¬¦, ä¹Ÿå°±æ˜¯ä¸‹ä¸€ä¸ª &#39;/&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>		<span style="color:#999;font-style:italic">// (ä¾‹å¦‚ Token ä¸º /:name/profile, æŸ¥æ‰¾çš„å°±æ˜¯ :name åé¢çš„ / ç¬¦å·)
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>		end := i + <span style="color:#3677a9">1</span>
</span></span><span style="display:flex;"><span>		<span style="color:#6ab825;font-weight:bold">for</span> end &lt; max &amp;&amp; path[end] != <span style="color:#ed9d13">&#39;/&#39;</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#6ab825;font-weight:bold">switch</span> path[end] {
</span></span><span style="display:flex;"><span>			<span style="color:#999;font-style:italic">// å¦‚æœ Token ä¸­åµŒå¥— Tokenï¼Œç›´æ¥ panic
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>            <span style="color:#999;font-style:italic">// (ä¾‹å¦‚ /:name:id)
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>			<span style="color:#6ab825;font-weight:bold">case</span> <span style="color:#ed9d13">&#39;:&#39;</span>, <span style="color:#ed9d13">&#39;*&#39;</span>:
</span></span><span style="display:flex;"><span>				<span style="color:#24909d">panic</span>(<span style="color:#ed9d13">&#34;only one wildcard per path segment is allowed, has: &#39;&#34;</span> +
</span></span><span style="display:flex;"><span>					path[i:] + <span style="color:#ed9d13">&#34;&#39; in path &#39;&#34;</span> + fullPath + <span style="color:#ed9d13">&#34;&#39;&#34;</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#6ab825;font-weight:bold">default</span>:
</span></span><span style="display:flex;"><span>				end++
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#999;font-style:italic">// å¦‚æœ Token æ‰€åœ¨çš„ç´¢å¼•ä½ç½®å·²ç»æœ‰èŠ‚ç‚¹äº†ï¼Œç›´æ¥ panic 
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>		<span style="color:#999;font-style:italic">// (ä¾‹å¦‚å·²ç»å­˜åœ¨äº†èŠ‚ç‚¹ path = /users/dbwu, å°±ä¸èƒ½å†å®šä¹‰ path = /user/:name)
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>		<span style="color:#6ab825;font-weight:bold">if</span> <span style="color:#24909d">len</span>(n.children) &gt; <span style="color:#3677a9">0</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#24909d">panic</span>(<span style="color:#ed9d13">&#34;wildcard route &#39;&#34;</span> + path[i:end] +
</span></span><span style="display:flex;"><span>				<span style="color:#ed9d13">&#34;&#39; conflicts with existing children in path &#39;&#34;</span> + fullPath + <span style="color:#ed9d13">&#34;&#39;&#34;</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#999;font-style:italic">// Token è‡³å°‘éœ€è¦ä¸€ä¸ªå­—ç¬¦è¡¨ç¤ºçš„å‚æ•°åç§°, å¦åˆ™ç›´æ¥ panic
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>		<span style="color:#999;font-style:italic">// (ä¾‹å¦‚ :name, :id ä¸­çš„ name å’Œ id å°±æ˜¯ Token çš„å‚æ•°åç§°)
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>		<span style="color:#6ab825;font-weight:bold">if</span> end-i &lt; <span style="color:#3677a9">2</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#24909d">panic</span>(<span style="color:#ed9d13">&#34;wildcards must be named with a non-empty name in path &#39;&#34;</span> + fullPath + <span style="color:#ed9d13">&#34;&#39;&#34;</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#999;font-style:italic">// å¦‚æœ Token çš„ç±»å‹æ˜¯å‚æ•°åŒ¹é…ç¬¦
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>		<span style="color:#6ab825;font-weight:bold">if</span> c == <span style="color:#ed9d13">&#39;:&#39;</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#999;font-style:italic">// å°†å½“å‰èŠ‚ç‚¹çš„ä½ç½®æ›´æ–°ä¸º ä» offset åˆ°å½“å‰ç´¢å¼•ä½ç½®ä¹‹é—´çš„ pathï¼Œ
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>			<span style="color:#6ab825;font-weight:bold">if</span> i &gt; <span style="color:#3677a9">0</span> {
</span></span><span style="display:flex;"><span>				n.path = path[offset:i]
</span></span><span style="display:flex;"><span>				<span style="color:#999;font-style:italic">// æ›´æ–° offset
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>				offset = i
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#999;font-style:italic">// æ ¹æ®å‚æ•°åˆå§‹åŒ–ä¸€ä¸ªæ–°çš„å­èŠ‚ç‚¹
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>			child := &amp;node{
</span></span><span style="display:flex;"><span>				nType:     param,
</span></span><span style="display:flex;"><span>				maxParams: numParams,
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			
</span></span><span style="display:flex;"><span>			<span style="color:#999;font-style:italic">// æ›´æ–°å½“å‰èŠ‚ç‚¹çš„å­èŠ‚ç‚¹
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>			n.children = []*node{child}
</span></span><span style="display:flex;"><span>			<span style="color:#999;font-style:italic">// æ›´æ–°å½“å‰èŠ‚ç‚¹ç±»å‹ä¸ºå‚æ•°èŠ‚ç‚¹
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>			n.wildChild = <span style="color:#6ab825;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>			<span style="color:#999;font-style:italic">// å½“å‰èŠ‚ç‚¹ä¸‹é™ä¸ºå­èŠ‚ç‚¹ï¼Œç»§ç»­åé¢çš„è·¯ç”±å¤„ç†
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>			n = child
</span></span><span style="display:flex;"><span>			
</span></span><span style="display:flex;"><span>			<span style="color:#999;font-style:italic">// å½“å‰èŠ‚ç‚¹ä¼˜å…ˆçº§ + 1
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>			n.priority++
</span></span><span style="display:flex;"><span>			<span style="color:#999;font-style:italic">// æœ€å¤§å‚æ•°ä¸ªæ•° - 1
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>			numParams--
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#999;font-style:italic">// å¦‚æœ Token ç»“æŸç¬¦æ¯”å‚æ•° path é•¿åº¦è¦å°
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>			<span style="color:#999;font-style:italic">// è¯´æ˜å‚æ•° path ä¸­è¿˜æœ‰å­è·¯å¾„
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>			<span style="color:#6ab825;font-weight:bold">if</span> end &lt; max {
</span></span><span style="display:flex;"><span>				<span style="color:#999;font-style:italic">// æ›´æ–°å½“å‰èŠ‚ç‚¹ path 
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>				n.path = path[offset:end]
</span></span><span style="display:flex;"><span>				<span style="color:#999;font-style:italic">// æ›´æ–° offset
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>				offset = end
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				<span style="color:#999;font-style:italic">// åˆå§‹åŒ–ä¸€ä¸ªæ–°èŠ‚ç‚¹ä½œä¸ºå‚æ•° path ä¸­çš„å­è·¯å¾„èŠ‚ç‚¹
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>				child := &amp;node{
</span></span><span style="display:flex;"><span>					maxParams: numParams,
</span></span><span style="display:flex;"><span>					priority:  <span style="color:#3677a9">1</span>,
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				<span style="color:#999;font-style:italic">// æ›´æ–°å½“å‰èŠ‚ç‚¹çš„å­èŠ‚ç‚¹
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>				n.children = []*node{child}
</span></span><span style="display:flex;"><span>				<span style="color:#999;font-style:italic">// å½“å‰èŠ‚ç‚¹ä¸‹é™ä¸ºå­èŠ‚ç‚¹ï¼Œç»§ç»­åé¢çš„è·¯ç”±å¤„ç†
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>				n = child
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		} <span style="color:#6ab825;font-weight:bold">else</span> { <span style="color:#999;font-style:italic">// å¦‚æœ Token çš„ç±»å‹æ˜¯é€šé…ç¬¦
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>            
</span></span><span style="display:flex;"><span>			<span style="color:#6ab825;font-weight:bold">if</span> end != max || numParams &gt; <span style="color:#3677a9">1</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#999;font-style:italic">// é€šé…ç¬¦ç±»å‹çš„è·¯å¾„å¿…é¡»ä½äºè·¯ç”± path çš„æœ€åä¸€éƒ¨åˆ†ï¼Œå¦åˆ™ç›´æ¥ panic
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>				<span style="color:#999;font-style:italic">// (
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>				<span style="color:#999;font-style:italic">//   ä¾‹å¦‚ /users/*name æ˜¯åˆæ³•çš„ï¼Œä½†æ˜¯ /users/*name/profile ä¸æ˜¯åˆæ³•çš„ï¼Œå› ä¸ºè¿™æ ·å°±æ— æ³•åŒºåˆ†å…¶ä»–è·¯ç”±äº†
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>				<span style="color:#999;font-style:italic">//   ä¾‹å¦‚ path = /users/dbwu/profile æ˜¯ä¸€ä¸ªå•ç‹¬çš„ path, ä½†æ˜¯å´åŒ¹é…äº† /users/*name è¿™ä¸ª path
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>				<span style="color:#999;font-style:italic">//   å› æ­¤è·å–åˆ°çš„å‚æ•° name = &#34;dbwu/profile&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>				<span style="color:#999;font-style:italic">//   æ‰€ä»¥ä¸ä¼šå†å°†åé¢çš„ /dbwu/profile ä½œä¸ºå•ç‹¬è·¯å¾„æ¥å¤„ç†äº†
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>				<span style="color:#999;font-style:italic">// )
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>				<span style="color:#24909d">panic</span>(<span style="color:#ed9d13">&#34;catch-all routes are only allowed at the end of the path in path &#39;&#34;</span> + fullPath + <span style="color:#ed9d13">&#34;&#39;&#34;</span>)
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			
</span></span><span style="display:flex;"><span>			<span style="color:#6ab825;font-weight:bold">if</span> <span style="color:#24909d">len</span>(n.path) &gt; <span style="color:#3677a9">0</span> &amp;&amp; n.path[<span style="color:#24909d">len</span>(n.path)-<span style="color:#3677a9">1</span>] == <span style="color:#ed9d13">&#39;/&#39;</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#999;font-style:italic">// æ–°å®šä¹‰çš„é€šé…ç¬¦å’Œå·²æœ‰çš„é€šé…ç¬¦å†²çªäº†ï¼Œç›´æ¥ panic
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>				<span style="color:#999;font-style:italic">// (ä¾‹å¦‚ä¸€ä¸ªå·²æœ‰çš„ path = /users/dbwu, æ–°å®šä¹‰çš„ path = /users/:name, å¦‚æœä¸ç»ˆæ­¢ï¼Œåè€…å°±ä¼šè¦†ç›–å‰è€…)
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>				<span style="color:#24909d">panic</span>(<span style="color:#ed9d13">&#34;catch-all conflicts with existing handle for the path segment root in path &#39;&#34;</span> + fullPath + <span style="color:#ed9d13">&#34;&#39;&#34;</span>)
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			i--
</span></span><span style="display:flex;"><span>			<span style="color:#6ab825;font-weight:bold">if</span> path[i] != <span style="color:#ed9d13">&#39;/&#39;</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#999;font-style:italic">// å¦‚æœé€šé…ç¬¦å‰é¢æ²¡æœ‰ &#39;/&#39;, ç›´æ¥ panic
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>				<span style="color:#24909d">panic</span>(<span style="color:#ed9d13">&#34;no / before catch-all in path &#39;&#34;</span> + fullPath + <span style="color:#ed9d13">&#34;&#39;&#34;</span>)
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			n.path = path[offset:i]
</span></span><span style="display:flex;"><span>			
</span></span><span style="display:flex;"><span>			<span style="color:#999;font-style:italic">// åˆå§‹åŒ–ä¸€ä¸ªæ–°çš„å­èŠ‚ç‚¹ï¼Œç±»å‹ä¸ºé€šé…ç¬¦èŠ‚ç‚¹
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>			child := &amp;node{
</span></span><span style="display:flex;"><span>				wildChild: <span style="color:#6ab825;font-weight:bold">true</span>,
</span></span><span style="display:flex;"><span>				nType:     catchAll,
</span></span><span style="display:flex;"><span>				maxParams: <span style="color:#3677a9">1</span>,
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#999;font-style:italic">// æ›´æ–°å½“å‰èŠ‚ç‚¹çš„æœ€å¤§å‚æ•°ä¸ªæ•°
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>			<span style="color:#6ab825;font-weight:bold">if</span> n.maxParams &lt; <span style="color:#3677a9">1</span> {
</span></span><span style="display:flex;"><span>				n.maxParams = <span style="color:#3677a9">1</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#999;font-style:italic">// æ›´æ–°å½“å‰èŠ‚ç‚¹çš„å­èŠ‚ç‚¹
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>			n.children = []*node{child}
</span></span><span style="display:flex;"><span>			<span style="color:#999;font-style:italic">// æ›´æ–°å½“å‰èŠ‚ç‚¹çš„ indices å­—æ®µ
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>			n.indices = <span style="color:#24909d">string</span>(path[i])
</span></span><span style="display:flex;"><span>			<span style="color:#999;font-style:italic">// å½“å‰èŠ‚ç‚¹ä¸‹é™ä¸ºå­èŠ‚ç‚¹ï¼Œç»§ç»­åé¢çš„è·¯ç”±å¤„ç†
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>			n = child
</span></span><span style="display:flex;"><span>			<span style="color:#999;font-style:italic">// å½“å‰èŠ‚ç‚¹ä¼˜å…ˆçº§ + 1
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>			n.priority++
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#999;font-style:italic">// åˆå§‹åŒ–ä¸€ä¸ªæ–°èŠ‚ç‚¹ä½œä¸ºå‚æ•° path ä¸­çš„å‰©ä½™éƒ¨åˆ†çš„èŠ‚ç‚¹
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>			child = &amp;node{
</span></span><span style="display:flex;"><span>				path:      path[i:],
</span></span><span style="display:flex;"><span>				nType:     catchAll,
</span></span><span style="display:flex;"><span>				maxParams: <span style="color:#3677a9">1</span>,
</span></span><span style="display:flex;"><span>				handle:    handle,  <span style="color:#999;font-style:italic">// ç»‘å®šè·¯ç”±çš„å¤„ç†å‡½æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>				priority:  <span style="color:#3677a9">1</span>,
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#999;font-style:italic">// æ›´æ–°å½“å‰èŠ‚ç‚¹çš„å­èŠ‚ç‚¹
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>			n.children = []*node{child}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#999;font-style:italic">// é€šé…ç¬¦ç±»å‹çš„è·¯å¾„å¿…é¡»ä½äºè·¯ç”± path çš„æœ€åä¸€éƒ¨åˆ†
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>			<span style="color:#999;font-style:italic">// ç›´æ¥è¿”å›å³å¯
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>			<span style="color:#6ab825;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#999;font-style:italic">// æ›´æ–°å½“å‰èŠ‚ç‚¹çš„ path
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	n.path = path[offset:]
</span></span><span style="display:flex;"><span>	<span style="color:#999;font-style:italic">// æ›´æ–°å½“å‰èŠ‚ç‚¹çš„å¤„ç†å‡½æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	n.handle = handle
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="æŸ¥æ‰¾è·¯ç”±å¤„ç†æ–¹æ³•">æŸ¥æ‰¾è·¯ç”±å¤„ç†æ–¹æ³•</h4>
<p>getValue æ–¹æ³•æ ¹æ®æŒ‡å®šçš„ pathï¼ŒæŸ¥æ‰¾å¹¶è¿”å›å¯¹åº”çš„è·¯ç”±å¤„ç†æ–¹æ³•ã€‚</p>
<p>è¿”å›å€¼åˆ—è¡¨é¡ºåºå¦‚ä¸‹:</p>
<ul>
<li>handle : path å¯¹åº”çš„å¤„ç†æ–¹æ³•ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œè¿”å› nil</li>
<li>p      : å¦‚æœ path å¯¹åº”çš„èŠ‚ç‚¹ç±»å‹æ˜¯å‚æ•°èŠ‚ç‚¹ï¼Œä¼šå°†å‚æ•°è¿”å›</li>
<li>tsr    : è·¯ç”±æ˜¯å¦å¯ä»¥è¢«é‡å®šå‘</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">func</span> (n *node) <span style="color:#447fcf">getValue</span>(path <span style="color:#6ab825;font-weight:bold">string</span>) (handle Handle, p Params, tsr <span style="color:#6ab825;font-weight:bold">bool</span>) {
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#999;font-style:italic">// å¾ªç¯æ ‡ç­¾
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>walk: 
</span></span><span style="display:flex;"><span>	<span style="color:#6ab825;font-weight:bold">for</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#999;font-style:italic">// å¦‚æœè¦æŸ¥æ‰¾çš„ path é•¿åº¦å¤§äºå½“å‰èŠ‚ç‚¹çš„ path é•¿åº¦
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>		<span style="color:#999;font-style:italic">// é™¤äº†æ ¹è·¯å¾„ /, å…¶ä»– path åº”è¯¥éƒ½å¯ä»¥æ»¡è¶³è¿™ä¸ªæ¡ä»¶
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>		<span style="color:#6ab825;font-weight:bold">if</span> <span style="color:#24909d">len</span>(path) &gt; <span style="color:#24909d">len</span>(n.path) {
</span></span><span style="display:flex;"><span>			<span style="color:#999;font-style:italic">// å¦‚æœå½“å‰èŠ‚ç‚¹çš„ path æ˜¯è¦æŸ¥æ‰¾çš„ path çš„å‰ç¼€
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>			<span style="color:#6ab825;font-weight:bold">if</span> path[:<span style="color:#24909d">len</span>(n.path)] == n.path {
</span></span><span style="display:flex;"><span>				<span style="color:#999;font-style:italic">// é‚£ä¹ˆå°±å°†å‰ç¼€å»æ‰ï¼ŒæŸ¥æ‰¾å‰©ä½™çš„éƒ¨åˆ†
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>				path = path[<span style="color:#24909d">len</span>(n.path):]
</span></span><span style="display:flex;"><span>				
</span></span><span style="display:flex;"><span>				<span style="color:#999;font-style:italic">// å¦‚æœå½“å‰èŠ‚ç‚¹ç±»å‹ä¸æ˜¯å‚æ•°èŠ‚ç‚¹
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>				<span style="color:#999;font-style:italic">// ç›´æ¥åœ¨å…¶å­èŠ‚ç‚¹ä¸­æŸ¥æ‰¾å³å¯
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>				<span style="color:#6ab825;font-weight:bold">if</span> !n.wildChild {
</span></span><span style="display:flex;"><span>					<span style="color:#999;font-style:italic">// é€šè¿‡è¦æŸ¥æ‰¾ path çš„é¦–å­—æ¯å¿«é€ŸåŒ¹é…å¯¹åº”çš„å­èŠ‚ç‚¹
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>					c := path[<span style="color:#3677a9">0</span>]
</span></span><span style="display:flex;"><span>					<span style="color:#6ab825;font-weight:bold">for</span> i := <span style="color:#3677a9">0</span>; i &lt; <span style="color:#24909d">len</span>(n.indices); i++ {
</span></span><span style="display:flex;"><span>						<span style="color:#6ab825;font-weight:bold">if</span> c == n.indices[i] {
</span></span><span style="display:flex;"><span>							<span style="color:#999;font-style:italic">// æ›´æ–°å½“å‰èŠ‚ç‚¹
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>							n = n.children[i]
</span></span><span style="display:flex;"><span>							<span style="color:#999;font-style:italic">// è·³è½¬åˆ°ä¸‹ä¸€ä¸ªå¾ªç¯
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>							<span style="color:#6ab825;font-weight:bold">continue</span> walk
</span></span><span style="display:flex;"><span>						}
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>					<span style="color:#999;font-style:italic">// ä»£ç æ‰§è¡Œåˆ°è¿™é‡Œï¼Œè¯´æ˜æ²¡æœ‰åŒ¹é…åˆ°å­èŠ‚ç‚¹
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>					<span style="color:#999;font-style:italic">// å¦‚æœè·¯å¾„å‰©ä½™çš„éƒ¨åˆ†æ­£å¥½æ˜¯ &#39;/&#39;, å¹¶ä¸”å½“å‰èŠ‚ç‚¹æ³¨å†Œäº†è·¯ç”±å¤„ç†æ–¹æ³•
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>					<span style="color:#999;font-style:italic">// æ›´æ–° tsr é‡å®šå‘æ ‡è®°ä¸º true
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>					<span style="color:#999;font-style:italic">// (ä¾‹å¦‚æŸ¥æ‰¾çš„ path = /users/, å½“å‰èŠ‚ç‚¹ path = /users, é‚£ä¹ˆå°±é‡å®šå‘åˆ° /users)
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>					tsr = (path == <span style="color:#ed9d13">&#34;/&#34;</span> &amp;&amp; n.handle != <span style="color:#6ab825;font-weight:bold">nil</span>)
</span></span><span style="display:flex;"><span>					<span style="color:#6ab825;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				<span style="color:#999;font-style:italic">// å¦‚æœå½“å‰èŠ‚ç‚¹ç±»å‹æ˜¯å‚æ•°èŠ‚ç‚¹æˆ–è€…é€šé…ç¬¦èŠ‚ç‚¹
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>				<span style="color:#999;font-style:italic">// é‚£ä¹ˆå½“å‰èŠ‚ç‚¹åªä¼šæœ‰ä¸€ä¸ªå­èŠ‚ç‚¹
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>				<span style="color:#999;font-style:italic">// æ›´æ–°å½“å‰èŠ‚ç‚¹ä¸ºå…¶ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>				n = n.children[<span style="color:#3677a9">0</span>]
</span></span><span style="display:flex;"><span>				
</span></span><span style="display:flex;"><span>				<span style="color:#6ab825;font-weight:bold">switch</span> n.nType {
</span></span><span style="display:flex;"><span>				<span style="color:#999;font-style:italic">// å¦‚æœå½“å‰èŠ‚ç‚¹ç±»å‹æ˜¯å‚æ•°èŠ‚ç‚¹
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>				<span style="color:#999;font-style:italic">// å‚æ•°åŒ¹é… (ç±»ä¼¼è¿™ç§å½¢å¼ :name)
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>				<span style="color:#6ab825;font-weight:bold">case</span> param:
</span></span><span style="display:flex;"><span>					<span style="color:#999;font-style:italic">// æŸ¥æ‰¾è·¯å¾„ä¸­çš„å‚æ•°ç»“æŸç¬¦æˆ–è€… &#39;/&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>					end := <span style="color:#3677a9">0</span>
</span></span><span style="display:flex;"><span>					<span style="color:#6ab825;font-weight:bold">for</span> end &lt; <span style="color:#24909d">len</span>(path) &amp;&amp; path[end] != <span style="color:#ed9d13">&#39;/&#39;</span> {
</span></span><span style="display:flex;"><span>						end++
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>					<span style="color:#6ab825;font-weight:bold">if</span> p == <span style="color:#6ab825;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>						<span style="color:#999;font-style:italic">// æƒ°æ€§åˆå§‹åŒ–å‚æ•°è¿”å›å€¼
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>						<span style="color:#999;font-style:italic">// æ³¨æ„åˆå§‹åŒ–çš„æ—¶å€™å·²ç»æŒ‡å®šäº†åˆ‡ç‰‡å®¹é‡
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>						p = <span style="color:#24909d">make</span>(Params, <span style="color:#3677a9">0</span>, n.maxParams)
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>					
</span></span><span style="display:flex;"><span>					<span style="color:#999;font-style:italic">// ä¸ºå‚æ•°è¿”å›å€¼èµ‹å€¼
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>					i := <span style="color:#24909d">len</span>(p)
</span></span><span style="display:flex;"><span>					p = p[:i+<span style="color:#3677a9">1</span>]
</span></span><span style="display:flex;"><span>					p[i].Key = n.path[<span style="color:#3677a9">1</span>:]
</span></span><span style="display:flex;"><span>					p[i].Value = path[:end]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>					<span style="color:#999;font-style:italic">// å¦‚æœè·¯å¾„è¿˜æ²¡æœ‰åŒ¹é…å®Œï¼Œ
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>					<span style="color:#6ab825;font-weight:bold">if</span> end &lt; <span style="color:#24909d">len</span>(path) {
</span></span><span style="display:flex;"><span>                        <span style="color:#999;font-style:italic">// å¦‚æœå­èŠ‚ç‚¹ä¸‹é¢è¿˜å­˜åœ¨å­èŠ‚ç‚¹
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>                        <span style="color:#999;font-style:italic">// (ä¾‹å¦‚ path = /users/:name/:setting, å½“å‰åŒ¹é…åˆ° :name, å‘ç°å…¶è¿˜æœ‰å­èŠ‚ç‚¹)
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>                        <span style="color:#6ab825;font-weight:bold">if</span> <span style="color:#24909d">len</span>(n.children) &gt; <span style="color:#3677a9">0</span> {
</span></span><span style="display:flex;"><span>							<span style="color:#999;font-style:italic">// æ›´æ–°æŸ¥æ‰¾è·¯å¾„
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>							path = path[end:]
</span></span><span style="display:flex;"><span>							<span style="color:#999;font-style:italic">// æ›´æ–°å½“å‰èŠ‚ç‚¹ä¸ºå…¶ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>							n = n.children[<span style="color:#3677a9">0</span>]
</span></span><span style="display:flex;"><span>							<span style="color:#999;font-style:italic">// è·³è½¬åˆ°ä¸‹ä¸€ä¸ªå¾ªç¯
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>							<span style="color:#6ab825;font-weight:bold">continue</span> walk
</span></span><span style="display:flex;"><span>						}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>						<span style="color:#999;font-style:italic">// æ²¡æœ‰æŸ¥åˆ°åˆ°å¯¹åº”åˆ°è·¯ç”±å¤„ç†å‡½æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>						<span style="color:#999;font-style:italic">// ç›´æ¥è¿”å›
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>						tsr = (<span style="color:#24909d">len</span>(path) == end+<span style="color:#3677a9">1</span>)
</span></span><span style="display:flex;"><span>						<span style="color:#6ab825;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>					
</span></span><span style="display:flex;"><span>					<span style="color:#6ab825;font-weight:bold">if</span> handle = n.handle; handle != <span style="color:#6ab825;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>                        <span style="color:#999;font-style:italic">// å¦‚æœå½“å‰èŠ‚ç‚¹æœ‰å¯¹åº”åˆ°è·¯ç”±å¤„ç†å‡½æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>                        <span style="color:#999;font-style:italic">// ç›´æ¥è¿”å›
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>						<span style="color:#6ab825;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>					} <span style="color:#6ab825;font-weight:bold">else</span> <span style="color:#6ab825;font-weight:bold">if</span> <span style="color:#24909d">len</span>(n.children) == <span style="color:#3677a9">1</span> {
</span></span><span style="display:flex;"><span>						<span style="color:#999;font-style:italic">// å¦‚æœå½“å‰èŠ‚ç‚¹æ²¡æœ‰å¯¹åº”åˆ°è·¯ç”±å¤„ç†å‡½æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>						<span style="color:#999;font-style:italic">// ç¡®è®¤å…¶å­èŠ‚ç‚¹æ˜¯å¦ä¸º &#39;/&#39; å¹¶ä¸”å­èŠ‚ç‚¹æœ‰å¯¹åº”åˆ°è·¯ç”±å¤„ç†å‡½æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>						<span style="color:#999;font-style:italic">// è¿™æ ·å°±å¯ä»¥è¿›è¡Œè¿›è¡Œé‡å®šå‘äº†
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>						n = n.children[<span style="color:#3677a9">0</span>]
</span></span><span style="display:flex;"><span>						tsr = (n.path == <span style="color:#ed9d13">&#34;/&#34;</span> &amp;&amp; n.handle != <span style="color:#6ab825;font-weight:bold">nil</span>)
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>					<span style="color:#6ab825;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>					
</span></span><span style="display:flex;"><span>                <span style="color:#999;font-style:italic">// å¦‚æœå½“å‰èŠ‚ç‚¹ç±»å‹æ˜¯é€šé…ç¬¦èŠ‚ç‚¹
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>				<span style="color:#999;font-style:italic">// é€šé…ç¬¦ (ç±»ä¼¼è¿™ç§å½¢å¼ *logs)
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>				<span style="color:#6ab825;font-weight:bold">case</span> catchAll:
</span></span><span style="display:flex;"><span>					<span style="color:#6ab825;font-weight:bold">if</span> p == <span style="color:#6ab825;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>                        <span style="color:#999;font-style:italic">// æƒ°æ€§åˆå§‹åŒ–å‚æ•°è¿”å›å€¼
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>                        <span style="color:#999;font-style:italic">// æ³¨æ„åˆå§‹åŒ–çš„æ—¶å€™å·²ç»æŒ‡å®šäº†åˆ‡ç‰‡å®¹é‡
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>						p = <span style="color:#24909d">make</span>(Params, <span style="color:#3677a9">0</span>, n.maxParams)
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>					
</span></span><span style="display:flex;"><span>					<span style="color:#999;font-style:italic">// é€šé…ç¬¦ä¸ä¼šæœ‰å­èŠ‚ç‚¹ï¼Œç›´æ¥èµ‹å€¼åè¿”å›å³å¯
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>					<span style="color:#999;font-style:italic">// ä¸ºå‚æ•°è¿”å›å€¼èµ‹å€¼
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>					i := <span style="color:#24909d">len</span>(p)
</span></span><span style="display:flex;"><span>					p = p[:i+<span style="color:#3677a9">1</span>]
</span></span><span style="display:flex;"><span>					p[i].Key = n.path[<span style="color:#3677a9">2</span>:]
</span></span><span style="display:flex;"><span>					p[i].Value = path
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>					handle = n.handle
</span></span><span style="display:flex;"><span>					<span style="color:#6ab825;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				<span style="color:#6ab825;font-weight:bold">default</span>:
</span></span><span style="display:flex;"><span>					<span style="color:#999;font-style:italic">// ä»£ç æ‰§è¡Œåˆ°è¿™é‡Œ
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>					<span style="color:#999;font-style:italic">// è¯´æ˜å½“å‰èŠ‚ç‚¹çš„ç±»å‹ä¸åœ¨æšä¸¾èŒƒå›´å†…ï¼Œç›´æ¥ panic
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>					<span style="color:#24909d">panic</span>(<span style="color:#ed9d13">&#34;invalid node type&#34;</span>)
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		} <span style="color:#6ab825;font-weight:bold">else</span> <span style="color:#6ab825;font-weight:bold">if</span> path == n.path {
</span></span><span style="display:flex;"><span>			<span style="color:#999;font-style:italic">// å¦‚æœè¦æŸ¥æ‰¾çš„ path ç­‰äºå½“å‰èŠ‚ç‚¹çš„ path
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>			<span style="color:#999;font-style:italic">// æ£€æµ‹å½“å‰èŠ‚ç‚¹æ˜¯å¦æœ‰è·¯ç”±å¤„ç†å‡½æ•°ï¼Œå¦‚æœæœ‰çš„è¯ï¼Œç›´æ¥è¿”å›å³å¯
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>			<span style="color:#6ab825;font-weight:bold">if</span> handle = n.handle; handle != <span style="color:#6ab825;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#6ab825;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#999;font-style:italic">// å¦‚æœè¦æŸ¥æ‰¾çš„ path ç­‰äº / å¹¶ä¸”å½“å‰èŠ‚ç‚¹ç±»å‹ä¸æ˜¯ root, å¹¶ä¸”å½“å‰èŠ‚ç‚¹æ˜¯å‚æ•°èŠ‚ç‚¹
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>			<span style="color:#999;font-style:italic">// å…è®¸é‡å®šå‘
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>			<span style="color:#6ab825;font-weight:bold">if</span> path == <span style="color:#ed9d13">&#34;/&#34;</span> &amp;&amp; n.wildChild &amp;&amp; n.nType != root {
</span></span><span style="display:flex;"><span>				tsr = <span style="color:#6ab825;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>				<span style="color:#6ab825;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#999;font-style:italic">// å½“å‰èŠ‚ç‚¹æ²¡æœ‰è·¯ç”±å¤„ç†å‡½æ•°ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªå­èŠ‚ç‚¹çš„è·¯å¾„ä¸º &#39;/&#39;, è¿™æ—¶å…è®¸é‡å®šå‘
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>			<span style="color:#999;font-style:italic">// (ä¾‹å¦‚å½“å‰èŠ‚ç‚¹çš„ path = /users/, ä½†æ˜¯æŸ¥æ‰¾çš„ path = /users, æ­¤æ—¶å°±å…è®¸é‡å®šå‘åˆ° /users/ ä¸Šé¢)
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>			<span style="color:#6ab825;font-weight:bold">for</span> i := <span style="color:#3677a9">0</span>; i &lt; <span style="color:#24909d">len</span>(n.indices); i++ {
</span></span><span style="display:flex;"><span>				<span style="color:#6ab825;font-weight:bold">if</span> n.indices[i] == <span style="color:#ed9d13">&#39;/&#39;</span> {
</span></span><span style="display:flex;"><span>					n = n.children[i]
</span></span><span style="display:flex;"><span>					tsr = (<span style="color:#24909d">len</span>(n.path) == <span style="color:#3677a9">1</span> &amp;&amp; n.handle != <span style="color:#6ab825;font-weight:bold">nil</span>) ||
</span></span><span style="display:flex;"><span>						(n.nType == catchAll &amp;&amp; n.children[<span style="color:#3677a9">0</span>].handle != <span style="color:#6ab825;font-weight:bold">nil</span>)
</span></span><span style="display:flex;"><span>					<span style="color:#6ab825;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#6ab825;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#999;font-style:italic">// æ²¡æœ‰æŸ¥åˆ°åˆ°å¯¹åº”åˆ°è·¯ç”±å¤„ç†å‡½æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>		<span style="color:#999;font-style:italic">// æ ¹æ®æ¡ä»¶æ›´æ–°æ˜¯å¦å…è®¸é‡å®šå‘å­—æ®µ
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>		tsr = (path == <span style="color:#ed9d13">&#34;/&#34;</span>) ||
</span></span><span style="display:flex;"><span>			(<span style="color:#24909d">len</span>(n.path) == <span style="color:#24909d">len</span>(path)+<span style="color:#3677a9">1</span> &amp;&amp; n.path[<span style="color:#24909d">len</span>(path)] == <span style="color:#ed9d13">&#39;/&#39;</span> &amp;&amp;
</span></span><span style="display:flex;"><span>				path == n.path[:<span style="color:#24909d">len</span>(n.path)-<span style="color:#3677a9">1</span>] &amp;&amp; n.handle != <span style="color:#6ab825;font-weight:bold">nil</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#6ab825;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="è·¯ç”±ç®¡ç†å®ç°">è·¯ç”±ç®¡ç†å®ç°</h3>
<p>ç›¸æ¯”äºä¸Šé¢ Radix Tree çš„å®ç°ï¼Œè·¯ç”±ç®¡ç†åŠŸèƒ½å®ç°è¦ç®€å•çš„å¤šï¼Œè¿™é‡Œåˆ†æä¸€ä¸‹æ ¸å¿ƒçš„ä»£ç ã€‚</p>
<h4 id="router-å¯¹è±¡">Router å¯¹è±¡</h4>
<p>Router å¯¹è±¡è¡¨ç¤ºå…¨å±€çš„è·¯ç”±ç®¡ç†å¯¹è±¡ï¼Œå¯ä»¥å°†ä¸åŒçš„ HTTP Method + Path è¯·æ±‚åˆ†å‘ç»™ä¸åŒçš„è·¯ç”±å¤„ç†å‡½æ•°ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">type</span> Router <span style="color:#6ab825;font-weight:bold">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#999;font-style:italic">// è·¯ç”±ç®¡ç†çš„æ ¸å¿ƒå­—æ®µï¼Œæ¯ä¸ª HTTP Method å¯¹åº”ä¸€ä¸ª Radix Tree ç»“æ„
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	<span style="color:#999;font-style:italic">// ä¾‹å¦‚
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	<span style="color:#999;font-style:italic">//   GET =&gt; Radix Tree
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	<span style="color:#999;font-style:italic">//   POST =&gt; Radix Tree
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	<span style="color:#999;font-style:italic">//   DELETE =&gt; Radix Tree
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	<span style="color:#999;font-style:italic">//   ...
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	trees <span style="color:#6ab825;font-weight:bold">map</span>[<span style="color:#6ab825;font-weight:bold">string</span>]*node
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#999;font-style:italic">// æ˜¯å¦å¯ç”¨è¯·æ±‚çš„è‡ªåŠ¨é‡å®šå‘
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	<span style="color:#999;font-style:italic">// (ä¾‹å¦‚å½“å‰è¯·æ±‚ä¸º /foo/, ä½†æ˜¯è·¯ç”±ç®¡ç†æ³¨å†Œçš„è·¯å¾„åªæœ‰ /foo, æ­¤æ—¶å°±å°† /foo/ é‡å®šå‘åˆ° /fooo)
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	<span style="color:#999;font-style:italic">// (é‡å®šå‘æ—¶ï¼ŒGET è¯·æ±‚çš„å“åº”ç ä¸º 301ï¼Œ å…¶ä»–è¯·æ±‚çš„ä¸º 307)
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	RedirectTrailingSlash <span style="color:#6ab825;font-weight:bold">bool</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#999;font-style:italic">// æ˜¯å¦å¯ç”¨è‡ªåŠ¨ä¿®å¤è·¯å¾„
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	<span style="color:#999;font-style:italic">// é¦–å…ˆä¼šåˆ é™¤è·¯å¾„ä¸­å¤šä½™çš„éƒ¨åˆ†ï¼Œä¾‹å¦‚ ../ å’Œ //
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	<span style="color:#999;font-style:italic">// ç„¶åå†æ¬¡æŸ¥æ‰¾è·¯å¾„ (è¿™ä¸€æ¬¡ä¸åŒºåˆ†å¤§å°å†™)ï¼Œçœ‹æ˜¯å¦å¯ä»¥åŒ¹é…åˆ°å¯¹åº”çš„è·¯å¾„å¤„ç†æ–¹æ³•
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	<span style="color:#999;font-style:italic">// å¦‚æœèƒ½åŒ¹é…åˆ°è·¯å¾„ï¼Œå°±è¿›è¡Œé‡å®šå‘
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	<span style="color:#999;font-style:italic">// (é‡å®šå‘æ—¶ï¼ŒGET è¯·æ±‚çš„å“åº”ç ä¸º 301ï¼Œ å…¶ä»–è¯·æ±‚çš„ä¸º 307)
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>    RedirectFixedPath <span style="color:#6ab825;font-weight:bold">bool</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>	<span style="color:#999;font-style:italic">// æ˜¯å¦å¯ç”¨ Method Not Allowed
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	<span style="color:#999;font-style:italic">// å¯ç”¨æœºåˆ¶åï¼Œå¦‚æœå½“å‰è·¯å¾„æ²¡æœ‰åŒ¹é…åˆ°å¯¹åº”çš„è·¯å¾„å¤„ç†æ–¹æ³•
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	<span style="color:#999;font-style:italic">//   æŸ¥çœ‹å…¶ä»–å½“å‰è·¯å¾„æ˜¯å¦æ³¨å†Œäº†å…¶ä»– HTTP è¯·æ±‚ç±»å‹çš„è·¯å¾„å¤„ç†æ–¹æ³•
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	<span style="color:#999;font-style:italic">//   å¦‚æœæ³¨å†Œäº†ï¼Œè¿”å› 405 çŠ¶æ€ç 
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	<span style="color:#999;font-style:italic">// å¦‚æœæ²¡æœ‰å¼€å¯æœºåˆ¶ï¼Œå½“å‰è·¯å¾„æ²¡æœ‰åŒ¹é…åˆ°å¯¹åº”çš„è·¯å¾„å¤„ç†æ–¹æ³•
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	<span style="color:#999;font-style:italic">//   è¿”å› 404 çŠ¶æ€ç 
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>    HandleMethodNotAllowed <span style="color:#6ab825;font-weight:bold">bool</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>	<span style="color:#999;font-style:italic">// æ˜¯å¦å¯ç”¨ OPTIONS è¯·æ±‚å“åº”
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>    HandleOPTIONS <span style="color:#6ab825;font-weight:bold">bool</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#999;font-style:italic">// 404 å“åº”æ–¹æ³•
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	<span style="color:#999;font-style:italic">// å¦‚æœæ²¡æœ‰è®¾ç½®ï¼Œå°±ä½¿ç”¨æ ‡å‡†åº“çš„ 404 æ–¹æ³•
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>    NotFound http.Handler
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#999;font-style:italic">// 405 å“åº”æ–¹æ³•
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	<span style="color:#999;font-style:italic">// å¦‚æœæ²¡æœ‰è®¾ç½®ï¼Œå°±ä½¿ç”¨æ ‡å‡†åº“çš„ Error æ–¹æ³•
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	<span style="color:#999;font-style:italic">//   å…¶ä¸­å“åº”æ–‡æœ¬ä¸º Method Not Allowedï¼ŒçŠ¶æ€ç ä¸º 405
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>    MethodNotAllowed http.Handler
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#999;font-style:italic">// ç”¨äºæ•è·å¹¶å¤„ç† panic é”™è¯¯çš„æ–¹æ³•ï¼Œè¿”å›é”™è¯¯ç  500 (Internal Server Error)
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	<span style="color:#999;font-style:italic">// ä¿è¯ç¨‹åºå› ä¸ºæ²¡æœ‰æ•è· panic è€Œå´©æºƒé€€å‡º
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>    PanicHandler <span style="color:#6ab825;font-weight:bold">func</span>(http.ResponseWriter, *http.Request, <span style="color:#6ab825;font-weight:bold">interface</span>{})
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic">// é€šè¿‡ç¼–è¯‘æœŸé—´ä¿è¯ Router å¿…é¡»å®ç° http.Handler æ¥å£
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span><span style="color:#6ab825;font-weight:bold">var</span> _ http.Handler = <span style="color:#447fcf">New</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic">// åˆ›å»ºå¹¶è¿”å›ä¸€ä¸ªè·¯ç”±ç®¡ç†å®ä¾‹
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span><span style="color:#6ab825;font-weight:bold">func</span> <span style="color:#447fcf">New</span>() *Router {
</span></span><span style="display:flex;"><span>	<span style="color:#6ab825;font-weight:bold">return</span> &amp;Router{
</span></span><span style="display:flex;"><span>		RedirectTrailingSlash:  <span style="color:#6ab825;font-weight:bold">true</span>,
</span></span><span style="display:flex;"><span>		RedirectFixedPath:      <span style="color:#6ab825;font-weight:bold">true</span>,
</span></span><span style="display:flex;"><span>		HandleMethodNotAllowed: <span style="color:#6ab825;font-weight:bold">true</span>,
</span></span><span style="display:flex;"><span>		HandleOPTIONS:          <span style="color:#6ab825;font-weight:bold">true</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="æ³¨å†Œè·¯ç”±å¤„ç†æ–¹æ³•">æ³¨å†Œè·¯ç”±å¤„ç†æ–¹æ³•</h4>
<p>Router æä¾›äº†å¸¸è§çš„ HTTP è¯·æ±‚è·¯ç”±å¤„ç†æ–¹æ³•æ³¨å†Œçš„ API, æ¯ä¸ªæ–¹æ³•çš„å†…éƒ¨éƒ½æ˜¯è°ƒç”¨äº† Handle æ–¹æ³•ï¼Œä¸‹é¢æ˜¯ GET æ–¹æ³•å’Œ POST æ–¹æ³•çš„å®ç°ä»£ç ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#999;font-style:italic">// æ³¨å†Œ GET è¯·æ±‚å¤„ç†æ–¹æ³•
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span><span style="color:#6ab825;font-weight:bold">func</span> (r *Router) <span style="color:#447fcf">GET</span>(path <span style="color:#6ab825;font-weight:bold">string</span>, handle Handle) {
</span></span><span style="display:flex;"><span>	r.<span style="color:#447fcf">Handle</span>(http.MethodGet, path, handle)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic">// æ³¨å†Œ POST è¯·æ±‚å¤„ç†æ–¹æ³•
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span><span style="color:#6ab825;font-weight:bold">func</span> (r *Router) <span style="color:#447fcf">POST</span>(path <span style="color:#6ab825;font-weight:bold">string</span>, handle Handle) {
</span></span><span style="display:flex;"><span>    r.<span style="color:#447fcf">Handle</span>(http.MethodPost, path, handle)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>Handle æ–¹æ³•å°†æŒ‡å®šçš„ HTTP Method + Path å’Œè·¯ç”±å¤„ç†æ–¹æ³•è¿›è¡Œç»‘å®šã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">func</span> (r *Router) <span style="color:#447fcf">Handle</span>(method, path <span style="color:#6ab825;font-weight:bold">string</span>, handle Handle) {
</span></span><span style="display:flex;"><span>	<span style="color:#6ab825;font-weight:bold">if</span> <span style="color:#24909d">len</span>(path) &lt; <span style="color:#3677a9">1</span> || path[<span style="color:#3677a9">0</span>] != <span style="color:#ed9d13">&#39;/&#39;</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#999;font-style:italic">// å¦‚æœè·¯å¾„ä¸ºç©ºæˆ–è€…è·¯å¾„ç¬¬ä¸€ä¸ªå­—ç¬¦ä¸ç­‰äº &#39;/&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>		<span style="color:#999;font-style:italic">// è¿™ç§è·¯å¾„æ ¼å¼å°±æ˜¯ä¸åˆæ³•çš„ï¼Œç›´æ¥ panic
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>		<span style="color:#24909d">panic</span>(<span style="color:#ed9d13">&#34;path must begin with &#39;/&#39; in path &#39;&#34;</span> + path + <span style="color:#ed9d13">&#34;&#39;&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6ab825;font-weight:bold">if</span> r.trees == <span style="color:#6ab825;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#999;font-style:italic">// åˆå§‹åŒ– trees å­—æ®µ
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>		r.trees = <span style="color:#24909d">make</span>(<span style="color:#6ab825;font-weight:bold">map</span>[<span style="color:#6ab825;font-weight:bold">string</span>]*node)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	root := r.trees[method]
</span></span><span style="display:flex;"><span>	<span style="color:#6ab825;font-weight:bold">if</span> root == <span style="color:#6ab825;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#999;font-style:italic">// åˆå§‹åŒ–å‚æ•° HTTP æ–¹æ³•å¯¹åº”çš„ Radix Tree ç»“æ„
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>		root = <span style="color:#24909d">new</span>(node)
</span></span><span style="display:flex;"><span>		r.trees[method] = root
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		r.globalAllowed = r.<span style="color:#447fcf">allowed</span>(<span style="color:#ed9d13">&#34;*&#34;</span>, <span style="color:#ed9d13">&#34;&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#999;font-style:italic">// æ·»åŠ è·¯ç”±çš„æ³¨å†Œæ–¹æ³•
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	<span style="color:#999;font-style:italic">// è¯¦æƒ…è§å‰æ–‡å¯¹äº addRoute æ–¹æ³•çš„æ³¨è§£
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	root.<span style="color:#447fcf">addRoute</span>(path, handle)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="servehttp-å®ç°">ServeHTTP å®ç°</h4>
<p>ServeHTTP æ–¹æ³•è´Ÿè´£å¤„ç† HTTP è¯·æ±‚å¹¶è¿”å›å“åº”ï¼ŒåŒæ—¶å®ç°äº†æ ‡å‡†åº“ä¸­çš„ http.Handler æ¥å£ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#999;font-style:italic">// net/http/server.go
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span><span style="color:#6ab825;font-weight:bold">type</span> Handler <span style="color:#6ab825;font-weight:bold">interface</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#447fcf">ServeHTTP</span>(ResponseWriter, *Request)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">func</span> (r *Router) <span style="color:#447fcf">ServeHTTP</span>(w http.ResponseWriter, req *http.Request) {
</span></span><span style="display:flex;"><span>	<span style="color:#6ab825;font-weight:bold">if</span> r.PanicHandler != <span style="color:#6ab825;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#999;font-style:italic">// å°† panic é”™è¯¯å¤„ç†å‡½æ•°æ³¨å†Œåˆ° defer å‡½æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>		<span style="color:#6ab825;font-weight:bold">defer</span> r.<span style="color:#447fcf">recv</span>(w, req)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#999;font-style:italic">// è·å–å½“å‰è¯·æ±‚è·¯å¾„ 
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	path := req.URL.Path
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#999;font-style:italic">// æ£€æµ‹å½“å‰è¯·æ±‚æ–¹æ³•æ˜¯å¦å­˜åœ¨å¯¹åº”çš„ Radix Tree ç»“æ„
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	<span style="color:#6ab825;font-weight:bold">if</span> root := r.trees[req.Method]; root != <span style="color:#6ab825;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#6ab825;font-weight:bold">if</span> handle, ps, tsr := root.<span style="color:#447fcf">getValue</span>(path); handle != <span style="color:#6ab825;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#999;font-style:italic">// å¦‚æœå½“å‰è¯·æ±‚è·¯å¾„æœ‰å¯¹åº”çš„å¤„ç†æ–¹æ³•ï¼Œç›´æ¥è°ƒç”¨å³å¯
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>			<span style="color:#447fcf">handle</span>(w, req, ps)
</span></span><span style="display:flex;"><span>			<span style="color:#6ab825;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>		} <span style="color:#6ab825;font-weight:bold">else</span> <span style="color:#6ab825;font-weight:bold">if</span> req.Method != http.MethodConnect &amp;&amp; path != <span style="color:#ed9d13">&#34;/&#34;</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#999;font-style:italic">// PS: ä¸Šé¢çš„ if æ¡ä»¶åˆ†æ”¯éƒ½å·²ç»ç›´æ¥è¿”å›äº†
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>			<span style="color:#999;font-style:italic">//     è¿™é‡Œå®åœ¨æ²¡å¿…è¦å†å†™ä¸€ä¸ª else æ¡ä»¶åˆ†æ”¯
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>			<span style="color:#999;font-style:italic">//     æ•´ä¸ªåº“çš„ä»£ç ï¼Œå¯è¯»æ€§æ¯”è¾ƒä½ ï½
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>			
</span></span><span style="display:flex;"><span>			<span style="color:#999;font-style:italic">// å¦‚æœå½“å‰è¯·æ±‚è·¯å¾„æ²¡æœ‰å¯¹åº”çš„å¤„ç†æ–¹æ³•
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>			<span style="color:#999;font-style:italic">// å°†å“åº”çŠ¶æ€ç è®¾ç½®ä¸º 301 (æ°¸ä¹…é‡å®šå‘ï¼Œé’ˆå¯¹ GET æ–¹æ³•)
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>			code := <span style="color:#3677a9">301</span> 
</span></span><span style="display:flex;"><span>			<span style="color:#6ab825;font-weight:bold">if</span> req.Method != http.MethodGet {
</span></span><span style="display:flex;"><span>				<span style="color:#999;font-style:italic">// å¦‚æœå½“å‰è¯·æ±‚ä¸æ˜¯ GET æ–¹æ³•
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>				<span style="color:#999;font-style:italic">// å°†å“åº”çŠ¶æ€ç è®¾ç½®ä¸º 307 (ä¸´æ­»é‡å®šå‘ï¼Œé’ˆå¯¹é GET æ–¹æ³•)
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>				<span style="color:#999;font-style:italic">// ä¸ºä»€ä¹ˆä¸ä½¿ç”¨ 301 å‘¢ï¼Ÿ
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>				<span style="color:#999;font-style:italic">// å› ä¸º 308 å’Œ 307 ä¸å…è®¸è¯·æ±‚ä» POST ä¿®æ”¹ä¸º GET
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>				
</span></span><span style="display:flex;"><span>				<span style="color:#999;font-style:italic">// Temporary redirect, request with same method
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>				<span style="color:#999;font-style:italic">// As of Go 1.3, Go does not support status code 308.
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>				code = <span style="color:#3677a9">307</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#999;font-style:italic">// å¦‚æœè¯·æ±‚è·¯å¾„éœ€è¦é‡å®šå‘å¹¶ä¸”è·¯ç”±æ”¯æŒé‡å®šå‘
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>			<span style="color:#6ab825;font-weight:bold">if</span> tsr &amp;&amp; r.RedirectTrailingSlash {
</span></span><span style="display:flex;"><span>				<span style="color:#999;font-style:italic">// å¦‚æœè·¯å¾„çš„é•¿åº¦å¤§äº 1 å¹¶ä¸”è·¯å¾„æ˜¯ä»¥ &#39;/&#39; å­—ç¬¦ç»“å°¾çš„
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>				<span style="color:#999;font-style:italic">// å°±å°†æœ«å°¾çš„ &#39;/&#39; å­—ç¬¦åˆ é™¤
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>				<span style="color:#6ab825;font-weight:bold">if</span> <span style="color:#24909d">len</span>(path) &gt; <span style="color:#3677a9">1</span> &amp;&amp; path[<span style="color:#24909d">len</span>(path)-<span style="color:#3677a9">1</span>] == <span style="color:#ed9d13">&#39;/&#39;</span> {
</span></span><span style="display:flex;"><span>					req.URL.Path = path[:<span style="color:#24909d">len</span>(path)-<span style="color:#3677a9">1</span>]
</span></span><span style="display:flex;"><span>				} <span style="color:#6ab825;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>					<span style="color:#999;font-style:italic">// åœ¨è·¯å¾„çš„ç»“å°¾åŠ ä¸€ä¸ª &#39;/&#39; å­—ç¬¦
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>					req.URL.Path = path + <span style="color:#ed9d13">&#34;/&#34;</span>
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				<span style="color:#999;font-style:italic">// è¿”å›é‡å®šå‘å“åº”
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>				http.<span style="color:#447fcf">Redirect</span>(w, req, req.URL.<span style="color:#447fcf">String</span>(), code)
</span></span><span style="display:flex;"><span>				<span style="color:#6ab825;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#999;font-style:italic">// å¦‚æœå½“å‰è¯·æ±‚è·¯å¾„æ²¡æœ‰å¯¹åº”çš„å¤„ç†æ–¹æ³• å¹¶ä¸” ä¹Ÿæ²¡æœ‰ç¬¦åˆè§„åˆ™çš„é‡å®šå‘æ¡ä»¶
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>			<span style="color:#999;font-style:italic">// å°è¯•ä¿®å¤è¯·æ±‚è·¯å¾„
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>			<span style="color:#6ab825;font-weight:bold">if</span> r.RedirectFixedPath {
</span></span><span style="display:flex;"><span>				<span style="color:#999;font-style:italic">// å»é™¤è·¯å¾„ä¸­çš„å¤šä½™éƒ¨åˆ†å¹¶è¿”å›ç»è¿‡ä¿®æ­£åæ˜¯å¦æœ‰åŒ¹é…çš„è·¯å¾„
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>				fixedPath, found := root.<span style="color:#447fcf">findCaseInsensitivePath</span>(
</span></span><span style="display:flex;"><span>					<span style="color:#447fcf">CleanPath</span>(path),
</span></span><span style="display:flex;"><span>					r.RedirectTrailingSlash,
</span></span><span style="display:flex;"><span>				)
</span></span><span style="display:flex;"><span>				<span style="color:#6ab825;font-weight:bold">if</span> found {
</span></span><span style="display:flex;"><span>					<span style="color:#999;font-style:italic">// å¦‚æœç»è¿‡ä¿®æ­£ï¼Œå¯ä»¥æ‰¾åˆ°åŒ¹é…çš„è·¯å¾„
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>					<span style="color:#999;font-style:italic">// ç›´æ¥é‡å®šå‘
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>					req.URL.Path = <span style="color:#24909d">string</span>(fixedPath)
</span></span><span style="display:flex;"><span>					http.<span style="color:#447fcf">Redirect</span>(w, req, req.URL.<span style="color:#447fcf">String</span>(), code)
</span></span><span style="display:flex;"><span>					<span style="color:#6ab825;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#999;font-style:italic">// ä»£ç æ‰§è¡Œåˆ°äº†è¿™é‡Œ
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	<span style="color:#999;font-style:italic">// è¯´æ˜ä¸Šé¢çš„å‡ ä¸ªæ¡ä»¶éƒ½ä¸ç¬¦åˆï¼Œå½“å‰è¯·æ±‚è·¯å¾„è¿˜æ˜¯æ²¡æœ‰æ‰¾åˆ°å¯¹åº”çš„å¤„ç†æ–¹æ³•
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>	<span style="color:#6ab825;font-weight:bold">if</span> req.Method == http.MethodOptions &amp;&amp; r.HandleOPTIONS {
</span></span><span style="display:flex;"><span>		<span style="color:#999;font-style:italic">// å¦‚æœè¯·æ±‚æ–¹æ³•æ˜¯ OPTIONS, å¹¶ä¸”è·¯ç”±ç®¡ç†å…è®¸å“åº” OPTIONS
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>		<span style="color:#999;font-style:italic">// è¿”å›ä¸€ä¸ª OPTIONS å“åº”
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>		<span style="color:#6ab825;font-weight:bold">if</span> allow := r.<span style="color:#447fcf">allowed</span>(path, http.MethodOptions); allow != <span style="color:#ed9d13">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>			w.<span style="color:#447fcf">Header</span>().<span style="color:#447fcf">Set</span>(<span style="color:#ed9d13">&#34;Allow&#34;</span>, allow)
</span></span><span style="display:flex;"><span>			<span style="color:#6ab825;font-weight:bold">if</span> r.GlobalOPTIONS != <span style="color:#6ab825;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>				r.GlobalOPTIONS.<span style="color:#447fcf">ServeHTTP</span>(w, req)
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#6ab825;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	} <span style="color:#6ab825;font-weight:bold">else</span> <span style="color:#6ab825;font-weight:bold">if</span> r.HandleMethodNotAllowed { 
</span></span><span style="display:flex;"><span>		<span style="color:#999;font-style:italic">// å¦‚æœè¯·æ±‚æ–¹æ³•ä¸æ˜¯ OPTIONS, æˆ–è€…è·¯ç”±ç®¡ç†ä¸å…è®¸å“åº” OPTIONS
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>		<span style="color:#999;font-style:italic">// è¿”å›ä¸€ä¸ª 405 å“åº”
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>		<span style="color:#6ab825;font-weight:bold">if</span> allow := r.<span style="color:#447fcf">allowed</span>(path, req.Method); allow != <span style="color:#ed9d13">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>			w.<span style="color:#447fcf">Header</span>().<span style="color:#447fcf">Set</span>(<span style="color:#ed9d13">&#34;Allow&#34;</span>, allow)
</span></span><span style="display:flex;"><span>			<span style="color:#6ab825;font-weight:bold">if</span> r.MethodNotAllowed != <span style="color:#6ab825;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>				r.MethodNotAllowed.<span style="color:#447fcf">ServeHTTP</span>(w, req)
</span></span><span style="display:flex;"><span>			} <span style="color:#6ab825;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>				http.<span style="color:#447fcf">Error</span>(w,
</span></span><span style="display:flex;"><span>					http.<span style="color:#447fcf">StatusText</span>(http.StatusMethodNotAllowed),
</span></span><span style="display:flex;"><span>					http.StatusMethodNotAllowed,
</span></span><span style="display:flex;"><span>				)
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#6ab825;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6ab825;font-weight:bold">if</span> r.NotFound != <span style="color:#6ab825;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#999;font-style:italic">// å¦‚æœè·¯ç”±ç®¡ç†ä¸­æ³¨å†Œäº† 404 å¤„ç†å‡½æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>		<span style="color:#999;font-style:italic">// ç›´æ¥è°ƒç”¨
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>		r.NotFound.<span style="color:#447fcf">ServeHTTP</span>(w, req)
</span></span><span style="display:flex;"><span>	} <span style="color:#6ab825;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#999;font-style:italic">// å¦‚æœè·¯ç”±ç®¡ç†ä¸­æ²¡æœ‰æ³¨å†Œ 404 å¤„ç†æ–¹æ³•
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>		<span style="color:#999;font-style:italic">// è°ƒç”¨æ ‡å‡†åº“ä¸­çš„ 404 å¤„ç†æ–¹æ³•
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-style:italic"></span>		http.<span style="color:#447fcf">NotFound</span>(w, req)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="ä¼˜ç‚¹-1">ä¼˜ç‚¹</h3>
<p>Radix Tree é€šè¿‡åˆå¹¶å…¬å…±å‰ç¼€æ¥é™ä½å­˜å‚¨ç©ºé—´çš„å¼€é”€ï¼Œé¿å…äº† Trie Tree å­—ç¬¦ä¸²è¿‡é•¿å’Œå­—ç¬¦é›†è¿‡å¤§æ—¶å¯¼è‡´çš„å­˜å‚¨ç©ºé—´è¿‡å¤šé—®é¢˜ï¼ŒåŒæ—¶å…¬å…±å‰ç¼€ä¼˜åŒ–äº†è·¯å¾„å±‚æ•°ï¼Œæå‡äº†æ’å…¥ã€æŸ¥è¯¢ã€åˆ é™¤ç­‰æ“ä½œæ•ˆç‡ã€‚</p>
<p>ä½¿ç”¨ Radix Tree å¯ä»¥å‡å°‘æ ‘çš„å±‚é«˜ï¼ŒåŒæ—¶æ¯ä¸ªèŠ‚ç‚¹ä¸Šçš„æ•°æ®å­˜å‚¨é€šå¸¸æ¯” Trie Tree å¤šï¼Œæ‰€ä»¥ç¨‹åºçš„ CPU ç¼“å­˜å±€éƒ¨æ€§è¾ƒå¥½ (ä¸€ä¸ªèŠ‚ç‚¹çš„ path åŠ è½½åˆ° CPU ç¼“å­˜å°±å¯ä»¥è¿›è¡Œå¤šä¸ªå­—ç¬¦çš„æ“ä½œ)ã€‚</p>
<h3 id="é€‚ç”¨åœºæ™¯-1">é€‚ç”¨åœºæ™¯</h3>
<ul>
<li>å­—å…¸å’Œå‰ç¼€åŒ¹é… ï¼šé€‚åˆç”¨ä½œå­—å…¸æˆ–å…³è”æ•°ç»„çš„åº•å±‚æ•°æ®ç»“æ„ï¼Œå¯ä»¥å¿«é€Ÿæ‰¾åˆ°ä»¥ç»™å®šå‰ç¼€å¼€å¤´çš„æ‰€æœ‰é”®ï¼Œä¾‹å¦‚ Redis ä¸­çš„æŸä¸ªå‰ç¼€ key</li>
<li>IP è·¯ç”±è¡¨     ï¼šå¯ä»¥é«˜æ•ˆåœ°å­˜å‚¨å’Œæœç´¢ IP åœ°å€åŠå…¶å¯¹åº”çš„è·¯ç”±è¡¨ä¿¡æ¯</li>
<li>æ–‡ä»¶ç³»ç»Ÿå’Œç›®å½• ï¼šæ¯ä¸ªèŠ‚ç‚¹å¯ä»¥è¡¨ç¤ºä¸€ä¸ªç›®å½•æˆ–æ–‡ä»¶ï¼ŒèŠ‚ç‚¹ä¹‹é—´çš„å…³ç³»é€šè¿‡å…±åŒçš„è·¯å¾„å‰ç¼€è¿›è¡Œè¿æ¥</li>
<li>ç¼–è¯‘å™¨        ï¼šå¯ä»¥ç”¨äºç¼–è¯‘å™¨ä¸­çš„ç¬¦å·è¡¨ç®¡ç†ï¼Œç¬¦å·è¡¨å­˜å‚¨äº†ç¨‹åºä¸­å®šä¹‰çš„å˜é‡ã€å‡½æ•°åå’Œç±»å‹ç­‰ä¿¡æ¯ï¼ŒRadix Tree å¯ä»¥å¿«é€ŸæŸ¥æ‰¾å’Œæ›´æ–°ç¬¦å·è¡¨é¡¹ï¼Œæ”¯æŒé«˜æ•ˆçš„åç§°è§£æå’Œç±»å‹æ£€æŸ¥</li>
</ul>
<h3 id="ä¸é€‚ç”¨åœºæ™¯-1">ä¸é€‚ç”¨åœºæ™¯</h3>
<ul>
<li>å­—ç¬¦ä¸²å…¬å…±å‰ç¼€å¤ªå°‘ï¼Œé€ æˆ Radix Tree èŠ‚ç‚¹ç¨€ç–åˆ†å¸ƒ (é€€åŒ–åˆ° Trie Tree)ï¼Œè¿™æ—¶å“ˆå¸Œè¡¨æ˜¯æ›´å¥½çš„é€‰æ‹© (è¿™ä¸ªé—®é¢˜åœ¨ Trie Tree ä¸­åŒæ ·å­˜åœ¨)</li>
<li>å­—ç¬¦é›†è¿‡å°ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨å…¶ä»–ç®€å•çš„æ•°æ®ç»“æ„</li>
<li>åŠ¨æ€æ•°æ®é›†ï¼Œä¹Ÿå°±æ˜¯æ•°æ®é›†éœ€è¦é¢‘ç¹åœ°è¿›è¡Œæ’å…¥å’Œåˆ é™¤æ“ä½œï¼Œç”±äº Radix Tree çš„èŠ‚ç‚¹éœ€è¦åˆå¹¶å’Œè·¯å¾„é‡ç»„ï¼ŒåŠ¨æ€ä¿®æ”¹æ ‘ç»“æ„å¯èƒ½å¼•èµ·è¾ƒå¤§çš„å¼€é”€ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¿™æ—¶å¹³è¡¡äºŒå‰æœç´¢æ ‘ç»“æ„ï¼ˆAVLæ ‘ã€çº¢é»‘æ ‘ï¼‰æ›´é€‚åˆ</li>
<li>èŠ‚ç‚¹ä¹‹é—´çš„çˆ¶å­èŠ‚ç‚¹ä½¿ç”¨æŒ‡é’ˆè¿æ¥ï¼Œå¯¹ CPU å’Œè‡ªå¸¦ GC è¯­è¨€ä¸å¤ªå‹å¥½ (è¿™ä¸ªé—®é¢˜åœ¨ Trie Tree ä¸­åŒæ ·å­˜åœ¨)</li>
</ul>
<h2 id="trie-tree-å’Œ-radix-tree-å¯¹æ¯”">Trie Tree å’Œ Radix Tree å¯¹æ¯”</h2>
<p>ä¸‹é¢æ˜¯æ’å…¥ 4 ä¸ªå•è¯ [PLAN, PLAY, POLL, POST] åçš„ç»“æœ (ç²—ä½“å­—ç¬¦è¡¨ç¤ºèŠ‚ç‚¹å­—ç¬¦ï¼Œåœ†åœˆå†…å­—ç¬¦ä¸²è¡¨ç¤ºè¯¥èŠ‚ç‚¹è¡¨ç¤ºçš„å€¼)ã€‚</p>
<p><img src="https://dbwu.tech/images/trie_vs_radix.png" alt="å›¾ç‰‡æ¥æº: https://subscription.packtpub.com/"></p>
<h2 id="å°ç»“">å°ç»“</h2>
<p>æœ¬æ–‡ä»å¼€å‘ä¸­å¸¸è§çš„ â€œè·¯ç”±ç®¡ç†â€ åŠŸèƒ½ä¸ºå‡ºå‘ç‚¹ï¼Œæ¢ç´¢äº†å®ç°èƒŒåç”¨åˆ°çš„æ•°æ®ç»“æ„å’Œç®—æ³•ï¼Œå¹¶å…ˆååˆ†æäº†å„è§£å†³æ–¹æ¡ˆçš„ä¼˜åŒ–è¿‡ç¨‹ï¼Œåˆ†åˆ«æ˜¯ Go æ ‡å‡†åº“ã€æ‰‹åŠ¨å®ç° Trie Treeã€å¼€æºçš„ Radix Tree,
å¸Œæœ›è¯»è€…åœ¨è¯»å®Œæ–‡ç« åï¼Œèƒ½å‡†ç¡®åœ°ç†è§£ Trie Tree å’Œ Radix Tree çš„å·®å¼‚åŠå…¶é€‚ç”¨åœºæ™¯ï¼Œå¦‚æœåœ¨æ­¤åŸºç¡€ä¸Šè¿˜æœ‰å…´è¶£å’Œæ—¶é—´ï¼Œå¯ä»¥æ·±å…¥äº†è§£ä¸‹ç”±è¿™ä¸¤ç§æ•°æ®ç»“æ„æ¼”å˜å‡ºçš„å…¶ä»–æ•°æ®ç»“æ„å’Œç®—æ³•ã€‚</p>
<h2 id="reference">Reference</h2>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Radix_tree">Radix tree</a></li>
<li><a href="https://en.wikipedia.org/wiki/Trie">Trie tree</a></li>
<li><a href="https://github.com/julienschmidt/httprouter">httprouter</a></li>
<li><a href="https://github.com/gin-gonic/gin/">gin</a></li>
<li><a href="https://github.com/redis/redis/blob/6.0.14/src/rax.h">Redis Rax</a></li>
<li><a href="https://github.com/antirez/rax">Rax, an ANSI C radix tree implementation</a></li>
</ul>


</article>

<article>
    <img src="https://dbwu.tech/images/wechat.png">
</article>

<article>
    <h3>è½¬è½½ç”³è¯·</h3>

    <p>
        æœ¬ä½œå“é‡‡ç”¨ <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">çŸ¥è¯†å…±äº«ç½²å 4.0 å›½é™…è®¸å¯åè®®</a> è¿›è¡Œè®¸å¯ï¼Œè½¬è½½æ—¶è¯·æ³¨æ˜åŸæ–‡é“¾æ¥ï¼Œå›¾ç‰‡åœ¨ä½¿ç”¨æ—¶è¯·ä¿ç•™å…¨éƒ¨å†…å®¹ï¼Œå•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒã€‚
    </p>
</article>

<section class="post-nav">
    <ul>
        <li>
        
            <a href="https://dbwu.tech/posts/cuckoo_filter/"><i class="fa fa-chevron-circle-left"></i> å¸ƒè°·é¸Ÿè¿‡æ»¤å™¨</a>
        
        </li>
        <li>
        
            <a href="https://dbwu.tech/posts/golang_zap/">zap é«˜æ€§èƒ½è®¾è®¡ä¸å®ç° <i class="fa fa-chevron-circle-right"></i> </a>
        
        </li>
    </ul>
</section>
  
    
    
  


<script src="https://giscus.app/client.js"
        data-repo="duanbiaowu/dbwu.tech"
        data-repo-id="R_kgDOIkkjjw"
        data-category="Announcements"
        data-category-id="DIC_kwDOIkkjj84CV78j"
        data-mapping="specific"
        data-term="HTTP Router ç®—æ³•æ¼”è¿›"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="1"
        data-input-position="top"
        data-theme="light"
        data-lang="zh-CN"
        crossorigin="anonymous" async>
</script>




</main>
    <footer>
        <ul>
            <li>
                <h6><a href="mailto:codean.net@gmail.com">codean.net@gmail.com</a> | 
                    <img src="https://dbwu.tech/images/%E5%A4%87%E6%A1%88%E5%9B%BE%E6%A0%87.png" />
                    <a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=61011302001681" target="_blank">é™•å…¬ç½‘å®‰å¤‡ 61011302001681 å·</a> |
                    <a href="https://beian.miit.gov.cn" target="_blank">é™•ICPå¤‡2023004378å·-1</a> |
                    Rendered by <a href="https://themes.gohugo.io" title="Hugo" target="_blank">Hugo</a>
                </h6>
            </li>
            
            
        </ul>
    </footer>
</div>
<script src="https://dbwu.tech/js/scripts.js"></script>


</body>

</html>

